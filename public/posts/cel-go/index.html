<!DOCTYPE html>
<html lang="zh-cn">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#20293a">
	<meta name="msapplication-TileColor" content="#20293a">
<meta itemprop="name" content="Preliminary Study on CEL-Go">
<meta itemprop="description" content="前言 XRAY很牛逼，但是其并不开源，最近也是想写点东西，就自己也造个轮子，有时间的话就把Thinkphp，structs2，weblogic都整上了。
poc的话当然希望可以直接融合XRAY的poc，采用YAML格式，但有一个问题，比如我们一般用gopkg.in/yaml.v2把YAML解析为结构体，但如果YAML中出现一些表达式，就很难直接用结构体解决。(无脑正则当然ok)
name:poc-yaml-thinkphp5023-method-rcerules:- method:POSTpath:/index.php?s=captchaheaders:Content-Type:application/x-www-form-urlencodedbody:|_method=__construct&amp;filter[]=printf&amp;method=GET&amp;server[REQUEST_METHOD]=TmlnaHQgZ2F0aGVycywgYW5%25%25kIG5vdyBteSB3YXRjaCBiZWdpbnMu&amp;get[]=1expression:|response.status==200&amp;&amp;response.body.bcontains(b&#34;TmlnaHQgZ2F0aGVycywgYW5%kIG5vdyBteSB3YXRjaCBiZWdpbnMu1&#34;)detail:links:- https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce上面的expression其实很好理解，长得比较像python表达式，在python中eval可以直接对表达式求解，而我们现在也就需要一个高效的方法可以自定义求解表达式。
在XRAY-如何编写expression表达式中其实有提到一个库 ==&gt; CEL-Go,官网介绍看了半天说实话不知道在干嘛&hellip;查了查国内这方面的教程也几乎为0，不过好在Google大爹的codelabs实在良心，自己也跟着过一遍，算是入了个门，在这简单记录一下。
Introduction  CEL是为了安全的执行用户代码而设计的一门“语言”，就像用户在Python上盲目调用eval是危险的，但CEL可以安全的执行。
CEL多用于求解表达式，类似single line functions或者lambda表达式，并且通常用于计算bool值，但它也可用于构造更复杂的对象，如JSON或Protobuf。
 Key concepts  Variable bindings Function bindings for any custom extensions An AST to evaluate  Declare the variables cel中数据类型是绑定在protobuf上的，所以我们先简单写一个proto文件
syntax = &#34;proto3&#34;;package celDemo;option go_package = &#34;celDemo/bp&#34;;message Response{ string url = 1; int32 status =2; bytes body = 3;}生成对应go文件 == &gt;protoc --go_out=. celDemo/http.proto
celDemo ├── bp │ └── http.pb.go ├── cel.go ├── cel_test.go └── http."><meta itemprop="datePublished" content="2021-10-26T23:24:32+08:00" />
<meta itemprop="dateModified" content="2021-10-26T23:24:32+08:00" />
<meta itemprop="wordCount" content="337">
<meta itemprop="keywords" content="" /><meta property="og:title" content="Preliminary Study on CEL-Go" />
<meta property="og:description" content="前言 XRAY很牛逼，但是其并不开源，最近也是想写点东西，就自己也造个轮子，有时间的话就把Thinkphp，structs2，weblogic都整上了。
poc的话当然希望可以直接融合XRAY的poc，采用YAML格式，但有一个问题，比如我们一般用gopkg.in/yaml.v2把YAML解析为结构体，但如果YAML中出现一些表达式，就很难直接用结构体解决。(无脑正则当然ok)
name:poc-yaml-thinkphp5023-method-rcerules:- method:POSTpath:/index.php?s=captchaheaders:Content-Type:application/x-www-form-urlencodedbody:|_method=__construct&amp;filter[]=printf&amp;method=GET&amp;server[REQUEST_METHOD]=TmlnaHQgZ2F0aGVycywgYW5%25%25kIG5vdyBteSB3YXRjaCBiZWdpbnMu&amp;get[]=1expression:|response.status==200&amp;&amp;response.body.bcontains(b&#34;TmlnaHQgZ2F0aGVycywgYW5%kIG5vdyBteSB3YXRjaCBiZWdpbnMu1&#34;)detail:links:- https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce上面的expression其实很好理解，长得比较像python表达式，在python中eval可以直接对表达式求解，而我们现在也就需要一个高效的方法可以自定义求解表达式。
在XRAY-如何编写expression表达式中其实有提到一个库 ==&gt; CEL-Go,官网介绍看了半天说实话不知道在干嘛&hellip;查了查国内这方面的教程也几乎为0，不过好在Google大爹的codelabs实在良心，自己也跟着过一遍，算是入了个门，在这简单记录一下。
Introduction  CEL是为了安全的执行用户代码而设计的一门“语言”，就像用户在Python上盲目调用eval是危险的，但CEL可以安全的执行。
CEL多用于求解表达式，类似single line functions或者lambda表达式，并且通常用于计算bool值，但它也可用于构造更复杂的对象，如JSON或Protobuf。
 Key concepts  Variable bindings Function bindings for any custom extensions An AST to evaluate  Declare the variables cel中数据类型是绑定在protobuf上的，所以我们先简单写一个proto文件
syntax = &#34;proto3&#34;;package celDemo;option go_package = &#34;celDemo/bp&#34;;message Response{ string url = 1; int32 status =2; bytes body = 3;}生成对应go文件 == &gt;protoc --go_out=. celDemo/http.proto
celDemo ├── bp │ └── http.pb.go ├── cel.go ├── cel_test.go └── http." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theoyu.top/posts/cel-go/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-26T23:24:32+08:00" />
<meta property="article:modified_time" content="2021-10-26T23:24:32+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Preliminary Study on CEL-Go"/>
<meta name="twitter:description" content="前言 XRAY很牛逼，但是其并不开源，最近也是想写点东西，就自己也造个轮子，有时间的话就把Thinkphp，structs2，weblogic都整上了。
poc的话当然希望可以直接融合XRAY的poc，采用YAML格式，但有一个问题，比如我们一般用gopkg.in/yaml.v2把YAML解析为结构体，但如果YAML中出现一些表达式，就很难直接用结构体解决。(无脑正则当然ok)
name:poc-yaml-thinkphp5023-method-rcerules:- method:POSTpath:/index.php?s=captchaheaders:Content-Type:application/x-www-form-urlencodedbody:|_method=__construct&amp;filter[]=printf&amp;method=GET&amp;server[REQUEST_METHOD]=TmlnaHQgZ2F0aGVycywgYW5%25%25kIG5vdyBteSB3YXRjaCBiZWdpbnMu&amp;get[]=1expression:|response.status==200&amp;&amp;response.body.bcontains(b&#34;TmlnaHQgZ2F0aGVycywgYW5%kIG5vdyBteSB3YXRjaCBiZWdpbnMu1&#34;)detail:links:- https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce上面的expression其实很好理解，长得比较像python表达式，在python中eval可以直接对表达式求解，而我们现在也就需要一个高效的方法可以自定义求解表达式。
在XRAY-如何编写expression表达式中其实有提到一个库 ==&gt; CEL-Go,官网介绍看了半天说实话不知道在干嘛&hellip;查了查国内这方面的教程也几乎为0，不过好在Google大爹的codelabs实在良心，自己也跟着过一遍，算是入了个门，在这简单记录一下。
Introduction  CEL是为了安全的执行用户代码而设计的一门“语言”，就像用户在Python上盲目调用eval是危险的，但CEL可以安全的执行。
CEL多用于求解表达式，类似single line functions或者lambda表达式，并且通常用于计算bool值，但它也可用于构造更复杂的对象，如JSON或Protobuf。
 Key concepts  Variable bindings Function bindings for any custom extensions An AST to evaluate  Declare the variables cel中数据类型是绑定在protobuf上的，所以我们先简单写一个proto文件
syntax = &#34;proto3&#34;;package celDemo;option go_package = &#34;celDemo/bp&#34;;message Response{ string url = 1; int32 status =2; bytes body = 3;}生成对应go文件 == &gt;protoc --go_out=. celDemo/http.proto
celDemo ├── bp │ └── http.pb.go ├── cel.go ├── cel_test.go └── http."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Preliminary Study on CEL-Go</title>
	<link rel="stylesheet" href="https://theoyu.top/css/style.min.948bbb56de2e03535e20f1dcdeada9d463fac9cb3e67a99667928e9208ec6fa8.css" integrity="sha256-lIu7Vt4uA1NeIPHc3q2p1GP6ycs+Z6mWZ5KOkgjsb6g=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://theoyu.top/">Theoyu&#39;s Blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://theoyu.top/posts/">Posts</a>
				<a href="https://theoyu.top/about-me/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="mailto:zeyu.ou@foxmail.com" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="https://instagram.com/" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/yuuuuu422" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://theoyu.top/posts/">Posts</a></li>
			<li><a href="https://theoyu.top/about-me/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Oct 26, 2021</span></div>
				<h1>Preliminary Study on CEL-Go</h1>
			</header>
			<div class="content">
				<h2 id="前言">前言<a href="#前言" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>XRAY很牛逼，但是其并不开源，最近也是想写点东西，就自己也造个轮子，有时间的话就把<strong>Thinkphp，structs2，weblogic</strong>都整上了。</p>
<p>poc的话当然希望可以直接融合XRAY的poc，采用YAML格式，但有一个问题，比如我们一般用<code>gopkg.in/yaml.v2</code>把YAML解析为结构体，但如果YAML中出现一些表达式，就很难直接用结构体解决。(无脑正则当然ok)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">poc-yaml-thinkphp5023-method-rce</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">POST</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/index.php?s=captcha</span><span class="w">
</span><span class="w">    </span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="l">application/x-www-form-urlencoded</span><span class="w">
</span><span class="w">    </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      </span><span class="w">      </span><span class="l">_method=__construct&amp;filter[]=printf&amp;method=GET&amp;server[REQUEST_METHOD]=TmlnaHQgZ2F0aGVycywgYW5%25%25kIG5vdyBteSB3YXRjaCBiZWdpbnMu&amp;get[]=1</span><span class="w">
</span><span class="w">    </span><span class="nt">expression</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      </span><span class="w">      </span><span class="l">response.status==200&amp;&amp;response.body.bcontains(b&#34;TmlnaHQgZ2F0aGVycywgYW5%kIG5vdyBteSB3YXRjaCBiZWdpbnMu1&#34;)</span><span class="w">
</span><span class="w"></span><span class="nt">detail</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">links</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</span><span class="w">
</span></code></pre></div><p>上面的<code>expression</code>其实很好理解，长得比较像python表达式，在python中eval可以直接对表达式求解，而我们现在也就需要一个高效的方法可以自定义求解表达式。</p>
<p>在<a href="https://docs.xray.cool/#/guide/poc?id=%e5%a6%82%e4%bd%95%e7%bc%96%e5%86%99expression%e8%a1%a8%e8%be%be%e5%bc%8f">XRAY-如何编写expression表达式</a>中其实有提到一个库 ==&gt; <a href="https://github.com/google/cel-go">CEL-Go</a>,官网介绍看了半天说实话不知道在干嘛&hellip;查了查国内这方面的教程也几乎为0，不过好在Google大爹的<a href="https://codelabs.developers.google.com/codelabs/cel-go/#0">codelabs</a>实在良心，自己也跟着过一遍，算是入了个门，在这简单记录一下。</p>
<h2 id="introduction">Introduction<a href="#introduction" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<blockquote>
<p>CEL是为了安全的执行用户代码而设计的一门“语言”，就像用户在Python上盲目调用<code>eval</code>是危险的，但CEL可以安全的执行。</p>
<p>CEL多用于求解表达式，类似single line functions或者lambda表达式，并且通常用于计算bool值，但它也可用于构造更复杂的对象，如JSON或Protobuf。</p>
</blockquote>
<h2 id="key-concepts">Key concepts<a href="#key-concepts" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ul>
<li>Variable bindings</li>
<li>Function bindings for any custom extensions</li>
<li>An AST to evaluate</li>
</ul>
<h2 id="declare-the-variables">Declare the variables<a href="#declare-the-variables" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>cel中数据类型是绑定在protobuf上的，所以我们先简单写一个proto文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">celDemo</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">&#34;celDemo/bp&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Response</span><span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">url</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span> <span class="n">status</span> <span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">bytes</span> <span class="n">body</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><p>生成对应go文件 == &gt;<code>protoc --go_out=. celDemo/http.proto</code></p>
<pre><code>celDemo
├── bp
│   └── http.pb.go
├── cel.go 
├── cel_test.go 
└── http.proto
</code></pre><p>cel是通过env来解析表达式，我们可以通过<code>env, err := cel.NewEnv()</code>创建一个独立的环境。</p>
<blockquote>
<p>NewEnv creates a program environment configured with the standard library of CEL functions and macros. The Env value returned can parse and check any CEL program which builds upon the core features documented in the CEL specification.</p>
</blockquote>
<p>之前提到要想让cel识别这个Response，就需要在创建env时加入我们的options</p>
<blockquote>
<p>The environment can be customized by providing the options cel.EnvOption to the call. Those options are able to disable macros, declare custom variables and functions, etc.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">options</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">envOptions</span>  <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">EnvOption</span>
	<span class="nx">programOptions</span>  <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">ProgramOption</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newEnvOption</span><span class="p">()</span> <span class="o">*</span><span class="nx">options</span><span class="p">{</span>
	<span class="nx">opt</span><span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">{}</span>
	<span class="nx">opt</span><span class="p">.</span><span class="nx">envOptions</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">EnvOption</span><span class="p">{</span>
		<span class="nx">cel</span><span class="p">.</span><span class="nf">Types</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="nx">bp</span><span class="p">.</span><span class="nx">Response</span><span class="p">{}),</span>
		<span class="nx">cel</span><span class="p">.</span><span class="nf">Declarations</span><span class="p">(</span>
			<span class="nx">decls</span><span class="p">.</span><span class="nf">NewVar</span><span class="p">(</span><span class="s">&#34;response&#34;</span><span class="p">,</span>
				<span class="nx">decls</span><span class="p">.</span><span class="nf">NewObjectType</span><span class="p">(</span><span class="s">&#34;celDemo.Response&#34;</span><span class="p">)),</span>
			<span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">opt</span><span class="p">.</span><span class="nx">programOptions</span><span class="p">=</span> <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">ProgramOption</span><span class="p">{}</span>
	<span class="k">return</span> <span class="nx">opt</span>
<span class="p">}</span>
</code></pre></div><p>之后就能直接创建env</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">	<span class="nx">options</span><span class="o">:=</span> <span class="nf">newEnvOption</span><span class="p">()</span>
	<span class="nx">env</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">cel</span><span class="p">.</span><span class="nf">NewEnv</span><span class="p">(</span><span class="nx">cel</span><span class="p">.</span><span class="nf">Lib</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span>

<span class="c1">//注意cel.Lib
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Lib</span><span class="p">(</span><span class="nx">l</span> <span class="nx">Library</span><span class="p">)</span> <span class="nx">EnvOption</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Env</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Env</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nf">CompileOptions</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">opt</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">progOpts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">progOpts</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nf">ProgramOptions</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">e</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">//发现这里调用了l.CompileOptions(),l.ProgramOptions() 所以我们需要写入options的方法中：
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">options</span><span class="p">)</span> <span class="nf">CompileOptions</span><span class="p">()</span> <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">EnvOption</span><span class="p">{</span>
	<span class="k">return</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">envOptions</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">options</span><span class="p">)</span> <span class="nf">ProgramOptions</span><span class="p">()</span> <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">ProgramOption</span><span class="p">{</span>
	<span class="k">return</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">programOptions</span>
<span class="p">}</span>
</code></pre></div><p>简单测试一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">celDemo</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;celDemo/bp&#34;</span>
	<span class="s">&#34;github.com/google/cel-go/cel&#34;</span>
	<span class="s">&#34;testing&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestPoc</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">poc</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{}</span>

	<span class="nx">poc</span><span class="p">[</span><span class="s">&#34;response&#34;</span><span class="p">]=</span> <span class="o">&amp;</span><span class="nx">bp</span><span class="p">.</span><span class="nx">Response</span><span class="p">{</span>
		<span class="nx">Url</span><span class="p">:</span> <span class="s">&#34;theoyu.top&#34;</span><span class="p">,</span>
		<span class="nx">Status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
		<span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;who is theoyu&#34;</span><span class="p">),</span>
	<span class="p">}</span>

	<span class="nx">options</span><span class="o">:=</span> <span class="nf">newEnvOption</span><span class="p">()</span>
	<span class="nx">env</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">cel</span><span class="p">.</span><span class="nf">NewEnv</span><span class="p">(</span><span class="nx">cel</span><span class="p">.</span><span class="nf">Lib</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span>
	<span class="nx">ast</span><span class="p">,</span><span class="nx">iss</span><span class="o">:=</span><span class="nx">env</span><span class="p">.</span><span class="nf">Compile</span><span class="p">(</span><span class="s">&#34;response.status == 200&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">iss</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">iss</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">prg</span><span class="p">,</span><span class="nx">err</span><span class="o">:=</span><span class="nx">env</span><span class="p">.</span><span class="nf">Program</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">out</span><span class="p">,</span><span class="nx">_</span><span class="p">,</span><span class="nx">_</span><span class="o">:=</span><span class="nx">prg</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nx">poc</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="o">==</span><span class="p">=</span> <span class="nx">RUN</span>   <span class="nx">TestPoc</span>
    <span class="nx">cel_test</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span> <span class="kc">true</span>
<span class="o">---</span> <span class="nx">PASS</span><span class="p">:</span> <span class="nf">TestPoc</span> <span class="p">(</span><span class="mf">0.01</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">PASS</span>
</code></pre></div><h2 id="custom-functions">Custom Functions<a href="#custom-functions" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>和变量一样，函数也在<code>EnvOption</code>中定义</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cel</span><span class="p">.</span><span class="nf">Declarations</span><span class="p">(</span>
			<span class="nx">decls</span><span class="p">.</span><span class="nf">NewFunction</span><span class="p">(</span><span class="s">&#34;bcontains&#34;</span><span class="p">,</span><span class="nx">decls</span><span class="p">.</span><span class="nf">NewInstanceOverload</span><span class="p">(</span>
				<span class="s">&#34;bytes_contains_bytes&#34;</span><span class="p">,</span>
				<span class="p">[]</span><span class="o">*</span><span class="nx">exprpb</span><span class="p">.</span><span class="nx">Type</span><span class="p">{</span><span class="nx">decls</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">,</span><span class="nx">decls</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">},</span>
				<span class="nx">decls</span><span class="p">.</span><span class="nx">Bool</span><span class="p">)),</span>
			<span class="p">),</span>
</code></pre></div><p>实现在<code>opt.programOptions</code>中完成</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">	<span class="nx">opt</span><span class="p">.</span><span class="nx">programOptions</span><span class="p">=</span> <span class="p">[]</span><span class="nx">cel</span><span class="p">.</span><span class="nx">ProgramOption</span><span class="p">{</span>
		<span class="nx">cel</span><span class="p">.</span><span class="nf">Functions</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="nx">functions</span><span class="p">.</span><span class="nx">Overload</span><span class="p">{</span>
				<span class="nx">Operator</span><span class="p">:</span>     <span class="s">&#34;bcontains&#34;</span><span class="p">,</span>
				<span class="nx">Binary</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lhs</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="p">,</span> <span class="nx">rhs</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="p">)</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">Val</span><span class="p">{</span>
					<span class="k">return</span> <span class="nx">types</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">lhs</span><span class="p">.(</span><span class="nx">types</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">),</span><span class="nx">rhs</span><span class="p">.(</span><span class="nx">types</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">)))</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">),</span>
	<span class="p">}</span>
</code></pre></div><p>测试一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ast</span><span class="p">,</span><span class="nx">iss</span><span class="o">:=</span><span class="nx">env</span><span class="p">.</span><span class="nf">Compile</span><span class="p">(</span><span class="s">`response.body.bcontains(b&#34;theoyu&#34;)`</span><span class="p">)</span>

<span class="nx">output</span><span class="p">:</span>
<span class="o">==</span><span class="p">=</span> <span class="nx">RUN</span>   <span class="nx">TestPoc</span>
    <span class="nx">cel_test</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span> <span class="kc">true</span>
<span class="o">---</span> <span class="nx">PASS</span><span class="p">:</span> <span class="nf">TestPoc</span> <span class="p">(</span><span class="mf">0.01</span><span class="nx">s</span><span class="p">)</span>
<span class="nx">PASS</span>
</code></pre></div>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-10-26 23:24 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc" class="show-toc">
			<div class="toc-title"></div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#key-concepts">Key concepts</a></li>
    <li><a href="#declare-the-variables">Declare the variables</a></li>
    <li><a href="#custom-functions">Custom Functions</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://theoyu.top/posts/concurrent-in-go/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>go并发的几个问题</span>
			</a>
			<a class="prev-post" href="https://theoyu.top/posts/course/whitehat-and-security/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>白帽子讲web安全</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://theoyu.top/">Theoyu</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://theoyu.top/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://theoyu.top/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js" integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin="anonymous"></script>
	

</body>

</html>
