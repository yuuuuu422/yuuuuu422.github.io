---
title: "æ¼«è°ˆè§£é‡Šå™¨"
date: 2021-09-19T22:24:32+08:00
toc: On
---

![image-20210901150504552](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210901224626.png)

## å‰è¨€

å¼€ä¸ªæ–°å‘ï¼Œæœ¬æ¥æ˜¯æ‰“ç®—å­¦å­¦ç¼–è¯‘å™¨çš„ï¼Œä½†æ˜¯å‘ç°åŸºç¡€å¤ªè–„å¼±äº†ï¼Œå°±å…ˆå­¦ä¹ è§£é‡Šå™¨ç›¸å…³å§ï¼Œåˆšå¥½å¤§åˆ›ä¹Ÿéœ€è¦è¿™ä¸€å—çš„çŸ¥è¯†ã€‚

ä¸»è¦å‚è€ƒä»¥ä¸‹ä¸¤æœ¬æ•™æ

- [ç¼–è¯‘å™¨è®¾è®¡](https://book.douban.com/subject/20436488/)
- [Writing An Interpreter In Go](https://interpreterbook.com/)

## æ¦‚è¿°

### ç¼–è¯‘å‹è¯­è¨€

æœ‰çš„ç¼–ç¨‹è¯­è¨€è¦æ±‚å¿…é¡»æå‰å°†æ‰€æœ‰æºä»£ç ä¸€æ¬¡æ€§è½¬æ¢æˆäºŒè¿›åˆ¶æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œæ¯”å¦‚Cã€c++ã€Golangç­‰ï¼Œè¿™ç§ç¼–ç¨‹è¯­è¨€ç§°ä¸ºç¼–è¯‘å‹è¯­è¨€ï¼Œä½¿ç”¨çš„è½¬æ¢å·¥å…·ç§°ä¸ºç¼–è¯‘å™¨ã€‚

### è§£é‡Šå‹è¯­è¨€

æœ‰çš„ç¼–ç¨‹è¯­è¨€å¯ä»¥ä¸€è¾¹æ‰§è¡Œä¸€è¾¹è½¬æ¢ï¼Œä¸ä¼šç”Ÿæˆå¯æ‰§è¡Œç¨‹åºï¼Œæ¯”å¦‚ JavaScriptã€PHPç­‰ã€‚è¿™ç§ç¼–ç¨‹è¯­è¨€ç§°ä¸ºè§£é‡Šå‹è¯­è¨€ï¼Œä½¿ç”¨çš„è½¬æ¢å·¥å…·ç§°ä¸ºè§£é‡Šå™¨ã€‚

### ç¼–è¯‘+è§£é‡Š

ä¸¥æ ¼æ„ä¹‰ä¸Špythonä¸ç®—æ˜¯å•çº¯çš„è§£é‡Šå‹è¯­è¨€ï¼Œå…¶è¿˜ä¼šç¼–è¯‘ä¸ºpycå­—èŠ‚ç ï¼Œç”±pvmè§£é‡Šæ‰§è¡Œè¿™ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œæ¯ä¸€æ¬¡è´Ÿè´£å°†ä¸€æ¡å­—èŠ‚ç æ–‡ä»¶è¯­å¥ç¿»è¯‘æˆcpuå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æœºå™¨ä»£ç ã€‚

javaä»æºä»£ç ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œç„¶ååœ¨JVMä¸Šè¿è¡Œå­—èŠ‚ç æ‰§è¡Œï¼ŒJVMæ˜¯ä¸€ç§å­—èŠ‚ç çš„è§£é‡Šå™¨ï¼ŒJVMçš„å®ç°åŒ…æ‹¬ä¸€ä¸ªè¿è¡Œæ—¶çš„ç¼–è¯‘å™¨ï¼Œç§°ä¸ºJIT(just-in-time)ç¼–è¯‘å™¨ï¼Œå…¶æœ€å¤§çš„ä¼˜åŠ¿åœ¨äº**å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡ŒåŠæ—¶ä¼˜åŒ–**ã€‚æ›´å¤šå…³äºJITçš„çŸ¥è¯†å¯å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://aboullaite.me/understanding-jit-compiler-just-in-time-compiler/).

![image-20210901173603017](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210901224636.png)

åœ¨çŸ¥ä¹çœ‹åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æé—®ï¼š

>æˆ‘ä¹‹å‰çœ‹çŸ¥ä¹ä¸Šæœ‰äººåˆ†æï¼Œç¼–è¯‘å‹è¯­è¨€èƒ½å¤Ÿç›´æ¥ç”ŸæˆäºŒè¿›åˆ¶ä»£ç ï¼ˆWindowsä¸‹å°±æ˜¯EXEæˆ–DLLå§ï¼‰ï¼Œè€Œè§£é‡Šå‹è¯­è¨€ä¸ä¼šç”ŸæˆäºŒè¿›åˆ¶ä»£ç ï¼Œæœ€å¤šé“äºŒè¿›åˆ¶ä»£ç çš„å‰ä¸€æ­¥ã€‚
>
>æˆ‘å¯¹è¿™ç§è§£é‡Šæœ‰äº›æ— æ³•ç†è§£ï¼Œæ„Ÿè§‰è¿™ä¼¼ä¹ä¸æ˜¯ä»–ä»¬çš„æœ¬è´¨å§ã€‚Pythonæ˜¯ä¸€ä¸ªè§£é‡Šæ€§è¯­è¨€ï¼Œä½†æˆ‘è®°å¾—Pythonå¯ä»¥ä¸‹è½½ä¸€ä¸ªåŒ…ï¼Œèƒ½å¤Ÿå°†Pythonç›´æ¥ç¼–è¯‘ä¸ºEXEå¯æ‰§è¡Œç¨‹åºï¼Œéš¾é“è¯´ï¼Œæˆ‘ä¸‹è½½äº†è¿™ä¸ªåŒ…ä¹‹åï¼ŒPythonå°±ä»è§£é‡Šå‹è¯­è¨€å˜ä¸ºç¼–è¯‘å‹è¯­è¨€äº†ä¸æˆï¼Ÿ
>
>æ˜¯è¿™ä¸ªæ¦‚å¿µåŒºåˆ†æœ¬èº«å°±æœ‰ä¸¥é‡çš„å…ˆå¤©ç¼ºé™·ï¼Œè¿˜æ˜¯æˆ‘çš„ç†è§£æœ¬èº«æœ‰é”™è¯¯ï¼Ÿ

å…¶ä¸­æ— è®ºå¯¹ä¸å¦ï¼Œæ¯”è¾ƒæˆ³ä¸­æˆ‘çš„å›ç­”ï¼š

>è¯­è¨€åªæ˜¯è§„å®šè¯­æ³•ï¼Œæœ€åç”¨è¿™è¯­è¨€å†™å‡ºæ¥çš„ä»£ç æ€ä¹ˆç¿»è¯‘æˆæœºå™¨ç ï¼Œæ€ä¹ˆè¿è¡Œï¼Œè¿˜éœ€è¦ä¸€ä¸ªå®ç°ã€‚è¿™ä¸ªå®ç°å¯ä»¥æ˜¯ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥æ˜¯è§£é‡Šå™¨ã€‚
>
>æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥åšä¸€ä¸ªpythonçš„ç¼–è¯‘å™¨æˆ–è€…Cè¯­è¨€çš„è§£é‡Šå™¨

## ç¼–è¯‘å™¨æ„æˆ

![image-20210902230038132](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210902230041.png)

ç°åœ¨å›½å†…å¤–å¤§å¤šæ•™æ(è™½ç„¶æˆ‘éƒ½æ²¡çœ‹è¿‡)åœ¨ç¼–è¯‘å™¨è¿™ä¸€å—æ˜¯å¤´é‡è„šè½»çš„ï¼Œæ¯”é‡å‰ç«¯>>åç«¯>ä¼˜åŒ–å™¨ï¼Œè™½ç„¶å¯¹äºç¼–è¯‘å™¨è¿™æ ·éå¸¸ä¸åˆç†ï¼Œä¸è¿‡ç«™åœ¨å­¦ä¹ é™æ€åˆ†æçš„æ–¹å‘ï¼Œæ›´å¤šçš„å…³æ³¨ç‚¹è¿˜æ˜¯æ”¾åœ¨å‰ç«¯ï¼Œå½“ç„¶ä¼˜åŒ–éƒ¨åˆ†ä¹Ÿä¸å¯å¿½è§†ï¼Œæ¯”å¦‚è¿™ä¸ªå€¼å¾—åå¤æ£æ‘©çš„[é—®ç­”](https://www.zhihu.com/question/27730062/answer/44638989)ã€‚

### å‰ç«¯

å‰ç«¯éƒ¨åˆ†ï¼Œå…¶å®ç°æœ‰å¾ˆå¤šå·¥å…·å·²ç»å¸®æˆ‘ä»¬å®ç°äº†

#### è¯æ³•åˆ†æå™¨

æºä»£ç åœ¨è®¡ç®—æœºã€çœ¼ä¸­ã€å…¶å®æ˜¯ä¸€å›¢ä¹±éº»ã€‚æ— æ³•è¢«ç†è§£çš„å­—ç¬¦ä¸²åœ¨è®¡ç®—å™¨çœ‹æ¥å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸ºäº†ç†è§£è¿™äº›å­—ç¬¦æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯**å°†å­—ç¬¦ä¸²åˆ†ç»„**ï¼Œè¿™èƒ½å¤Ÿé™ä½ç†è§£å­—ç¬¦ä¸²çš„æˆæœ¬ï¼Œç®€åŒ–æºä»£ç çš„åˆ†æè¿‡ç¨‹ã€‚æ‰€æœ‰çš„ç¼–è¯‘è¿‡ç¨‹å…¶å®éƒ½æ˜¯ä»è§£æä»£ç çš„æºæ–‡ä»¶å¼€å§‹çš„ï¼Œè¯æ³•åˆ†æçš„ä½œç”¨å°±æ˜¯è§£ææºä»£ç æ–‡ä»¶ï¼Œå®ƒå°†æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²åºåˆ—è½¬æ¢æˆ **Token** åºåˆ—ï¼Œæ–¹ä¾¿åé¢çš„å¤„ç†å’Œè§£æï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠæ‰§è¡Œè¯æ³•åˆ†æçš„ç¨‹åºç§°ä¸ºè¯æ³•è§£æå™¨ï¼ˆ**lexer**ï¼‰ã€‚

 å¯¹äºè¯æ³•åˆ†æå™¨è€Œè¨€ï¼Œæœ€ç¹æ‚çš„ä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬æŠŠè¿™é—¨è¯­è¨€å¯èƒ½ç”¨åˆ°çš„tokenå…¨éƒ¨æšä¸¾å‡ºæ¥

```golang
package token
const(
	// Identifiers + literals
	IDENT = "IDENT" // add, foobar, x, y, ...
	INT   = "INT"   // 1343456

	// Operators
	ASSIGN   = "="
	PLUS     = "+"
  
  // Delimiters
	COMMA     = ","
	SEMICOLON = ";"
	LPAREN = "("
  
  // Keywords
	FUNCTION = "FUNCTION"
	LET      = "LET"
	TRUE     = "TRUE"
  ......
)
```

æˆ‘ä»¬é‡‡ç”¨ç±»ä¼¼è§£é‡Šå™¨æ¨¡å¼çš„pythonï¼Œé€è¡Œè¯»å–æºæ–‡ä»¶ï¼Œè¿™é‡Œéœ€è¦ä»‹ç»ä¸¤ä¸ªå‡½æ•°

```golang
func (l *Lexer) readChar() {}
func (l *Lexer) peekChar() byte {}
```

`readChar`ç”¨äºè¯»å–å½“å‰ä½ç½®çš„å­—ç¬¦ï¼Œ`peekChar`ç”¨äº(çœ‹ä¸€çœ¼)ä¸‹ä¸ªä½ç½®çš„å­—ç¬¦ï¼Œå› ä¸ºæ¯”å¦‚å½“è¯»å–åˆ°`=`æ—¶ï¼Œæ— æ³•æ–­å®štokenæ˜¯èµ‹å€¼è¿˜æ˜¯ç­‰äºï¼Œéœ€è¦é€šè¿‡ä¸‹ä¸€ä¸ªå­—ç¬¦åˆ¤æ–­ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå˜é‡å‘¢ï¼Œæ¯”å¦‚`let x = 3`,å¯¹äºè¯æ³•åˆ†æå™¨è€Œè¨€`let`å’Œ`x` æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªmap

```golang
package token
var keywords = map[string]TokenType{
	"fn":     FUNCTION,
	"let":    LET,
	"true":   TRUE,
	"false":  FALSE,
	"if":     IF,
	"else":   ELSE,
	"return": RETURN,
}

func LookupIdent(ident string) TokenType {
	if tok, ok := keywords[ident]; ok {
		return tok
	}
	return IDENT
}
```

è¿™æ ·æ¯æ¬¡å½“æˆ‘ä»¬è¯»å®Œä¸€ä¸²å­—ç¬¦ä¸²ï¼Œå°±è¿›è¡Œ`LookupIdent`å¯»æ‰¾æ˜¯å¦å«æœ‰é”®å€¼ã€‚

æœ€ååå¤è°ƒç”¨ä¸€ä¸ª`NextToken()`å‡½æ•°ï¼Œå…¶å†…éƒ¨è°ƒç”¨`readChar()`ä»¥åŠtokenåˆ¤æ–­ï¼Œè¿™æ ·æœ€ç®€æ˜“çš„è¯æ³•åˆ†æå™¨å°±æš‚æ—¶å®Œæˆã€‚

```golang
		for tok := l.NextToken(); tok.Type != token.EOF; tok = l.NextToken() {
			fmt.Printf("%+v\n", tok)
		}
```

![image-20210921114710885](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210921114712.png)

#### è¯­æ³•åˆ†æå™¨

è¯­æ³•åˆ†æå™¨å°±æ ¹æ®æˆ‘ä»¬æ‰€å®šä¹‰çš„å½¢å¼æ–‡æ³•ï¼ˆ**Grammar**ï¼‰è¯†åˆ«å‡ºè¯æ³•åˆ†ææ‰€å¾—åˆ°tokençš„ç»“æ„ï¼Œä»è€Œæ„é€ å‡ºä¸€é¢—è¯­æ³•æ ‘(**AST** abstract syntax tree),ä»…ä»…å¾—åˆ°ASTæ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜å¾—å¯¹ASTè¿›è¡Œè¯­ä¹‰æ£€æŸ¥ï¼Œä¿è¯å…¶ç»“æ„åœ¨è¯­ä¹‰ä¸Šä¹Ÿæ˜¯è¯´å¾—é€šçš„ã€‚

>è¿™ä¸€å—çœŸæ˜¯çœ‹äº†å¥½ä¹…æ‰~~çœ‹æ˜ç™½~~,å…¶å®æ˜¯è‹±è¯­å¤ªæ‹‰å®äº†ï¼Œæ‹¿ç€æºç è°ƒè¯•åè€Œå¥½ç†è§£ä¸€äº›ã€‚

æ‹¿æœ€ç®€å•çš„`let`ä¸ºä¾‹ï¼Œ`let`è¡¨è¾¾å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š

```haskell
let x = 10; 
let y = 15;
let add = fn(a, b) { 
	return a + b;
};
......
let <identifier> = <expression>;
```

åœ¨æˆ‘ä»¬åˆ›å»ºç»“ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç™½`statements`å’Œ`expressions`çš„åŒºåˆ«ï¼Œè¿™ä¸¤è€…æœ¬è´¨çš„åŒºåˆ«åœ¨äºæ˜¯å¦ä¼šäº§ç”Ÿå€¼ï¼Œæ¯”å¦‚å£°æ˜ `let x =5`å¹¶ä¸ä¼šäº§ç”Ÿå€¼ï¼Œä½†æ˜¯`5`ä¼š.`return 5`ä¸ä¼šäº§ç”Ÿå€¼è€Œ`add(5+5)`ä¼šã€‚(æ€ä¹ˆæ„Ÿè§‰è¶Šè¯´è¶Šç³Šæ¶‚)ç®€å•æ¥è¯´`statements`å°±æ˜¯ä¸€å¥å®Œæ•´çš„è¯­å¥ï¼Œè€Œ`expressions`åƒæ˜¯c++ä¸­çš„å³å€¼ï¼Œéœ€è¦ä¸€ä¸ªå˜é‡å»æ¥æ”¶ã€‚ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸¤ç§ç±»å‹çš„ç»“ç‚¹ï¼š

```go
package ast
// The base Node interface
type Node interface {
	TokenLiteral() string
	String() string
}

// All statement nodes implement this
type Statement interface {
	Node
	statementNode()
}

// All expression nodes implement this
type Expression interface {
	Node
	expressionNode()
}
```

æœ‰äº†æ¥å£ä»¥åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¯­æ³•ğŸŒ²åˆ›å»ºä¸€ä¸ªæ ¹ç»“ç‚¹ï¼Œ

```golang
type Program struct {
	Statements []Statement
}

func (p *Program) TokenLiteral() string {
	if len(p.Statements) > 0 {
		return p.Statements[0].TokenLiteral()
	} else {
		return ""
	}
}
```

å¦‚æœæƒ³æŠŠç®€å•çš„letè¯­å¥åŒ–ä¸ºä¸€é¢—AST,å·®ä¸å¤šæ˜¯ä¸‹é¢è¿™æ ·ï¼š

![image-20210921165137173](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210921165139.png)

é‚£`LetStatement`çš„é›å½¢å·®ä¸å¤šæœ‰äº†ï¼š

```golang
type LetStatement struct {
   Token token.Token // the token.LET token
   Name  *Identifier
   Value Expression
}
```

é‚£ä¹ˆå½“æˆ‘ä»¬è¯»åˆ°ä¸€ä¸ªtokenä¸ºletï¼Œå°±å¯ä»¥è¿›å…¥å¯¹letçš„è§£æå‡½æ•°

```go
func (p *Parser) parseLetStatement() *ast.LetStatement {	stmt := &ast.LetStatement{Token: p.curToken}	if !p.expectPeek(token.IDENT) {		return nil	}	stmt.Name = &ast.Identifier{Token: p.curToken, Value: p.curToken.Literal}	if !p.expectPeek(token.ASSIGN) {		return nil	}	p.nextToken()	stmt.Value = p.parseExpression(LOWEST)	if p.peekTokenIs(token.SEMICOLON) {		p.nextToken()	}	return stmt}
```

æ¯”å¦‚å¯¹äº`let x =5`, å¯ä»¥å¾—åˆ°

![image-20210921170349884](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210921170351.png)

ä¸Šé¢çš„ä¾‹å­çš„expressionåªæ˜¯5ï¼Œä½†æ¯”å¦‚`let x = 3+2*5`è¿™ç§çš„è¡¨è¾¾å¼æ›´ä¸ºå¤æ‚ï¼Œä¹¦ä¸­ç”¨åˆ°çš„æ–¹æ³•å«**Top Down Operator Precedence**,æˆ–è€…**Pratt Parsin**ã€‚è¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°ï¼Œè¯¦ç»†å¯å‚è€ƒ[åŸæ–‡ç« ](https://tdop.github.io/).

è¿™æ ·å¯¹äºå¤æ‚è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è§£æï¼š

![image-20210921171857411](https://cdn.jsdelivr.net/gh/yuuuuu422/Myimages/img/2021/09/20210921171859.png)

### ä¼˜åŒ–å™¨

ä»£ç éƒ¨åˆ†å¹¶æ²¡æœ‰ç€é‡ä¼˜åŒ–ï¼Œä¹¦ä¸Šç†è®ºéƒ¨åˆ†å®å±æŠ½è±¡ğŸ˜­ï¼Œä½†è¿™å…¶å®åˆæ˜¯é™æ€åˆ†æä¸­æœ€é‡è¦çš„ç¯èŠ‚ï¼Œå®¹æˆ‘å­¦ä¹ å­¦ä¹ ......

### åç«¯



